define(function () {
    __zovyeApi = {
        url: undefined,
        resultFN:{},
    }

    __zovyeApi.setApiUrl = function (url) {
        __zovyeApi.url = url;
    }

    __zovyeApi.op = function (op, act) {
        __zovyeApi[op] = act;
    }
    
    __zovyeApi.default = function(op, params, cb, loading = false) {
        if (__zovyeApi.resultFN[op]) {
            __zovyeApi.showResult(Object.assign({ op }, params), __zovyeApi.url, __zovyeApi.resultFN[op].loading, typeof cb === 'function' ? cb : __zovyeApi.resultFN[op].fn);
        } else {
            __zovyeApi.showResult(Object.assign({ op }, params), __zovyeApi.url, loading, cb);
        }   
    }

    __zovyeApi.result = function (op, act, loading = false) {
        __zovyeApi.resultFN[op] = {fn: act, loading: loading};
    }

    __zovyeApi.showResult = function (params, url, loading, cb) {
        loading && util.loading();
        $.getJSON(url || __zovyeApi.url, params).done(function (res) {
            loading && util.loaded();
            if (res) {
                const nextFN = function() {
                    if (res.status) {
                        if (res.data) {
                            if (res.data.content) {
                                const dlg = util.dialog(res.data.title || '', res.data.content);
                                dlg.modal('show');                                
                            } else if (res.data.redirect) {
                                window.location.href = res.data.redirect;
                            }
                        }
                    }
                    if (res.message && res.type) {
                        util.message(res.message, '', res.type);
                    }
                    if (res.data && res.data.msg) {
                        util.message(res.data.msg, '', res.status ? 'success' : 'error');
                    }
                }
                if (typeof cb === 'function') {
                    if (cb(res, nextFN)) {
                        return;
                    }
                }
                nextFN();
            }
        }).fail(function () {
            loading && util.loaded();
        })
    }

    __zovyeApi.enableOp = function(selector = 'body', opName = 'op') {
        $(selector).on('click', '[data-' + opName + ']', function (e) {
            const op = $(this).data(opName);
            if (op) {
                if (__zovyeApi[op]) {
                    __zovyeApi[op]($(this), function(params, cb, loading = false) {
                        __zovyeApi.default(op, params, cb, loading);
                    });
                } else {
                    __zovyeApi.default(op);
                }
            }
            e.preventDefault();
        })
    }

    __zovyeApi.enableInputMask = function(selector = 'form', maskClass= "inputMask") {
        const maskE = $('<div title="点击查看">×××已隐藏×××</div>');
        $(selector + " ." + maskClass).each(function(){
            const self = $(this);
            if(self.val() || self.text()) {
                const x = maskE.clone();
                x.attr('class', self.attr('class')).click(function(){
                    x.hide();
                    self.show().focus();
                })
                x.insertBefore(self);
                self.removeClass(maskClass).hide();
                if (self.is('input')) {
                    self.blur(function(){
                    x.show();
                    self.hide();
                    })
                } else {
                    self.click(function(){
                        x.show();
                        self.hide();
                    })
                }
            }
        })
    }

    __zovyeApi.enableCopy = function(urlName = "url") {
        $('[data-' + urlName + ']').each(function(){
            util.clip(this, $(this).data(urlName));
        })
    }

    return __zovyeApi;
})
