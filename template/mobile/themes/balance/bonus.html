<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
	<title>任务大厅</title>
	<link rel="stylesheet" href="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.css">
	<link href="https://cdn.staticfile.org/video.js/4.1.0/video-js.min.css" rel="stylesheet">
	<style type="text/css">
		html,
		body {
			position: relative;
			width: 100vw;
		}

		body {
			background-color: #f8f8f8;
			font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
			font-size: 14px;
			color: #101010;
			margin: 0;
			padding: 0;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}

		#app {
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding-bottom: calc(54px + constant(safe-area-inset-bottom));
			padding-bottom: calc(54px + env(safe-area-inset-bottom));
		}

		[v-cloak] {
			display: none !important;
		}

		.tabbar {
			width: 100%;
			height: 44px;
			background-color: white;
			position: fixed;
			bottom: 0;
			left: 0;
			display: flex;
			flex-direction: row;
			padding-bottom: constant(safe-area-inset-bottom);
			padding-bottom: env(safe-area-inset-bottom);
			box-shadow: 0 -1px 5px #eee;
			z-index: 99;
		}

		.tab-item {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.tab-item img {
			width: 20px;
			height: 20px;
		}

		.tab-item span {
			font-size: 12px;
			margin-top: 2px;
			color: #9d9d9d;
		}

		.tab-item .selected {
			color: #FA639B;
		}

		#adv-swiper-container {
			width: 100%;
			--swiper-theme-color: #FA639B;
		}

		.swiper-img {
			width: 100%;
		}

		.menu-item {
			width: 100%;
			padding: 20px 0;
			display: flex;
			flex-direction: row;
			align-items: center;
			background-color: white;
		}

		.menu-item:not(:first-child) {
			margin-top: 5px;
		}

		.icon {
			width: 35px;
			height: 35px;
			margin-left: 20px;
		}

		.info {
			flex: 1;
			display: flex;
			flex-direction: column;
			margin: 0 20px;
		}

		.title {
			font-size: 16px;
			font-weight: bold;
		}

		.desc {
			color: #aaa;
			font-size: 13px;
			margin-top: 2px;
		}

		.arrow {
			width: 15px;
			height: 15px;
			margin-right: 20px;
		}

		.sign-in {
			min-width: 30px;
			margin-right: 20px;
			height: 28px;
			padding: 0 15px;
			text-align: center;
			line-height: 28px;
			background-color: #FA639B;
			color: white;
			border-radius: 14px;
		}

		.sign-in:not(.done):active {
			opacity: 0.7;
		}

		.done {
			background-color: lightgray;
		}

		.clickable:active {
			opacity: 0.7;
		}

		.mask {
			width: 100vw;
			height: 100vh;
			background-color: rgba(0, 0, 0, 0.5);
			position: fixed;
			top: 0;
			left: 0;
			z-index: 999;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.success-view {
			width: 200px;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 20px;
			border-radius: 10px;
			background-color: white;
			animation: showSuccess .7s;
			color: #747474;
			font-size: 16px;
		}

		.success-text {
			font-weight: bold;
			color: #434343;
			margin-top: 5px;
		}

		.success-value {
			color: #F7804C;
		}

		.success-view img {
			width: 150px;
			height: 150px;
		}

		.done-btn {
			width: 100%;
			height: 36px;
			border-radius: 18px;
			color: white;
			font-weight: 500;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			background-image: linear-gradient(to right, #FBAE62, #F7804C);
		}

		@keyframes showSuccess {
			from {
				opacity: 0;
				transform: scale(0);
			}

			to {
				opacity: 1;
				transform: scale(1);
			}
		}

		.toast {
			padding: 5px 20px;
			background-color: rgba(0, 0, 0, 0.7);
			color: white;
			position: fixed;
			bottom: 10vh;
			border-radius: 5px;
			z-index: 1000;
			animation: showToast .7s;
		}

		@keyframes showToast {
			from {
				opacity: 0;
				transform: translateY(5vh);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.rise {
			background-color: black;
			animation: riseUp .5s;
		}

		@keyframes riseUp {
			from {
				transform: translateY(100vh);
			}

			to {
				transform: translateY(0);
			}
		}

		.countdown-view {
			padding: 0 10px;
			height: 22px;
			border-radius: 12px;
			border: 1px solid white;
			position: absolute;
			top: 20px;
			right: 20px;
			display: flex;
			flex-direction: row;
			align-items: center;
			color: white;
			font-size: 12px;
		}

		.divider {
			width: 1px;
			height: 12px;
			margin: 0 10px;
			background-color: white;
		}

		.countdown-view img {
			width: 12px;
			height: 12px;
		}

		.follow-card {
			width: 100%;
			height: 300px;
			display: flex;
			flex-direction: column;
			align-items: center;
			background-color: white;
			border-top-left-radius: 20px;
			border-top-right-radius: 20px;
			position: absolute;
			left: 0;
			bottom: 0;
			animation: followUp .5s;
		}

		@keyframes followUp {
			from {
				transform: translateY(300px);
			}

			to {
				transform: translateY(0);
			}
		}

		.follow-card .header {
			width: 100%;
			height: 80px;
			display: flex;
			flex-direction: row;
			align-items: center;
		}

		.follow-card .header .avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			margin-left: 20px;
			box-shadow: 0 0 5px #ccc;
		}

		.follow-card .header span {
			flex: 1;
			margin: 0 10px;
			color: #333;
    		text-shadow: 1px 1px 2px #ccc;
		}

		.qrcode-container {
			width: 150px;
			height: 150px;
			position: relative;
		}

		.wxapp-cover {
			width: 100%;
			height: 100%;
			position: absolute;
			left: 0;
			top: 0;
			background-color: rgba(0, 0, 0, 0.5);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.follow-card .qrcode {
			width: 150px;
			height: 150px;
		}

		.follow-card .desc {
			font-size: 13px;
			color: #747474;
			margin-top: 10px;
		}

		.follow-card .close-icon {
			width: 20px;
			height: 20px;
			position: absolute;
			top: 20px;
			right: 20px;
		}
	</style>
</head>

<body ontouchstart>
	<div id="app" v-cloak>
		<div class="swiper" id="adv-swiper-container" v-if="slides.length > 0">
			<div class="swiper-wrapper">
				<div class="swiper-slide" v-for="(item,index) in slides" @click="slideClick(item)">
					<img class="swiper-img" :src="item.image" />
				</div>
			</div>
			<div class="swiper-pagination"></div>
		</div>
		<div class="menu-item">
			<img class="icon" src="{MODULE_URL}static/m/balance/img/sign_in_icon.svg">
			<div class="info">
				<span class="title">每日签到</span>
				<span class="desc">每日签到领积分</span>
			</div>
			<div :class="['sign-in', done ? 'done' : '']" v-if="done !== null" @click="signInClick">{{done ? '已签到' :
				'签到'}}</div>
		</div>
		<div class="menu-item clickable" style="position: relative;">
			<img class="icon" src="{MODULE_URL}static/m/balance/img/clock_icon.svg">
			<div class="info">
				<span class="title">日常任务</span>
				<span class="desc">打开小程序完成任务</span>
			</div>
			<img class="arrow" src="{MODULE_URL}static/m/balance/img/arrow.svg">
			<div style="width: 100%;height: 100%;position: absolute;left: 0;top: 0;opacity: 0;overflow: hidden;" v-if="userInfo">
				<wx-open-launch-weapp
					id="launch-btn"
					:username="wxapp_username"
					:path="'pages/bigcms/user/index/index?openId=' + userInfo.openid"
					>
					<script type="text/wxtag-template">
						<style>.btn { width: 1000px; height: 82px; }</style>
						<button class="btn">打开小程序</button>
					</script>
				</wx-open-launch-weapp>
			</div>
		</div>
		<div class="menu-item clickable" @click="videoClick">
			<img class="icon" src="{MODULE_URL}static/m/balance/img/video_icon.svg">
			<div class="info">
				<span class="title">看视频</span>
				<span class="desc">看完视频获取积分</span>
			</div>
			<img class="arrow" src="{MODULE_URL}static/m/balance/img/arrow.svg">
		</div>
		<div class="menu-item clickable" @click="followClick">
			<img class="icon" src="{MODULE_URL}static/m/balance/img/follow_icon.svg">
			<div class="info">
				<span class="title">关注公众号</span>
				<span class="desc">关注公众号领取积分</span>
			</div>
			<img class="arrow" src="{MODULE_URL}static/m/balance/img/arrow.svg">
		</div>
		<div class="menu-item clickable" @click="wxappClick">
			<img class="icon" src="{MODULE_URL}static/m/balance/img/wxapp_icon.svg">
			<div class="info">
				<span class="title">关注小程序</span>
				<span class="desc">关注小程序获取积分</span>
			</div>
			<img class="arrow" src="{MODULE_URL}static/m/balance/img/arrow.svg">
		</div>
		<div class="tabbar">
			<div class="tab-item">
				<img src="{MODULE_URL}static/m/balance/img/mission_icon_se.svg">
				<span class="selected">任务大厅</span>
			</div>
			<div class="tab-item" @click="jumpToProfile">
				<img src="{MODULE_URL}static/m/balance/img/profile_icon.svg">
				<span>个人中心</span>
			</div>
		</div>
		<div class="mask rise" v-if="video.visible">
			<video id="player" class="video-js" width="100%" height="100%" x5-video-player-type="h5-page"
				playsinline></video>
			<div class="countdown-view">
				<template v-if="video.countdown !== 0">
					<span>{{video.countdown}}秒</span>
					<div class="divider"></div>
				</template>
				<span @click="closeVideo">关闭</span>
			</div>
		</div>
		<div class="mask" v-if="follow.visible" @click="follow.visible = false">
			<div class="follow-card" @click.stop>
				<div class="header">
					<img class="avatar" :src="follow.data.img">
					<span>{{follow.data.title}}</span>
				</div>
				<img class="qrcode" :src="follow.data.qrcode">
				<span class="desc" v-html="follow.data.descr"></span>
				<img class="close-icon" src="{MODULE_URL}static/m/balance/img/close_black.svg" @click="follow.visible = false">
			</div>
		</div>
		<div class="mask" v-if="wxapp.visible" @click="wxapp.visible = false">
			<div class="follow-card" @click.stop>
				<div class="header">
					<img class="avatar" :src="wxapp.data.img">
					<span>{{wxapp.data.title}}</span>
				</div>
				<div class="qrcode-container">
					<img class="qrcode" :src="wxapp.data.img">
					<div class="wxapp-cover">
						<wx-open-launch-weapp :id="wxapp.data.uid" :username="wxapp.data.username" :path="wxapp.data.path">
							<script type="text/wxtag-template">
								<style>.play-icon { width: 40px }</style>
								<img class="play-icon" src="{MODULE_URL}static/m/balance/img/click.svg">
							</script>
						</wx-open-launch-weapp>
					</div>
				</div>
				<span class="desc" v-html="wxapp.data.descr"></span>
				<img class="close-icon" src="{MODULE_URL}static/m/balance/img/close_black.svg" @click="wxapp.visible = false">
			</div>
		</div>
		<div class="mask" v-if="success.visible">
			<div class="success-view">
				<span>{{success.title}}</span>
				<span class="success-text">获得 <span class="success-value">{{success.data.bonus}}个</span> 积分</span>
				<img src="{MODULE_URL}static/m/balance/img/sign_in_success.svg">
				<div class="done-btn clickable" @click="success.visible = false">完成</div>
			</div>
		</div>
		<div class="toast" v-if="toast.visible">{{toast.text}}</div>
	</div>
	{$tpl['js']['code']}
	{php \zovye\url(true, JS_VUE_URL);}
	<script src="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.js"> </script>
	<script src="https://cdn.staticfile.org/video.js/4.1.0/video.js"></script>
	<script type="text/javascript">
		new Vue({
			el: '#app',
			data: {
				isHidden: null,
				slides: [],
				done: null,
				success: {
					title: '',
					data: null,
					visible: false
				},
				video: {
					visible: false,
					data: null,
					player: null,
					countdown: 0,
					interval: null
				},
				follow: {
					data: null,
					visible: false
				},
				wxapp: {
					data: null,
					visible: false,
					timeout: null
				},
				toast: {
					text: '',
					visible: false,
					timeout: null
				},
				userInfo: null,
				wxapp_username: zovye_fn.wxapp_username,
				wechatState: null
			},
			created() {
				this.done = !zovye_fn.signIn;
				this.getUserInfo();
				this.getSlideList();
				this.visibilitychange();
				this.judgeWechat();
			},
			methods: {
				visibilitychange() {
					document.addEventListener('visibilitychange', () => {
						this.isHidden = document.hidden;
						if (this.video.player) {
							if (this.isHidden) {
								this.video.player.pause();
								clearInterval(this.video.interval);
							} else {
								this.video.player.play();
								this.countdown();
							}
						}
					});
				},
				judgeWechat(){
					let wechat = navigator.userAgent.match(/MicroMessenger\/([\d\.]+)/i);
					let judgewechat = wechat[1].split('.');
					if(judgewechat[0] > 7 || judgewechat[0] == 7 && (judgewechat[1] > 0 || judgewechat[1] == 0 && judgewechat[2] >= 12)) {
						this.wechatState = true;
					} else {
						this.wechatState = false;
					}
				},
				getUserInfo() {
					zovye_fn.getUserInfo().then(res => {
						if (res.status) {
							this.userInfo = res.data;
						}
					})
				},
				getSlideList() {
					zovye_fn.getAdvs(4, 10, (data) => {
						let array = [];
						data.forEach(e => {
							e.data.images.forEach(img => {
								let obj = {
									image: img,
									url: e.data.link,
									id: e.id
								};
								array.push(obj);
							})
						});
						this.slides = array;
						this.$nextTick(() => {
							new Swiper('#adv-swiper-container', {
								autoplay: {
									delay: 3000,
									disableOnInteraction: false
								},
								pagination: {
									el: '.swiper-pagination'
								}
							});
						});
					});
				},
				slideClick(item) {
					if (item.url) {
						window.location.href = item.url;
					}
				},
				signInClick() {
					if (!this.done) {
						zovye_fn.signIn().then(res => {
							if (res.status) {
								this.done = true;
								this.success.data = res.data;
								this.success.title = '签到成功';
								this.success.visible = true;
							} else {
								alert(res.data.msg);
							}
						})
					}
				},
				videoClick() {
					zovye_fn.getAccounts(10, 1).then(res => {
						if (res.status) {
							const data = res.data || [];
							if (data.length > 0) {
								this.video.data = data[0];
								this.video.visible = true;
								this.$nextTick(() => {
									this.playVideo();
								});
							} else {
								this.showToast('暂无视频任务');
							}
						} else {
							alert(res.data.msg);
						}
					})
				},
				playVideo() {
					const that = this;
					that.video.countdown = that.video.data.duration;
					const options = {
						autoplay: true,
						sources: [{
							type: "video/mp4",
							src: that.video.data.media
						}]
					};
					that.video.player = videojs('player', options, function onPlayerReady() {
						this.play();
						that.countdown();
					});
				},
				countdown() {
					this.playRequest();
					this.video.interval = setInterval(() => {
						this.video.countdown--;
						if (this.video.countdown === 0) {
							clearInterval(this.video.interval);
						}
					}, 1000);
				},
				playRequest() {
					this.video.data && zovye_fn.play(this.video.data.uid, this.video.data.duration - this.video.countdown, res => {
						if (res) {
							if (res.status) {
								if (res.data.bonus) {
									this.success.data = res.data;
									this.success.title = '观看完成';
									this.success.visible = true;
								} else {
									setTimeout(() => {
										if (!this.isHidden) {
											this.playRequest();
										}
									}, 1000);
								}
							} else {
								alert(res.data.msg || '播放出错！');
							}
						}
					});
				},
				closeVideo() {
					this.video.player.dispose();
					this.video.player = null;
					this.video.visible = false;
					this.video.data = null;
					this.video.countdown = 0;
					if (this.video.interval) {
						clearInterval(this.video.interval);
						this.video.interval = null;
					}
				},
				followClick() {
					zovye_fn.getAccounts(0, 1).then(res => {
						console.log(res)
						if (res.status) {
							const data = res.data || [];
							if (data.length > 0) {
								this.follow.data = data[0];
								this.follow.visible = true;
							} else {
								this.showToast('暂无关注任务');
							}
						} else {
							alert(res.data.msg);
						}
					})
				},
				wxappClick() {
					zovye_fn.getAccounts(30, 1).then(res => {
						console.log(res)
						if (res.status) {
							const data = res.data || [];
							if (data.length > 0) {
								this.wxapp.data = data[0];
								this.wxapp.visible = true;
								this.$nextTick(() => {
									this.addListener(this.wxapp.data)
								});
								if (this.wechatState === false) {
									alert('当前微信版本过低，建议升级微信后再试！');
								}
							} else {
								this.showToast('暂无小程序任务');
							}
						} else {
							alert(res.data.msg);
						}
					})
				},
				addListener(data) {
					var btn = document.getElementById(data.uid);
					btn.addEventListener('launch', (e) => {
						if(this.wxapp.timeout) {
							clearTimeout(this.wxapp.timeout);
							this.wxapp.timeout = null;
						}
						this.wxapp.timeout = setTimeout(() => {
							if(document.hidden) {
								this.wxapp.visible = false;
								zovye_fn.getBonus(data.uid).then(res => {
									if (res.status) {
										this.success.data = res.data;
										this.success.title = '关注成功';
										this.success.visible = true;
									} else {
										alert(res.data.msg);
									}
								})
							}
						}, data.delay * 1000);
					});
				},
				showToast(text) {
					if (this.toast.visible) {
						clearTimeout(this.toast.timeout);
						this.toast.timeout = null;
					}
					this.toast.text = text;
					this.toast.visible = true;
					this.toast.timeout = setTimeout(() => {
						this.toast.visible = false;
					}, 2000);
				},
				jumpToProfile() {
					zovye_fn.redirectToUserPage();
				}
			}
		})
	</script>
</body>

</html>