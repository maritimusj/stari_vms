<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
	<title>高佣任务</title>
	<link rel="stylesheet" href="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.css">
	<style type="text/css">
		html,
		body {
			position: relative;
			width: 100vw;
		}

		body {
			background-color: #f8f8f8;
			font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
			font-size: 14px;
			color: #101010;
			margin: 0;
			padding: 0;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}

		#app {
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding-bottom: calc(10px + env(safe-area-inset-bottom));
		}

		[v-cloak] {
			display: none !important;
		}

		#adv-swiper-container {
			width: 100%;
			--swiper-theme-color: #FF4B34;
		}

		.swiper-img {
			width: calc(100% - 20px);
			margin: 10px 10px 0;
			border-radius: 10px;
		}

		.list-view {
			width: calc(100% - 40px);
			padding: 10px 10px 0;
			margin-top: 10px;
			display: flex;
			flex-direction: column;
			background-color: white;
			border-radius: 10px;
		}

		.list-view .title {
			font-weight: bold;
			font-size: 16px;
		}

		.row {
			width: 100%;
			padding: 15px 0;
			display: flex;
			flex-direction: row;
			align-items: center;
		}

		.row .icon {
			width: 45px;
			height: 45px;
			border-radius: 5px;
		}

		.info {
			flex: 1;
			display: flex;
			flex-direction: column;
			margin: 0 10px;
		}

		.title-row {
			width: 100%;
			display: flex;
			flex-direction: row;
			align-items: center;
		}

		.title-row .title {
			font-size: 14px;
			font-weight: 500;
		}

		.title-row .coin {
			width: 14px;
			height: 14px;
			margin-left: 10px;
		}

		.title-row .bonus {
			font-weight: 500;
			color: #FF4B34;
		}

		.info .desc {
			color: #aaa;
			font-size: 12px;
			margin-top: 2px;
		}

		.btn {
			height: 28px;
			padding: 0 12px;
			text-align: center;
			line-height: 28px;
			background-image: linear-gradient(to right, #FF6D42, #FF4B34);
			color: white;
			font-weight: 500;
			border-radius: 14px;
		}

		.clickable:active {
			opacity: 0.7;
		}

		.row .status {
			font-size: 13px;
			color: #aaa;
			font-weight: normal;
			margin-right: 5px;
		}

		.row .arrow {
			width: 15px;
			height: 15px;
		}

		.no-data-view {
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-top: 15vh;
		}

		.no-data-img {
			width: 80px;
			height: 80px;
		}

		.no-data-desc {
			margin-top: 10px;
			color: #bbb;
		}

		.detail-view {
			width: 100vw;
			height: 100vh;
			position: fixed;
			left: 0;
			top: 0;
			background-color: #F5F5F5;
			z-index: 99;
			display: flex;
			flex-direction: column;
			align-items: center;
			color: #666;
		}

		.detail-view .main {
			width: 100%;
			flex: 1;
			overflow-y: auto;
		}

		.form {
			width: calc(100% - 60px);
			padding: 0 20px 20px;
			background-color: white;
			border-radius: 10px;
			margin: 10px;
			box-shadow: 0 0 5px #eee;
			display: flex;
			flex-direction: column;
			position: relative;
		}

		.form .close {
			width: 20px;
			height: 20px;
			position: absolute;
			top: 10px;
			right: 10px;
		}

		.form .section {
			width: 100%;
			display: flex;
			flex-direction: column;
		}

		.form .section .header {
			width: 100%;
			display: flex;
			flex-direction: row;
			align-items: center;
			margin-top: 20px;
			color: #101010;
		}

		.form .section .line {
			width: 3px;
			height: 16px;
			border-radius: 2px;
			background-color: orangered;
		}

		.form .section .title {
			margin-left: 10px;
			font-size: 16px;
			font-weight: bold;
			flex: 1;
		}

		.form .section .content {
			width: 100%;
			display: flex;
			flex-direction: column;
		}

		.form .section .desc {
			margin-top: 10px;
		}

		.img-row {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
		}

		.img-row img {
			width: calc((100% - 10px) / 2);
			height: 60vw;
			margin-top: 10px;
			border-radius: 5px;
			box-shadow: 0 0 5px #ccc;
		}

		.img-row img:nth-child(2n + 2) {
			margin-left: 10px;
		}

		.qrcode-view {
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-top: 15px;
		}

		.qrcode {
			width: 200px;
			height: 200px;
			box-shadow: 0 0 5px #ccc;
		}

		.url {
			padding: 15px;
			background-color: #f8f8f8;
			color: #aaa;
			margin-top: 10px;
			border-radius: 5px;
			word-break: break-all;
		}

		.btn-row {
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
			margin-top: 10px;
		}

		.btn-row .btn {
			flex: 1;
			height: 36px;
			line-height: 36px;
			border-radius: 18px;
		}

		.detail-view .footer {
			width: calc(100% - 40px);
			height: 54px;
			padding: 0 20px env(safe-area-inset-bottom);
			background-color: white;
			display: flex;
			flex-direction: row;
			align-items: center;
			box-shadow: 0 -1px 5px #eee;
			z-index: 100;
		}

		.detail-view .footer .coin {
			width: 15px;
			height: 15px;
			margin-left: 10px;
		}

		.detail-view .footer .bonus {
			flex: 1;
			font-weight: 500;
			color: #FF4B34;
		}

		.detail-view .footer .btn {
			padding: 0 25px;
			height: 38px;
			line-height: 38px;
			border-radius: 19px;
		}

		.detail-view .footer .status {
			font-weight: 500;
		}

		.success {
			color: #04BE02 !important;
		}

		.fail {
			color: #FF4B34 !important;
		}

		.mask {
			width: 100vw;
			height: 100vh;
			background-color: rgba(0, 0, 0, 0.5);
			position: fixed;
			left: 0;
			top: 0;
			z-index: 999;
		}

		.mask-center {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.loading-view {
			width: 120px;
			height: 120px;
			background-color: rgba(255, 255, 255, 0.9);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			border-radius: 10px;
			box-shadow: 0 0 5px lightgray;
		}

		.loading-view img {
			width: 50px;
			height: 50px;
			animation: loading 1s infinite;
		}

		.loading-view span {
			font-size: 13px;
			margin-top: 10px;
		}

		@keyframes loading {
			from {
				transform: rotate(0deg);
			}
			to {
				transform: rotate(360deg);
			}
		}

		.toast {
			padding: 5px 20px;
			background-color: rgba(0, 0, 0, 0.7);
			color: white;
			position: fixed;
			bottom: 10vh;
			border-radius: 5px;
			z-index: 1000;
			animation: showToast .7s;
		}

		@keyframes showToast {
			from {
				opacity: 0;
				transform: translateY(5vh);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.card {
			width: 100%;
			background-color: white;
			border-top-left-radius: 10px;
			border-top-right-radius: 10px;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding-bottom: env(safe-area-inset-bottom);
			animation: rise .5s;
			color: #666;
		}
		
		@keyframes rise{
			from{
				transform: translateY(80vh);
			}
			to{
				transform: translateY(0);
			}
		}
		
		.card-header {
			width: 100%;
			height: 44px;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
			color: #101010;
			font-weight: 500;
			position: relative;
		}
		
		.card-header img {
			width: 20px;
			height: 20px;
			position: absolute;
			right: 20px;
		}
		
		.card-content {
			width: 100%;
			max-height: 70vh;
			overflow-y: auto;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
		}
		
		.upload-view {
			width: calc((100% - 50px) / 2);
			height: 65vw;
			background-color: #eee;
			margin-top: 10px;
			margin-left: 20px;
			border-radius: 5px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			position: relative;
		}
		
		.upload-view:nth-child(2n + 2) {
			margin-left: 10px;
		}

		.file-input {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			left: 0;
			opacity: 0;
		}
		
		.upload-view .plus {
			width: 25px;
			height: 25px;
			opacity: 0.5;
		}
		
		.upload-view span {
			font-size: 13px;
			margin-top: 5px;
		}

		.upload-view .img {
			width: 100%;
			height: 100%;
			border-radius: 5px;
		}

		.upload-view .delete {
			width: 22px;
			height: 22px;
			position: absolute;
			top: -8px;
			right: -8px;
			background-color: white;
			border-radius: 50%;
		}
		
		.card-footer {
			width: 100%;
			height: 68px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}
		
		.card-footer .btn {
			padding: 0;
			width: calc(100% - 40px);
			height: 38px;
			line-height: 38px;
			border-radius: 19px;
		}
	</style>
</head>

<body ontouchstart>
	<div id="app" v-cloak>
		<div class="swiper" id="adv-swiper-container">
			<div class="swiper-wrapper">
				<div class="swiper-slide" v-for="item in slides" @click="slideClick(item)">
					<img class="swiper-img" :src="item.image" />
				</div>
			</div>
			<div class="swiper-pagination"></div>
		</div>
		<div class="list-view" v-if="participatedList && participatedList.length > 0">
			<span class="title">进行中</span>
			<div class="row clickable" v-for="item in participatedList" @click="detailClick(item)">
				<img class="icon" :src="item.img ? item.img : '{MODULE_URL}static/m/balance/img/mission.svg'">
				<div class="info">
					<div class="title-row">
						<span class="title">{{item.title}}</span>
						<img class="coin" src="{MODULE_URL}static/m/balance/img/coin.svg">
						<span class="bonus">+{{item.balance}}</span>
					</div>
					<span class="desc">{{item.descr}}</span>
				</div>
				<span class="status" v-if="item.status === 0">审核中</span>
				<span class="status fail" v-else-if="item.status === 1">未通过</span>
				<img class="arrow" src="{MODULE_URL}static/m/balance/img/arrow.svg">
			</div>
		</div>
		<div class="list-view" v-if="newList && newList.length > 0">
			<span class="title">任务列表</span>
			<div class="row" v-for="item in newList" @click="detailClick(item)">
				<img class="icon" :src="item.img ? item.img : '{MODULE_URL}static/m/balance/img/mission.svg'">
				<div class="info">
					<div class="title-row">
						<span class="title">{{item.title}}</span>
						<img class="coin" src="{MODULE_URL}static/m/balance/img/coin.svg">
						<span class="bonus">+{{item.balance}}</span>
					</div>
					<span class="desc">{{item.descr}}</span>
				</div>
				<div class="btn clickable">去完成</div>
			</div>
		</div>
		<div class="list-view"  v-if="questionnaireList && questionnaireList.length > 0">
			<span class="title">问卷调查</span>
			<div class="row" v-for="item in questionnaireList" @click="questionnaireClick(item)">
				<img class="icon" :src="item.img ? item.img : '{MODULE_URL}static/m/balance/img/mission.svg'">
				<div class="info">
					<div class="title-row">
						<span class="title">{{item.title}}</span>
						<img class="coin" src="{MODULE_URL}static/m/balance/img/coin.svg">
						<span class="bonus">+{{item.balance}}</span>
					</div>
					<span class="desc">{{item.descr}}</span>
				</div>
				<div class="btn clickable">去完成</div>
			</div>
		</div>
		<div class="no-data-view" v-if="newList && participatedList && questionnaireList && newList.length === 0 && participatedList.length === 0 && questionnaireList.length === 0">
			<img class="no-data-img" src="{MODULE_URL}static/m/balance/img/no_data_icon.png">
			<span class="no-data-desc">暂无数据</span>
		</div>
		<div class="detail-view" v-if="detail.visible">
			<div class="main">
				<div class="form">
					<img class="close clickable" src="{MODULE_URL}static/m/balance/img/close_black.svg" @click="detail.visible = false">
					<div class="section" v-for="item in detail.data.detail">
						<div class="header">
							<div class="line"></div>
							<span class="title">{{item.title}}</span>
						</div>
						<div class="content">
							<span class="desc" v-if="item.text">{{item.text}}</span>
							<div v-if="item.desc" v-html="item.desc"></div>
							<div class="img-row" v-if="item.img">
								<img :src="img" v-for="img in item.img">
							</div>
							<div class="qrcode-view" v-if="item.qrcode">
								<img class="qrcode" :src="item.qrcode">
							</div>
							<template v-if="item.url">
								<div class="url">{{item.url}}</div>
								<div class="btn-row">
									<div class="btn clickable" @click="openUrl(item.url)">打开链接</div>
									<div class="btn clickable" style="margin-left: 10px;" v-clipboard:copy="item.url" v-clipboard:success="onCopy">复制链接</div>
								</div>
							</template>
						</div>
					</div>
				</div>
			</div>
			<div class="footer">
				<span>任务奖励</span>
				<img class="coin" src="{MODULE_URL}static/m/balance/img/coin.svg">
				<span class="bonus">+{{detail.data.balance}}</span>
				<div class="btn clickable" v-if="detail.data.status === undefined" @click="upload.visible = true">立即提交</div>
				<span class="status" v-else-if="detail.data.status === 0">等待审核</span>
				<!-- <span class="status success" v-else-if="detail.result === 2">任务成功</span> -->
				<template v-else-if="detail.data.status === 1">
					<span class="status fail">任务失败</span>
					<span class="btn clickable" style="margin-left: 10px;" @click="upload.visible = true">重新提交</span>
				</template>
			</div>
		</div>
		<div class="mask mask-center" style="justify-content: flex-end;" v-if="upload.visible" @click="upload.visible = false">
			<div class="card" @click.stop>
				<div class="card-header">
					<span>上传截图</span>
					<img class="clickable" src="{MODULE_URL}static/m/balance/img/close_black.svg" @click="upload.visible = false" >
				</div>
				<div class="card-content">
					<div class="upload-view clickable" v-for="(img, index) in upload.imgs" >
						<img class="img" :src="img">
						<img class="delete" src="{MODULE_URL}static/m/balance/img/delete_fill.svg" @click="deleteFile(index)">
					</div>
					<div class="upload-view clickable" v-if="upload.files.length < upload.max">
						<img class="plus" src="{MODULE_URL}static/m/balance/img/plus.svg">
						<span>点击添加截图</span>
						<input class="file-input" type="file" accept="image/*" multiple="multiple"
						@change="chooseImg($event)">
					</div>
				</div>
				<div class="card-footer">
					<div class="btn clickable" @click="uploadClick">上传</div>
				</div>
			</div>
		</div>
		<div class="toast" v-if="toast.visible">{{toast.text}}</div>
		<div class="mask mask-center" style="background-color: rgba(0, 0, 0, 0);" v-if="loading">
			<div class="loading-view">
				<img src="{MODULE_URL}static/m/balance/img/loading.svg">
				<span>请稍等...</span>
			</div>
		</div>
		<div class="mask mask-center" style="background-color: rgba(0, 0, 0, 0);" v-if="success.visible">
			<div class="loading-view">
				<img src="{MODULE_URL}static/m/balance/img/success.svg" style="animation: none;">
				<span>{{success.text}}</span>
			</div>
		</div>
	</div>
	{$tpl['js']['code']}
	{php \zovye\url(true, JS_VUE_URL);}
	<script src="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.js"> </script>
	<script src="https://cdn.staticfile.org/vue-clipboard2/0.3.1/vue-clipboard.min.js"></script>
	<script type="text/javascript">
		new Vue({
			el: '#app',
			data: {
				slides: [],
				userInfo: null,
				newList: null,
				participatedList: null,
				questionnaireList: null,
				detail: {
					visible: false,
					data: null
				},
				toast: {
					visible: false,
					text: '',
					timeout: null
				},
				loading: false,
				upload: {
					visible: false,
					files: [],
					imgs: [],
					max: 4,
					data: []
				},
				success: {
					visible: false,
					text: ''
				}
			},
			created() {
				this.getUserInfo();
				this.getSlideList();
				this.getTask();
				this.getAccounts();
			},
			methods: {
				getUserInfo() {
					zovye_fn.getUserInfo().then(res => {
						if (res.status) {
							this.userInfo = res.data;
						}
					})
				},
				getSlideList() {
					zovye_fn.getAdvs(4, 10, (data) => {
						let array = [];
						data.forEach(e => {
							e.data.images.forEach(img => {
								let obj = {
									image: img,
									url: e.data.link,
									id: e.id
								};
								array.push(obj);
							})
						});
						this.slides = array;
						this.$nextTick(() => {
							new Swiper('#adv-swiper-container', {
								autoplay: {
									delay: 3000,
									disableOnInteraction: false
								},
								pagination: {
									el: '.swiper-pagination'
								}
							});
						});
					});
				},
				slideClick(item) {
					if (item.url) {
						window.location.href = item.url;
					}
				},
				getTask() {
					zovye_fn.getTask().then(res => {
						if (res.status) {
							this.newList = res.data.new || [];
							this.participatedList = res.data.participated || [];
						}
					})
				},
				getAccounts() {
					zovye_fn.getAccounts().then(res => {
						console.log(res)
						if (res.status) {
							this.questionnaireList = res.data || [];
						}
					})
				},
				detailClick(item) {
					this.loading = true;
					zovye_fn.getDetail(item.uid).then(res => {
						this.loading = false;
						if (res.status) {
							this.detail.data = res.data;
							this.detail.visible = true;
							this.upload.files = [];
							this.upload.imgs = [];
						} else {
							alert(res.data.msg);
						}
					})
				},
				questionnaireClick(item) {
					if (item.url) {
						this.openUrl(item.url);
					}
				},
				openUrl(url) {
					window.location.href = url;
				},
				onCopy() {
					this.showToast('复制成功');
				},
				showToast(text) {
					if (this.toast.visible) {
						clearTimeout(this.toast.timeout);
						this.toast.timeout = null;
					}
					this.toast.text = text;
					this.toast.visible = true;
					this.toast.timeout = setTimeout(() => {
						this.toast.visible = false;
					}, 2000);
				},
				chooseImg(event) {
					const that = this;
					const targetFiles = event.target.files;
					let files = [];
					for (let i = 0; i < targetFiles.length; i++) {
						files.push(targetFiles[i]);
					}
					if (files.length > that.upload.max - that.upload.files.length) {
						files = files.slice(0, that.upload.max - that.upload.files.length);
						this.showToast('最多上传' + that.upload.max + '张图片');
					}
					files.forEach(file => {
						that.upload.files.push(file);
						if (file.type.indexOf("image") === 0) {
							let reader = new FileReader();
							reader.readAsDataURL(file);
							reader.onload = function (e) {
								let newUrl = this.result;
								that.upload.imgs.push(newUrl);
							};
						}
					});
				},
				deleteFile(index) {
					this.upload.files.splice(index, 1);
					this.upload.imgs.splice(index, 1);
				},
				uploadClick() {
					if (this.upload.files.length === 0) {
						this.showToast('请选择需要上传的截图');
						return;
					}
					this.loading = true;
					this.upload.data = [];
					this.uploadFile(0)
				},
				uploadFile(i) {
					const file = this.upload.files[i];
					zovye_fn.upload(file).then(res => {
						this.upload.data.push(res);
						i++;
						if (i < this.upload.files.length) {
							this.uploadFile(i);
						} else {
							this.submitData();
						}
					}).catch((error) => {
						this.loading = false;
						this.showToast('上传失败，请重试！')
					});
				},
				submitData() {
					zovye_fn.submit(this.detail.data.uid, {images: this.upload.data}, res => {
						this.loading = false;
						if (res.status) {
							this.success.text = res.data.msg;
							this.success.visible = true;
							setTimeout(() => {
								window.location.reload();
							}, 2000);
						} else {
							this.showToast(res.data.msg);
						}
					})
				}
			}
		})
	</script>
</body>

</html>