<!doctype html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8" />
	<title>{$tpl['site']['title']}</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<!-- Link Swiper's CSS -->
	{php \zovye\url(true, CSS_MUI_URL);}
	<style type="text/css">
		html,
		body {
			position: relative;
			width: 100%;
			height: 100%;
		}

		body {
			background: #fff;
			font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
			font-size: 14px;
			color: #000;
			margin: 0;
			padding: 0;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}

		.main {
			width: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.pic {
			width: 100%;
		}
		
		.waiting-icon {
			width: 100px;
			height: 100px;
			margin-top: 10vh;
		}

		.countdown {
			font-size: 20px;
			color: #333;
			margin-top: 20px;
			font-weight: 500;
		}

		.mui-toast-container {
			bottom: 25%;
		}

		.mui-toast-container.mui-active {
			opacity: 0.8;
		}

		.mui-toast-message {
			font-size: 1.2em;
			padding: 15px 30px;
		}
		
		.btn {
			width: 100%;
			height: 55px;
			position: absolute;
			bottom: 0;
			background-color: #000;
			color: #fff;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
			font-size: 17px;
			font-weight: bolder;
			box-shadow: 0px -5px 20px #fff;
			letter-spacing: 1px;
		}
		
		.btn:active {
			background-color: #333;
		}
	</style>
</head>

<body ontouchstart>
	<div id="waiting" class="main">
		<img class="waiting-icon" src="{MODULE_URL}static/img/flow_waiting.png" />
		<div class="countdown"></div>
	</div>
	<div id="success" class="main" style="display: none;">
		<img class="pic" src="{MODULE_URL}static/img/flow_success.png" />
	</div>
	<div id="error" class="main" style="display: none;">
		<img class="pic" src="{MODULE_URL}static/img/flow_fail.png" />
	</div>
	<div class="btn" style="display: none;">继续购买</div>
	{php echo register_jssdk(false);}
	<script type="text/javascript ">
		wx.ready(function(){
			wx.hideAllNonBaseMenuItem();
		})
	</script>
	<!-- Swiper JS -->
	{php \zovye\url(true, JS_MUI_URL);}
	<script type="text/javascript">
		mui.init()
		var waiting = document.querySelector("#waiting");
		var success = document.querySelector("#success");
		var error = document.querySelector("#error");
		var btn = document.querySelector(".btn");
		btn.addEventListener('click',function(){
			mui.toast('请关闭页面重新扫码设备二维码');
		});

		var delay = parseInt("{$tpl['timeout']}"); //设定跳转的时间
		var intervalid = setInterval("tick()", 1000); //启动1秒定时 

		var fail_redirect_url = "{$tpl['redirect']['fail']}";
		var sucess_redirect_url = "{$tpl['redirect']['success']}";

		getResult();
		function getResult() {
			mui.getJSON("{$url}", function (res) {
				if (res && res.data['msg']) {
					mui.toast(res.data['msg']);
				}
				if (res.status) {
					if (res.data['code'] == 200) {
						stoptick('success');
					} else if (res.data['code'] == 100) {
						if (delay > 0) {
							setTimeout(getResult, 1000);
						}
					} else {
						stoptick('error');
					}
				} else {
					stoptick('error');
				}
			});
		}

		function stoptick(result) {
			clearInterval(intervalid);
			if (result == 'success') {
				success.style.display = "flex";
				waiting.style.display = "none";
				error.style.display = "none";
			} else if (result == 'error') {

				success.style.display = "none";
				waiting.style.display = "none";
				error.style.display = "flex";
			}
			btn.style.display = "flex";
		}

		function tick() {
			if (delay == 0) {
				stoptick('error');
			}
			document.querySelector(".countdown").innerHTML = "出货中：" + delay + "s"; // 显示倒计时 
			delay--; // 计数器递减 
		}

	</script>
</body>

</html>