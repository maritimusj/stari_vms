<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <title>{$tpl['site']['title']}</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.css">
    <link href="https://cdn.staticfile.org/video.js/4.1.0/video-js.min.css" rel="stylesheet">
    <style>
        html,
        body {
            position: relative;
            width: 100%;
        }

        body {
            background-color: #f4f4f4;
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 15px !important;
            color: #101010;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        #app {
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: calc(15px + constant(safe-area-inset-bottom));
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }


        [v-cloak] {
            display: none !important;
        }

        .header {
            width: 100%;
            height: 44px;
            background-color: white;
            display: flex;
            flex-direction: row;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            box-shadow: 0 1px 5px #eee;
            z-index: 99;
        }

        .imei {
            margin: 0 10px;
            font-weight: 500;
            flex: 1;
        }

        .header img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .wechat-view {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: fixed;
            right: 5px;
            bottom: 25vh;
            background-color: #04BE02;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 5px white;
            animation: shine 1.2s infinite;
            z-index: 99;
        }

        .wechat-view img {
            width: 25px;
            height: 25px;
        }

        @keyframes shine {

            0%,
            100% {
                opacity: 1;
            }

            25%,
            75% {
                transform: translateY(-5px);
            }

            50% {
                opacity: 0.7;
                transform: translateY(10px);
            }
        }

        .clickable:active {
            opacity: 0.7;
        }

        .main {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 44px;
        }

        .marquee-container {
            width: 100%;
            height: 30px;
            line-height: 30px;
            position: relative;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .marquee-text {
            color: white;
            min-width: 100%;
            position: absolute;
            left: 0;
            animation: marqueeAnimation 10s linear infinite;
            white-space: nowrap;
        }

        @keyframes marqueeAnimation {
            from {
                transform: translate(100%, 0);
            }

            to {
                transform: translate(-100%, 0);
            }
        }

        #adv-swiper-container {
            width: 100vw;
            margin-top: 50px;
            --swiper-theme-color: #F07057;
        }

        .swiper-img {
            width: calc(100% - 30px);
            border-radius: 10px;
            margin: 0 15px;
            box-shadow: 0 3px 5px #ccc;
        }

        .swiper-pagination {
            margin-bottom: 15px;
        }

        .scroll-view {
            width: 100%;
        }

        .group-view {
            width: 100%;
            margin-top: 10px;
            background-color: white;
            overflow-x: auto;
            white-space: nowrap;
        }

        .group-view::-webkit-scrollbar {
            display: none;
        }

        .group-view span {
            display: inline-block;
            padding: 14px 14px 11px;
        }

        .group-view span:first-child {
            color: #F07057;
            border-bottom: 3px solid #F07057;
            font-weight: bold;
        }

        .package-item {
            width: calc(100vw - 50px);
            background-color: #fff;
            margin-top: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
        }

        .package-row {
            width: 100%;
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            margin-top: 5px;
        }

        .package-row-item {
            width: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #9d9d9d;
        }

        .package-row-item:not(:first-child) {
            margin-left: 5px;
        }

        .package-row-item .pic {
            width: 75px;
            height: 75px;
            border-radius: 10px;
        }

        .line {
            width: 100%;
            height: 1px;
            background-color: #eee;
            margin-top: 5px;
        }

        .package-footer {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-top: 10px;
        }

        .package-footer .price {
            flex: 1;
            color: #F07057;
            font-weight: 500;
            font-size: 18px;
        }

        .goods-item {
            width: calc(100% - 50px);
            padding: 10px;
            background-color: white;
            margin-top: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }

        .goods-item .row {
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .goods-item .pic {
            width: 75px;
            height: 75px;
            border-radius: 10px;
        }

        .goods-item .name {
            font-weight: bold;
            flex: 1;
            margin: 0 15px;
            font-size: 16px;
        }

        .circle-btn {
            width: 14px;
            height: 14px;
            background-color: #eee;
            border-radius: 50%;
            padding: 3px;
        }

        .circle-btn:active {
            background-color: #ccc;
        }

        .circle-btn-disabled {
            opacity: 0.3;
        }

        .goods-item .price {
            flex: 1;
            color: #F07057;
            font-weight: 500;
            font-size: 18px;
        }

        .choose-btn {
            padding: 0 30px;
            height: 36px;
            background-image: linear-gradient(to right, #eebd89, #f9957f);
            color: white;
            text-align: center;
            line-height: 36px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 500;
        }

        .free-btn {
            width: calc(100% - 30px);
            padding: 25px 0;
            background-image: linear-gradient(to right, #ff9569, #e92758);
            border-radius: 10px;
            margin-top: 15px;
            color: white;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .free-btn svg {
            margin-left: -30px;
        }

        .free-btn span {
            margin-left: 10px;
            font-size: 18px;
            font-weight: bolder;
        }

        .click-icon {
            width: 25px;
            height: 25px;
            position: absolute;
            right: calc(50% - 90px);
            bottom: calc(50% - 30px);
            animation: click 2s infinite;
        }

        @keyframes click {
            0% {
                opacity: 0.5;
                bottom: 0;
            }
            50% {
                opacity: 1;
                bottom: calc(50% - 30px);
            }
            75% {
                bottom: calc(50% - 32px);
                opacity: 0.5;
            }
            100% {
                bottom: calc(50% - 30px);
            }
        }

        .mask {
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 99;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .account-view {
            width: 230px;
            padding: 10px;
            border-radius: 10px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .account-view .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: absolute;
            top: -30px;
            border: 5px solid;
            background-color: white;
        }

        .account-view .title {
            margin-top: 35px;
            font-weight: bold;
            color: white;
        }

        .account-view .container {
            width: 200px;
            height: 200px;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .account-view .container .weapp-cover {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .account-view .desc {
            font-size: 12px;
            color: white;
        }

        .change {
            margin-top: 15px;
            color: white;
            text-decoration: underline;
        }

        .none-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 0;
        }

        .none-view span {
            margin-top: 20px;
            color: #666;
            text-shadow: 2px 2px 5px #ccc;
        }

        .sales-view {
            width: calc(100% - 50px);
            padding: 10px;
            background-color: white;
            margin-top: 15px;
            border-radius: 10px;
        }

        .sales-view .title {
            font-size: 16px;
            font-weight: bold;
            color: #F07057;
        }

        .sales-view .list {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .sale-item {
            width: calc((100% - 20px) / 3);
            margin-top: 10px;
            display: flex;
            flex-direction: column;
        }

        .sale-item:not(:nth-child(3n + 1)) {
            margin-left: 10px;
        }

        .sale-item .pic {
            width: 100%;
            height: calc((100vw - 20px - 50px) / 3);
        }

        .sale-item .name {
            margin-top: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sale-item .discount-price {
            color: #F07057;
        }

        .sale-item .price {
            color: #9d9d9d;
            text-decoration: line-through;
        }

        .mask .close {
            width: 25px;
            height: 25px;
            margin-top: 50px;
        }

        .toast {
            padding: 5px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            position: fixed;
            bottom: 10vh;
            border-radius: 5px;
            z-index: 100;
            animation: showToast .7s;
        }

        @keyframes showToast {
            from {
                opacity: 0;
                transform: translateY(5vh);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .countdown {
            width: 150px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            color: white;
            position: absolute;
            top: 20px;
            z-index: 100;
        }

        .loading-view {
            width: 120px;
            height: 120px;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            box-shadow: 0 0 5px lightgray;
        }

        .loading-view img {
            width: 50px;
            height: 50px;
            animation: loading 1s infinite;
        }

        .loading-view span {
            font-size: 13px;
            margin-top: 10px;
        }

        @keyframes loading {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wechat-qrcode {
            padding: 20px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: bold;
            border-radius: 5px;
        }

        .wechat-qrcode img {
            width: 200px;
            height: 200px;
            margin-bottom: 10px;
        }

        .alert-view {
            width: 240px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
            animation: showAlert .7s;
            font-size: 16px;
        }

        .alert-view .title {
            font-size: 18px;
            font-weight: bold;
        }

        .alert-view .text {
            margin: 20px 0;
            color: #555;
            text-align: center;
        }

        .alert-view .confirm {
            width: 150px;
            height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #F07057;
            color: white;
            border-radius: 20px;
        }

        .alert-view .confirm:active {
            opacity: 0.7;
        }

        @keyframes showAlert {
            from {
                opacity: 0;
                transform: scale(0);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .sex-view {
            width: 100%;
            padding: 20px 0;
            background-color: white;
            position: absolute;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
        }

        .sex-item {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sex-item img {
            width: 80px;
            height: 80px;
        }

        .sex-item span {
            margin-top: 10px;
        }
    </style>
</head>

<body ontouchstart>
    <div id="app" v-cloak>
        <div class="header">
            <span class="imei">No.{{imei}}</span>
            <img class="clickable" src="{MODULE_URL}static/m/balance/img/profile_icon.svg" @click="orderClick">
            <img class="clickable" src="{MODULE_URL}static/m/balance/img/feedback_icon.svg" @click="feedbackClick">
        </div>
        <div class="wechat-view" v-if="wechat.qrcode" @click="wechat.visible = true">
            <img src="{MODULE_URL}static/m/balance/img/wechat_icon.svg">
        </div>
        <div class="main">
            {if !empty($tpl['site']['warning'])}
            <div class="marquee-container">
                <span class="marquee-text">{$tpl['site']['warning']}</span>
            </div>
            {/if}
            <div class="free-btn clickable" v-if="account.list.length > 0" @click="freeClick">
                <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25271" width="64"
                    height="64">
                    <path
                        d="M894.86848 358.31808a119.71072 119.71072 0 0 0-16.07168-59.9552 120.40192 120.40192 0 0 0-40.88832-42.1888l-274.94912-158.65856a119.808 119.808 0 0 0-58.01472-14.95552c-22.11328 0-42.74688 6.10304-60.54912 16.55296l-0.06656-0.08192L176.64 253.5936c-18.42688 10.38336-34.176 25.50272-45.0816 44.32384a119.168 119.168 0 0 0-16.06144 60.22144H115.2v312.44288h0.09728a119.18336 119.18336 0 0 0 15.99488 59.33056c2.45248 4.2496 5.16608 8.35072 8.12544 12.27776 1.152 1.53088 2.49856 2.88768 3.71712 4.36224 1.90976 2.29888 3.76832 4.6592 5.85728 6.83008 1.46432 1.5104 3.12832 2.86208 4.67456 4.32128 2.03776 1.89952 3.99872 3.85024 6.15424 5.60128 1.71008 1.3824 3.584 2.57024 5.38112 3.87072 2.0224 1.4592 3.97824 3.04128 6.10304 4.38784l0.78848 0.4608c0.0512 0.0512 0.1024 0.08192 0.16384 0.128h0.03072l0.65536 0.39936c1.4848 0.88064 2.97984 1.76128 4.49024 2.59072l267.66336 154.5216 0.08192-0.14848a119.38816 119.38816 0 0 0 59.88864 16.18944h0.08192c21.07904 0 40.88832-5.50912 58.112-15.08864l0.02048 0.04096 272.43008-157.10208a120.13568 120.13568 0 0 0 42.81856-43.20768 118.80448 118.80448 0 0 0 16.11776-59.76064h0.2304v-312.2688h-0.01024zM396.88192 305.80224c44.27264 0 84.71552 20.96128 119.13728 58.99776 34.44224-38.0416 74.88-58.99776 119.1424-58.99776 46.79168 0 86.99904 18.78016 114.2784 56.00768 24.71936 33.82784 29.6192 81.62304 15.51872 130.67264-14.82752-1.30048-34.24256-1.87904-54.81984 0.21504 21.43232-40.25856 15.55968-75.22304-2.46784-100.77696-15.16032-21.51936-42.27072-34.33984-72.50944-34.33984-43.97056 0-92.72832 34.5856-119.1424 92.0576-25.71776-56.69888-73.56416-92.0576-119.13728-92.0576-30.208 0-65.55136 11.22304-82.432 54.03136-19.03616-10.0864-38.272-21.76512-42.28608-31.37536 22.84032-47.65696 73.2672-74.43456 124.71808-74.43456z m305.23904 279.00928c-21.78048 22.02112-41.49248 36.62848-66.66752 54.2976-35.82976 25.1392-78.79168 51.50208-119.42912 111.83104-25.1904-38.5792-55.00416-64.83968-82.8416-85.73952-56.23808-42.19904-134.75328-58.50112-175.24736-120.28928-26.63936-40.71936-38.13888-139.37152-10.9056-178.26816-18.06848 55.808 107.27424 78.73024 136.06912 118.51264-0.39424-11.38688 2.50368-24.61696 2.02752-36.0192 17.48992 26.17856 41.77408 53.8368 62.80192 80.56832 29.15328 37.12 66.06336 105.37984 76.16 169.53856 40.88832-53.20192 45.85984-132.41856 115.38944-169.33888-6.71232 8.75008-6.71232 17.8688-7.45984 29.10208 23.0912-57.10336 124.9024-46.0288 146.65216-42.9056-41.29792 3.87072-51.51232 43.40736-76.54912 68.7104z"
                        p-id="25272" fill="#ffffff"></path>
                </svg>
                <span>关注广告<br>免费领取</span>
                <img class="click-icon" src="{MODULE_URL}static/m/balance/img/click.svg">
            </div>
            <div class="scroll-view" v-if="groups.length > 0">
                <div class="group-view">
                    <span>售货机商品</span>
                    <span v-for="group in groups" @click="groupClick(group)">{{group.title}}</span>
                </div>
            </div>
            <div class="package-item" v-for="(item, index) in packages">
                <span>{{item.title}}</span>
                <div class="package-row">
                    <div class="package-row-item" v-for="(goods, i) in item.list">
                        <img class="pic" :src="goods.image">
                        <span
                            style="width: 100%;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;text-align: center;margin-top: 5px;">{{goods.name}}</span>
                        <span>x{{goods.num}}</span>
                    </div>
                </div>
                <div class="line"></div>
                <div class="package-footer">
                    <span>价格：</span>
                    <span class="price">¥{{item.price}}</span>
                    <div v-if="item.isOk" class="choose-btn clickable" @click="buyPackageClick(item)">购买</div>
                    <span v-else style="color: #9d9d9d;">暂时无法购买</span>
                </div>
            </div>
            <div class="goods-item" v-for="(item, index) in pay" :key="index">
                <div class="row">
                    <img class="pic" :src="item.img">
                    <span class="name">{{item.name}}</span>
                    <img :class="['circle-btn', item.count === 1 ? 'circle-btn-disabled' : '' ]"
                        style="margin-right: 15px;" src="{MODULE_URL}static/m/balance/img/minus.svg"
                        @click="minusClick(item, 'goods')">
                    <span style="font-weight: 500;">{{item.count}}</span>
                    <img :class="['circle-btn', (item.count === item.num || item.count === max || item.num === 0) ? 'circle-btn-disabled' : '' ]"
                        style="margin-left: 15px;" src="{MODULE_URL}static/m/balance/img/plus.svg"
                        @click="plusClick(item, 'goods')">
                </div>
                <div class="line" style="margin: 10px 0;"></div>
                <div class="row">
                    <span>价格：</span>
                    <span class="price">¥ {{(parseFloat(item.price * item.count) / 100).toFixed(2)}}</span>
                    <div v-if="item.num > 0" class="choose-btn clickable" @click="buyClick(item)">购买</div>
                    <span v-else style="color: #9d9d9d;">已售罄</span>
                </div>
            </div>
            <div class="swiper" id="adv-swiper-container" v-if="slides.length > 0">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" v-for="(item, index) in slides" :key="index" @click="slideClick(item)">
                        <img class="swiper-img" :src="item.image" />
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>
            <div class="none-view"
                v-if="!loading && account.list.length === 0 && pay.length === 0 && packages.length === 0">
                <svg t="1647324768311" class="icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="10822" width="48" height="48">
                    <path
                        d="M0 512c0 282.816 229.184 512 512 512 282.784 0 512-229.184 512-512 0-282.784-229.216-512-512-512C229.184 0 0 229.216 0 512z"
                        fill="#FFC60A" p-id="10823"></path>
                    <path
                        d="M496 672h32a32 32 0 0 1 32 32v32a32 32 0 0 1-32 32h-32a32 32 0 0 1-32-32v-32a32 32 0 0 1 32-32z m0-416h32a32 32 0 0 1 32 32v256a32 32 0 0 1-32 32h-32a32 32 0 0 1-32-32V288a32 32 0 0 1 32-32z"
                        fill="#5C3A00" p-id="10824"></path>
                </svg>
                <span>暂无免费次数可用，或商品已售罄！</span>
            </div>
            <div class="sales-view" v-if="sales.length > 0">
                <div class="title">我要秒杀</div>
                <div class="list">
                    <div class="sale-item clickable" v-for="(item, index) in sales" :key="index"
                        @click="saleClick(item)">
                        <img class="pic" :src="item.data.image">
                        <span class="name">{{item.title}}</span>
                        <span class="discount-price">{{item.data.discount_price}}</span>
                        <span class="price">{{item.data.price}}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mask" v-if="wechat.visible">
            <div class="wechat-qrcode">
                <img :src="wechat.qrcode">
                <span>{{wechat.desc}}</span>
            </div>
            <img class="close clickable" src="{MODULE_URL}static/m/balance/img/close.svg"
                @click="wechat.visible = false">
        </div>
        <div class="mask" v-if="account.visible">
            <div class="account-view"
                :style="{'background-image': 'linear-gradient(to bottom right, ' + account.data.clr + '77,' + account.data.clr + ')'}">
                <img class="avatar" :style="{'border-color': account.data.clr + '77'}" :src="account.data.img">
                <span class="title">{{account.data.title}}</span>
                <img class="container" :src="account.data.qrcode" v-if="account.data.qrcode">
                <div class="container media" style="background-color: black;" v-else-if="account.data.media"
                    @click="playClick">
                    <img src="{MODULE_URL}static/m/balance/img/play_icon.svg">
                </div>
                <div class="container" v-else-if="account.data.username">
                    <img :src="account.data.img" style="width: 100%;height: 100%;object-fit: cover;">
                    <div class="weapp-cover">
                        <wx-open-launch-weapp :id="account.data.uid" :username="account.data.username"
                            :path="account.data.path">
                            <script type="text/wxtag-template">
                                    <style>.play-icon { width: 40px }</style>
                                    <img class="play-icon" src="{MODULE_URL}static/m/balance/img/click.svg">
                                </script>
                        </wx-open-launch-weapp>
                    </div>
                </div>
                <span class="desc" v-html="account.data.descr"></span>
            </div>
            <span v-if="account.list.length > 1" class="change clickable" @click="changeClick">不出货？点击换一个</span>
            <img class="close clickable" src="{MODULE_URL}static/m/balance/img/close.svg"
                @click="account.visible = false">
        </div>
        <div class="mask" style="background-color: #000000;" v-show="video.visible">
            <div class="countdown">出货倒计时：{{video.countdown}}秒</div>
            <video id="player" class="video-js" width="100%" height="100%" x5-video-player-type="h5-page" playsinline>
            </video>
        </div>
        <div class="mask" v-if="passwd.visible">
            <div class="alert-view">
                <span class="title">提示</span>
                <span class="text">{{passwd.data.text}}</span>
                <div class="confirm" v-clipboard:copy="passwd.data.code" v-clipboard:success="onCopy"
                    v-clipboard:error="onError">确定</div>
            </div>
        </div>
        <div class="mask" v-if="retry.visible">
            <div class="alert-view">
                <span class="title">提示</span>
                <span class="text">{{retry.text}}</span>
                <div class="confirm" @click="retryClick">确定</div>
            </div>
        </div>
        <div class="mask" v-if="saveUserProfile">
            <div class="sex-view">
                <span style="font-size: 18px;">完善信息获取更多服务</span>
                <span style="margin-top: 10px;color: orchid;">您的性别</span>
                <div style="width: 100%;display: flex;margin-top: 20px;">
                    <div class="sex-item clickable" @click="sexClick(1)">
                        <img src="{MODULE_URL}static/m/balance/img/male_avatar.png">
                        <span style="color: lightblue;">男</span>
                    </div>
                    <div class="sex-item clickable" @click="sexClick(2)">
                        <img src="{MODULE_URL}static/m/balance/img/female_avatar.png">
                        <span style="color: pink;">女</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="toast" v-if="toast.visible">{{toast.text}}</div>
        <div class="mask" v-if="loading">
            <div class="loading-view">
                <img src="{MODULE_URL}static/m/balance/img/loading.svg">
                <span>请稍等...</span>
            </div>
        </div>
    </div>
    {$tpl['js']['code']}
    {php \zovye\url(true, JS_VUE_URL);}
    <script src="https://cdn.staticfile.org/Swiper/7.1.0/swiper-bundle.min.js"> </script>
    <script src="https://cdn.staticfile.org/video.js/4.1.0/video.js"></script>
    <script src="https://cdn.staticfile.org/vue-clipboard2/0.3.1/vue-clipboard.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                loading: false,
                imei: "{$tpl['device']['imei']}",
                max: parseInt('{php echo \zovye\App::orderMaxGoodsNum();}'),
                wechat: {
                    qrcode: '',
                    desc: '',
                    visible: false
                },
                slides: [],
                groups: [],
                account: {
                    list: [],
                    index: 0,
                    data: null,
                    visible: false,
                    timeout: null
                },
                pay: [],
                packages: [],
                sales: [],
                toast: {
                    text: '',
                    visible: false,
                    timeout: null
                },
                video: {
                    data: null,
                    visible: false,
                    countdown: 0,
                    interval: null,
                    player: null
                },
                isHidden: null,
                wechatState: null,
                saveUserProfile: false,
                passwd: {
                    visible: false,
                    data: null
                },
                retry: {
                    visible: false,
                    text: ''
                }
            },
            created () {
                this.imei = this.imei.substring(this.imei.length - 6);

                if (typeof zovye_fn.retryOrder === 'function') {
                    this.retryOrder();
                }

                this.judgeWechat();
                this.visibilitychange();

                this.getSlideList();
                this.getGroupList();
                this.getAccountList();
                this.getSaleList();
                this.getWechat();
                this.getPasswd();
            },
            methods: {
                judgeWechat () {
                    let wechat = navigator.userAgent.match(/MicroMessenger\/([\d\.]+)/i);
                    let judgewechat = wechat[1].split('.');
                    if (judgewechat[0] > 7 || judgewechat[0] == 7 && (judgewechat[1] > 0 || judgewechat[1] == 0 && judgewechat[2] >= 12)) {
                        this.wechatState = true;
                    } else {
                        this.wechatState = false;
                    }
                },
                visibilitychange () {
                    document.addEventListener('visibilitychange', () => {
                        this.isHidden = document.hidden;
                        if (this.isHidden === true && this.video.interval) {
                            this.video.player.pause();
                            clearInterval(this.video.interval);
                        } else if (this.isHidden === false && this.video.countdown > 0) {
                            this.video.player.play();
                            this.playVideo();
                        }
                    });
                },
                orderClick () {
                    if (zovye_fn.redirectToBonusPage) {
                        zovye_fn.redirectToUserPage();
                    } else {
                        zovye_fn.redirectToOrderPage();
                    }
                },
                feedbackClick () {
                    zovye_fn.redirectToFeedBack();
                },
                showToast (text) {
                    if (this.toast.visible) {
                        clearTimeout(this.toast.timeout);
                        this.toast.timeout = null;
                    }
                    this.toast.text = text;
                    this.toast.visible = true;
                    this.toast.timeout = setTimeout(() => {
                        this.toast.visible = false;
                    }, 2000);
                },
                getSlideList () {
                    zovye_fn.getAdvs(4, 10, (data) => {
                        data.forEach(e => {
                            e.data.images.forEach(img => {
                                let obj = {
                                    image: img,
                                    url: e.data.link,
                                    id: e.id
                                };
                                this.slides.push(obj);
                            })
                        });
                        this.$nextTick(() => {
                            new Swiper('#adv-swiper-container', {
                                autoplay: {
                                    delay: 3000,
                                    disableOnInteraction: false
                                },
                                pagination: {
                                    el: '.swiper-pagination'
                                }
                            });
                        });
                    });
                },
                slideClick (item) {
                    if (item.url) {
                        window.location.href = item.url;
                    }
                },
                getGroupList () {
                    zovye_fn.getAdvs(9, 10, (data) => {
                        this.groups = data;
                    });
                },
                groupClick (item) {
                    window.location.href = item.data.url;
                },
                getAccountList () {
                    this.loading = true;
                    zovye_fn.getAccounts([], res => {
                        this.getGoodsList();
                        if (res.status) {
                            this.account.list = res.data || [];
                            if (this.account.list.length > 0) {
                                this.account.data = this.account.list[0];
                                if (typeof zovye_fn.saveUserProfile === 'function') {
                                    this.saveUserProfile = true;
                                }
                            }
                        } else {
                            this.loading = false;
                            alert(res.data.msg);
                        }
                    });
                },
                getGoodsList () {
                    zovye_fn.getGoodsList(res => {
                        this.loading = false;
                        if (res.status) {
                            const goods = res.data.goods || [];
                            goods.forEach(e => {
                                e.count = 1;
                            })
                            this.pay = goods;
                            this.packages = res.data.packages || [];
                        } else {
                            alert(res.data.msg);
                        }
                    })
                },
                getSaleList () {
                    zovye_fn.getAdvs(10, 10, (data) => {
                        this.sales = data;
                    });
                },
                saleClick (item) {
                    if (item.data.url) {
                        window.location.href = item.data.url;
                    }
                },
                getWechat () {
                    zovye_fn.getAdvs(11, 1, (data) => {
                        if (data.length > 0) {
                            this.wechat.qrcode = data[0].data.image;
                            this.wechat.desc = data[0].data.text;
                        }
                    });
                },
                chooseGoods (goods) {
                    if (goods.num > 0) {
                        this.loading = true;
                        zovye_fn.chooseGoods(goods.id, 1, res => {
                            this.loading = false;
                            if (res.status) {
                                this.account.visible = true;
                            } else {
                                alert(res.data.msg);
                            }
                        })
                    } else {
                        this.showToast('商品已售罄');
                    }
                },
                playClick () {
                    const that = this;
                    if (!that.video.player) {
                        that.video.countdown = that.account.data.duration;
                        const options = {
                            autoplay: true,
                            sources: [{
                                type: "video/mp4",
                                src: that.account.data.media
                            }]
                        };

                        that.video.player = videojs('player', options, function onPlayerReady () {
                            this.play();
                            that.video.visible = true;
                            that.playVideo();
                        });
                    }
                },
                playVideo () {
                    this.playRequest();
                    this.video.interval = setInterval(() => {
                        this.video.countdown--;
                        if (this.video.countdown === 0) {
                            clearInterval(this.video.interval);
                        }
                    }, 1000);
                },
                playRequest () {
                    zovye_fn.play(this.account.data.uid, this.account.data.duration - this.video.countdown, (res) => {
                        if (res) {
                            if (!res.status) {
                                this.video.player.pause();
                                clearInterval(this.video.interval);
                                this.video.visible = false;
                                this.isHidden = true;
                                alert(res.data.msg || '播放出错！');
                            }
                            if (res.data && res.data.redirect) {
                                window.location.replace(res.data.redirect);
                            } else if (res.status) {
                                setTimeout(() => {
                                    if (this.isHidden !== true) {
                                        this.playRequest();
                                    }
                                }, 1000)
                            }
                        }
                    });
                },
                buyPackageClick (package) {
                    zovye_fn.package_pay(package.id);
                },
                minusClick (item) {
                    if (item.num === 0) {
                        this.showToast('商品已售罄');
                    } else {
                        if (item.count > 1) {
                            item.count--;
                        } else {
                            this.showToast('不能再减啦');
                        }
                    }
                },
                plusClick (item) {
                    if (item.num === 0) {
                        this.showToast('商品已售罄');
                    } else {
                        if (item.count < item.num && item.count < this.max) {
                            item.count++;
                        } else {
                            this.showToast('不能再加啦');
                        }
                    }
                },
                buyClick (item) {
                    if (item.num === 0) {
                        this.showToast('商品已售罄');
                    } else if (!this.loading) {
                        this.loading = true;
                        const data = {
                            goodsID: item.id,
                            total: item.count
                        }
                        zovye_fn.goods_wxpay(data).then(() => {
                            this.loading = false;
                        }).catch(() => {
                            this.loading = false;
                        });
                    }
                },
                retryOrder () {
                    zovye_fn.retryOrder((res) => {
                        if (res.status) {
                            this.retry.text = res.data.message;
                            this.retry.visible = true;
                        }
                    })
                },
                retryClick () {
                    zovye_fn.closeWindow && zovye_fn.closeWindow();
                },
                getPasswd () {
                    zovye_fn.getAdvs('passwd', 1, (data) => {
                        if (data.length > 0) {
                            this.passwd = {
                                visible: true,
                                data: data[0].data
                            };
                        }
                    })
                },
                onCopy () {
                    this.passwd.visible = false;
                },
                onError () {
                    this.passwd.visible = false;
                },
                sexClick (value) {
                    zovye_fn.saveUserProfile({ sex: value });
                    this.saveUserProfile = false;
                },
                freeClick() {
                    this.account.visible = true;
                    if (this.account.data.username) {
                        this.addWeappListener();
                    }
                },
                changeClick () {
                    const len = this.account.list.length;
                    this.account.index++;
                    if (this.account.index == len) {
                        this.account.index = 0;
                    }
                    this.account.data = this.account.list[this.account.index];
                    if (this.account.data.username) {
                        this.addWeappListener();
                    }
                },
                addWeappListener () {
                    if (this.wechatState) {
                        this.$nextTick(() => {
                            var btn = document.getElementById(this.account.data.uid);
                            btn.addEventListener('launch', (e) => {
                                if (this.account.timeout) {
                                    clearTimeout(this.account.timeout);
                                    this.account.timeout = null;
                                }
                                this.account.timeout = setTimeout(() => {
                                    if (document.hidden) {
                                        zovye_fn.redirectToAccountGetPage && zovye_fn.redirectToAccountGetPage(this.account.data.uid);
                                    }
                                }, this.account.data.delay * 1000);
                            });
                            btn.addEventListener('error', function (e) {
                                console.log('fail', e.detail);
                            });
                        })
                    } else {
                        alert('当前微信版本过低，建议升级微信后再试！');
                    }
                }
            }
        })
    </script>
</body>

</html>