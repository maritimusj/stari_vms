{template 'common/header'}
{php \zovye\url(true, 'static/css/common.css?v=20201108');}
<style>
    .disabled {
        color: #ccc;
    }
    #text-config,#news-config {
        display: none;
    }
</style>
<form action="{php echo $this->createWebUrl('account');}" method="post">
    <div class="panel panel-default">
        <div class="heading">
            <span class="operate">
                <a href="{php echo $this->createWebUrl('account');}"><i class="fa fa-reply" title="返回"></i></a>
            </span>
        </div>
        <div class="panel-body">
            <div class="seg">
                <div class="title">基本信息</div>
                {if $account && !$account->isSpecial()}
                <div class="form-group">
                    <label for="select_agent" class="col-md-2 control-label">代理商</label>
                    <div class="col-md-5">
                        <select name="agentId" id="select_agent" style="width:100%;">
                            {if $agent_openid}
                            <option value="{$agent_openid}">{php echo $agent_name . "，手机号码：" . $agent_mobile}</option>
                            {/if}
                            <option value="0">&lt;无&gt;</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="keyword_agent" id="keyword_agent" placeholder="请输入手机号码或者名称查找">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-default" type="button" id="find_agent">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
                {/if}
                <div class="form-group">
                    <label for="name" class="col-md-2 control-label">帐号</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="name" id="name" value="{php echo $account?$account->getName():''}" {if $op=='edit'}readonly{/if}>
                        {if $op!='edit'}<span class="help-block">* 用来识别一个公众号，以后不可以修改</span>{/if}
                    </div>
                </div>

                <div class="form-group">
                    <label for="title" class="col-md-2 control-label">名称</label>
                    <div class="col-md-10">
                        <input type="title" class="form-control" name="title" id="title" value="{php echo $account?$account->getTitle() :''}">
                    </div>
                </div>  
                {if empty($account)  || !$account->isSpecial()}
                <div class="form-group">
                    <label class="col-md-2 control-label">
                        {if $type == \zovye\Account::VIDEO}
                        头像
                        {else}
                        公众号头像
                        {/if}
                    </label>
                    <div class="col-md-10">
                        {php echo tpl_form_field_image('img', $account?$account->getImg():'');}
                    </div>
                </div>
                {/if}
                {if $type == zovye\Account::VIDEO}
                <div class="form-group">
                    <label class="col-md-2 control-label">视频</label>
                    <div class="col-md-10">
                        {php echo tpl_form_field_video('qrcode', $account ? $account->getMedia() : '')}
                    </div>
                </div>     
                <div class="form-group">
                    <label for="count" class="col-md-2 control-label">时长（秒）</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="duration" id="duration" value="{php echo $account?$account->getDuration():'1'}">
                        <span class="help-block">* 用户等待视频播放指定时长后，才能成功领取奖励</span>
                    </div>
                </div>         
                {else}
                    {if $account && $account->isAuth()}
                    <input name="qrcode" type="hidden" value="{php echo $account->getQrcode()}">
                    {/if}
                    {if empty($account) || (!$account->isSpecial() && !$account->isAuth())}
                    <div class="form-group">
                        <label class="col-md-2 control-label">二维码</label>
                        <div class="col-md-10">
                            {php echo tpl_form_field_image('qrcode', $account?$account->getQrcode():'');}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">更多二维码（可选）</label>
                        <div class="col-md-10">
                            {php echo tpl_form_field_multi_image('qrcodes', $qrcodes);}
                            <span class="help-block">* 用户需要关注以上列表中所有公众号才能领取商品</span>
                        </div>
                    </div>
                    {/if}
                {/if}
                <div class="form-group">
                    <label for="descr" class="col-md-2 control-label">引导关注文字</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="descr" id="descr" value="{php echo $account?$account->getDescr():''}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">边框颜色</label>
                    <div class="col-md-10">
                        {php echo tpl_form_field_color('clr', $account?$account->getClr(): $clr);}
                    </div>
                </div>
            </div>
            {if $account && !$account->isSpecial() && !$account->useAccountQRCode()}
            <div class="seg">
                <div class="title">高级设置</div>
                <div class="form-group">
                    <label for="scname" class="col-md-2 control-label">领取周期</label>
                    <div class="col-md-10">
                        <select  class="form-control" name="scname" id="scname">
                            <option value="{php echo zovye\Schema::DAY}" {if $account && $account->getScname() == zovye\Schema::DAY}selected{/if}>每天</option>
                            <option value="{php echo zovye\Schema::WEEK}" {if $account && $account->getScname() == zovye\Schema::WEEK}selected{/if}>每周</option>
                            <option value="{php echo zovye\Schema::MONTH}" {if $account && $account->getScname() == zovye\Schema::MONTH}selected{/if}>每月</option>
                        </select>
                        <span class="help-block">* 每天/每周/每月可领取一件商品</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="count" class="col-md-2 control-label">一个周期内<br/><b>单个用户</b>可领取数量</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="count" id="count" value="{php echo $account?$account->getCount():'1'}">
                        <span class="help-block">* 每个用户在关注该公众号以后<b>每个周期</b>最大可领取的商品数量，0表示不限制数量</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sccount" class="col-md-2 control-label">一个周期内<br/><b>全部用户</b>可领取总数</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="sccount" id="sccount" value="{php echo $account?$account->getSccount():'0'}">
                        <span class="help-block">* 全部用户在一个周期内领取总数量的最大值，0表示不限制数量</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="total" class="col-md-2 control-label"><b>单个用户</b><br/>累计最多领取数量</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="total" id="total" value="{php echo $account?$account->getTotal():'0'}">
                        <span class="help-block">* 每个用户在关注该公众号以后累计最多可领取的商品数量，0表示不限制数量</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="orderlimits" class="col-md-2 control-label"><b>所有用户</b><br/>累计最多领取总数</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="orderlimits" id="orderlimits" value="{php echo $account?$account->getOrderLimits():'0'}">
                        <span class="help-block">* 所有用户在这个公众号领取的商品总数量，0表示不限制数量，<b>超过后，系统会自动禁用该公众号！</b></span>
                    </div>
                </div> 
            </div>
            {/if}
            {if empty($account) || !$account->useAccountQRCode()}
                <div class="seg">
                    <div class="title">用户限制</div>
                    <div class="form-group">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">性别</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label class="checkbox-inline">
                            <input type="checkbox" id="sexCheckbox1" name="limits[]" value="male" {if $limits && $limits['male'] or empty($limits)}checked{/if}> 男
                            </label>
                            <label class="checkbox-inline">
                            <input type="checkbox" id="sexCheckbox2" name="limits[]" value="female" {if $limits && $limits['female'] or empty($limits)}checked{/if}> 女
                            </label>
                            <label class="checkbox-inline">
                            <input type="checkbox" id="sexCheckbox0" name="limits[]" value="unknown_sex" {if $limits && $limits['unknown_sex'] or empty($limits)}checked{/if}> 未知
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">手机系统</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label class="checkbox-inline">
                            <input type="checkbox" id="phoneCheckbox1" name="limits[]" value="ios" {if $limits && $limits['ios'] or empty($limits)}checked{/if}> iPhone手机
                            </label>
                            <label class="checkbox-inline">
                            <input type="checkbox" id="phoneCheckbox2" name="limits[]" value="android" {if $limits && $limits['android'] or empty($limits)}checked{/if}> Android手机
                            </label>
                        </div>
                    </div>
                </div>
                <div class="seg">
                    <div class="title">其它设置</div>
                    {if empty($account) || !$account->isSpecial()}
                    <div class="form-group">
                        <label for="groupname" class="col-md-2 control-label">分组名称</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="groupname" id="groupname" value="{php echo $account?$account->getGroupName():''}">
                            <span class="help-block">* 可选，同一分组的公众号不会同时出现在公众号关注页面中</span>
                        </div>
                    </div>
                    {/if}
                    <div class="form-group">
                        <label for="orderno" class="col-md-2 control-label">排序</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="orderno" id="orderno" value="{php echo $account?$account->getOrderNo():0}">
                            <span class="help-block">* 可选，范围0 - 999，默认为0。数字越大，优先级越高。</span>
                        </div>
                    </div>
                    {if \zovye\App::isUserCenterEnabled()}
                    <div class="form-group">
                        <label for="balanceDeductNum" class="col-md-2 control-label">领取成功扣除余额</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="balanceDeductNum" id="balanceDeductNum" value="{php echo $account?$account->getBalanceDeductNum():''}" min="0">
                            <span class="help-block">* 用户需要花费相应的余额才能领取成功</span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isWxPlatformEnabled() && $account && $account->isAuth()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">出货时机</label>
                        <div class="col-md-8">
                            <label for="scan" class="radio-inline{if !$account->isVerified()} disabled{/if}">
                                <input name="OpenTiming" id="scan" type="radio" value="0"{if !$account->isVerified()} disabled {else}{if empty($config['open']['timing'])} checked="checked"{/if}{/if}>
                                扫码进入公众号
                            </label>
                            <label for="link" class="radio-inline">
                                <input name="OpenTiming" id="link" type="radio" value="1"{if $config['open']['timing'] == 1} checked="checked"{/if}>
                                打开取货链接
                            </label>
                            <span class="help-block">* 请选择出货时机，用户扫码进入公众号后立即出货或用户打开取货页面后出货</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="openMsgType" class="col-md-2 control-label">消息推送</label>
                        <div class="col-md-10">
                            <select style="width: 100%;" name="openMsgType" id="openMsgType">
                                <option value="text"{if isset($config['open']['msg'])} selected{/if}>文本消息</option>
                                <option value="news"{if isset($config['open']['news'])} selected{/if}>图文消息</option>
                            </select>
                            <span class="help-block">* 用户扫码进入公众号后，给用户推送消息</span>
                        </div>
                    </div>
                    <div class="form-group" id="text-config">
                        <label for="openTextMsg" class="col-md-2 control-label"></label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="openTextMsg" id="openTextMsg" value="{$config['open']['msg']}">
                            <span class="help-block">* 使用 <b>{url}</b> 或者<b>{url}文字{/url}</b>占位符可以加入取货链接</span>
                        </div>
                    </div>
                    <div id="news-config">
                        <div class="form-group" >
                            <label class="col-md-2 control-label"></label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="openNewsTitle" value="{$config['open']['news']['title']}">
                                <span class="help-block">* 图文消息标题</span>
                            </div>                        
                        </div>
                        <div class="form-group" >
                            <label class="col-md-2 control-label"></label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="openNewsDesc" value="{$config['open']['news']['desc']}">
                                <span class="help-block">* 图文消息内容</span>
                            </div>                        
                        </div>
                        <div class="form-group" >
                            <label class="col-md-2 control-label"></label>
                            <div class="col-md-10">
                                {php echo tpl_form_field_image('openNewsImage', $config['open']['news']['image']);}
                            </div>                        
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isJfbEnabled() && $account && $account->isJFB()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="scene" class="col-md-2 control-label">场景</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="scene" id="scene" value="{$config['scene']}">
                            <span class="help-block">* 准粉吧 设备场景</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="apiURL" class="col-md-2 control-label">API URL</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="apiURL" id="apiURL" value="{$config['url']}">
                            <span class="help-block">* 准粉吧 API 接口网址</span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isMoscaleEnabled() && $account && $account->isMoscale()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="appid" class="col-md-2 control-label">公锤 app id</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="appid" id="appid" value="{$config['appid']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appsecret" class="col-md-2 control-label">公锤 app secret</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="appsecret" id="appsecret" value="{$config['appsecret']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    {/if}                
                    {if \zovye\App::isYunfenbaEnabled() && $account && $account->isYunfenba()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="vendorUID" class="col-md-2 control-label">云粉渠道UID</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="vendorUID" id="vendorUID" value="{$config['vendor']['uid']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isAQiinfoEnabled() && $account && $account->isAQiinfo()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="key" class="col-md-2 control-label">阿旗数据平台 appkey</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="key" id="key" value="{$config['key']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="secret" class="col-md-2 control-label">阿旗数据平台 appsecret</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="secret" id="secret" value="{$config['secret']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isZJBaoEnabled() && $account && $account->isZJBao()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="key" class="col-md-2 control-label">纸巾宝平台 appkey</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="key" id="key" value="{$config['key']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="secret" class="col-md-2 control-label">纸巾宝平台 appsecret</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="secret" id="secret" value="{$config['secret']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isMeiPaEnabled() && $account && $account->isMeiPa()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="apiid" class="col-md-2 control-label">美葩平台 apiid</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="apiid" id="apiid" value="{$config['apiid']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appkey" class="col-md-2 control-label">美葩平台 appkey</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="appkey" id="appkey" value="{$config['appkey']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">美葩平台 回调网址</label>
                        <div class="col-md-10">
                            <span class="form-control operate" style="overflow:hidden;"><i class="fa fa-paste" title="复制网址" data-url="{php echo \zovye\Util::murl('meipai')}"></i> {php echo \zovye\Util::murl('meipai')}</span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isKingFansEnabled() && $account && $account->isKingFans()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="apiid" class="col-md-2 control-label">金粉吧渠道ID</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="bid" id="bid" value="{$config['bid']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appkey" class="col-md-2 control-label">金粉吧渠道key</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="key" id="key" value="{$config['key']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">金粉吧平台 回调网址</label>
                        <div class="col-md-10">
                            <span class="form-control operate" style="overflow:hidden;"><i class="fa fa-paste" title="复制网址" data-url="{php echo \zovye\Util::murl('kingfans')}"></i> {php echo \zovye\Util::murl('kingfans')}</span>
                        </div>
                    </div>
                    {/if}
                    {if \zovye\App::isSNTOEnabled() && $account && $account->isSNTO()}
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="channel" class="col-md-2 control-label">史莱姆 channel id</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="channel" id="channel" value="{$config['channel']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="app_id" class="col-md-2 control-label">史莱姆 app_id</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="app_id" id="app_id" value="{$config['id']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="app_key" class="col-md-2 control-label">史莱姆 app_key</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control inputMask" name="app_key" id="app_key" value="{$config['key']}">
                            <span class="help-block"></span>
                        </div>
                    </div>
                    {/if}
                </div>
                {if \zovye\App::isCommissionEnabled()}
                <div class="seg">
                    <div class="title">佣金系统</div>
                    <div class="form-group">
                        <label for="commission_share" class="col-md-2 control-label">加入推广</label>
                        <div class="col-md-10">
                            <div class="checkbox">
                            <label>
                                <input type="checkbox" name="commission_share" id="commission_share" value="1" {if $account && $account->getShared()}checked{/if}>
                                是否出现在代理商的广告平台中，并允许代理商帮助推广
                            </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="commission_money" class="col-md-2 control-label">佣金（元）</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="commission_money" id="commission_money" value="{php echo $commission ? number_format($commission['money']/100, 2) : '0'}" min="0" step="0.01">
                            <span class="help-block">* 用户这个公众号领取成功后，设备代理商会获得指定佣金</span>
                        </div>
                    </div>
                </div>
                {/if}
            {else}
            <div class="seg">
                <div class="form-group">
                    <label for="OpenMsg" class="col-md-2 control-label">消息推送</label>
                    <div class="col-md-10">
                        <select style="width: 100%;" name="openMsgType" id="openMsgType">
                            <option value="text" {if isset($config['open']['msg'])}selected{/if}>文本消息</option>
                            <option value="news" {if isset($config['open']['news'])}selected{/if}>图文消息</option>
                        </select>
                        <span class="help-block">* 用户扫码进入公众号后，给用户推送消息</span>
                    </div>
                </div>
                <div class="form-group" id="text-config">
                    <label for="openTextMsg" class="col-md-2 control-label"></label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="openTextMsg" id="openTextMsg" value="{$config['open']['msg']}">
                        <span class="help-block">* 使用 <b>{url}</b> 或者<b>{url}文字{/url}</b>占位符可以加入取货链接</span>
                    </div>
                </div>
                <div id="news-config">
                    <div class="form-group" >
                        <label class="col-md-2 control-label"></label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="openNewsTitle" value="{$config['open']['news']['title']}">
                            <span class="help-block">* 图文消息标题</span>
                        </div>                        
                    </div>
                    <div class="form-group" >
                        <label class="col-md-2 control-label"></label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="openNewsDesc" value="{$config['open']['news']['desc']}">
                            <span class="help-block">* 图文消息内容</span>
                        </div>                        
                    </div>
                    <div class="form-group" >
                        <label class="col-md-2 control-label"></label>
                        <div class="col-md-10">
                            {php echo tpl_form_field_image('openNewsImage', $config['open']['news']['image']);}
                        </div>                        
                    </div>
                </div>
            </div>
            {/if}
        </div>
    </div>
  
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        {if $op=='edit' && $id}
        <input type="hidden" name="id" value="{$id}">
        <button type="submit" class="btn btn-primary">保存</button>
        {else}
        <button type="submit" class="btn btn-primary">创建</button>
        {/if}
        <input type="hidden" name="type" value="{$type}">
        
        <button type="button" class="btn btn-default" onclick="location.href='{php echo $this->createWebUrl('account');}'">返回</button>
    </div>
</form>

<script>
    require(["{php \zovye\url(false, 'static/js/zovye.min.js')}"], function (zovye) {
        zovye.enableInputMask();
        zovye.enableCopy();
    })
    $(function(){
        const open_id = 0;
        $('#find_agent').click(function () {
            const keyword = $('input[name=keyword_agent]').val();
            util.loading();
            $.get("{php echo $this->createWebUrl('agent', array('id'=>$id));}", {
                op: 'search',
                keyword: keyword
            }, function (res) {
                let html = '';
                if (res.status) {
                    const list = res.data || [];
                    let isSelected = '';
                    list.forEach(function (e) {
                        isSelected = '';
                        if (e.openid == open_id) {
                            isSelected = 'selected = "selected"';
                        }
                        html += '<option value="_1*" _4*>_2*，手机号码：_3*</option>'
                            .replace('_1*', e.openid)
                            .replace('_2*', e.name)
                            .replace('_3*', e.mobile)
                            .replace('_4*', isSelected);
                    })
                }
                isSelected = '';
                if (0 == open_id) {
                    isSelected = 'selected = "selected"';
                }
                html += '<option value="0" ' + isSelected + '><不限></option>';
                $('#select_agent').html(html);

            }, 'json').complete(function () {
                util.loaded();
            })
        })
    })

    $(function() {        
        function change(v) {            
            ['text', 'news'].forEach(e => {
                if (e == v) {
                    $('#' + e + '-config').show();
                } else {
                    $('#' + e + '-config').hide();
                }
            })  
        }
        change("{php echo isset($config['open']['msg']) ? 'text':'news'}");
        $('#openMsgType').change(function() {
            change($(this).val());
        })
    })
</script>
{template 'common/footer'}