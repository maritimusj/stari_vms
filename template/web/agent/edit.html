{template 'common/header'}
{php \zovye\url(true, 'static/css/common.css?v=20231125001');}

<style>
    .order_type {
        background: #ccc;
        padding: 3px 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        color: #f7f8fa;
        margin: 1px;
        cursor: default;
    }
    .mixed_order_type {
        margin: 1px 1px;
        background: #ccc;
        color: #f7f8fa;
        width: 100px;
        text-align: center;
        padding: 3px 6px;
        cursor: default;
    }
    .order_type.f,.mixed_order_type.f {
        border-color: #777;
        background: #8bc34a;
    }
    .order_type.f.none,
    .mixed_order_type.f.none,
    .order_type.b.none,
    .mixed_order_type.b.none,
    .order_type.p.none,
    .mixed_order_type.p.none{
        border-color: #777;
        background: #ccc;
    }
    .order_type.b,.mixed_order_type.b {
        border-color: #777;
        background: #ffc107;
    }
    .order_type.p,.mixed_order_type.p {
        border-color: #777;
        background: #03a9f4;
    }
    .mixed_order_type .name {
        margin-right: 6px;
    }
    .rel {
        cursor: pointer;
    }
    .checkbox-inline.fail {
        color: #9e9e9e;
    }
    [v-cloak] {
        display: none;
    }
</style>

<div style="margin-bottom: 1em;display: block;">
    <div style="position:absolute;float:right;right:2em;top:1em;z-index: 99;">
        <div class="profile {if $agent->isAgent()}agent{/if}" style="position:relative">
            <img src="{php echo $agent->getAvatar();}">
            <span>{php echo $agent->getName()}</span>
            {if $agent->isAgent()}
            <span class="agent-user">[ 代理商 ]</span>
            {/if}
        </div>
    </div>
</div>

{if $op == 'agent_base' || $op == 'create' || $op == 'edit'}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation" class="active"><a href="#">基本信息</a></li>
    {if $agent->isAgent()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_notice', 'id'=>$id));}">通知设置</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_funcs', 'id'=>$id));}">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_commission', 'id'=>$id));}">佣金设置</a></li>
    {/if}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_payment', 'id'=>$id));}">支付</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_misc', 'id'=>$id));}">其它</a></li>
    {/if}
</ul>
<form action="{php echo $this->createWebUrl('agent');}" method="post">
    <div class="panel panel-default panel-first nav-tab-item">
        <div class="heading">
        </div>
        <div class="panel-body">
            <div class="seg">
                <div class="title">代理信息</div>
                <div class="form-group">
                    <label class="col-md-2 control-label">代理等级</label>
                    <div class="col-md-10">
                        <select name="level" style="width:100%">
                            {loop $agent_levels $index $level}
                            <option value="{$index}"{if $agent_data['level']==$index} selected{/if} style="color:{$level['clr']}"> {$level['title']} </option>
                            {/loop}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="license" class="col-md-2 control-label">授权证书号</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="license" id="license" value="{$agent_data['license']}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">所属上级</label>
                    <div class="col-md-5">
                        <select name="superior" id="selectagent" style="width:100%;">
                            {if $superior}
                            <option value="{php echo $superior->getOpenid();}">{php echo $superior_data['name']?:'未登记';}，手机号码：{php echo $superior->getMobile()?:'未登记';}，公司：{php echo $superior_data['company']?:'未登记'}</option>
                            {/if}
                            <option value="0">&lt;无&gt;</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="keyword" id="keyword" placeholder="请输入手机号码或者名称查找">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-default" type="button" id="findAgent"><i class="fa fa-search"></i></button>
                    </div>
                </div>
            </div>
            <div class="seg">
                <div class="title">基本信息</div>
                <div class="form-group">
                    <label for="name" class="col-md-2 control-label">姓名</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="name" id="name" value="{$agent_data['name']}" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="mobile" class="col-md-2 control-label">手机号码</label>
                    <div class="col-md-10">
                        <input type="tel" class="form-control" name="mobile" id="mobile" value="{php echo $agent ? $agent->getMobile():''}" required>
                        <span class="help-block">* 手机号码必须提供，代理商管理小程序需要手机号码才能登录！</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="company" class="col-md-2 control-label">公司名称</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="company" id="company" value="{$agent_data['company']}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">所在区域</label>
                    <div class="col-md-10">
                        {php echo tpl_form_field_district('area', $agent_data['area']);}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="agent_base" value="1">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">
        <button type="submit" class="btn btn-primary">
            {if $agent->isAgent()}保存{else}创建{/if}
        </button>
        <a role="button" class="btn btn-default" onclick="backToList()">返回</a>
    </div>
</form>
<script>
    function backToList() {
        setTimeout(function(){
            util.loading();
        }, 1000);
        const page = localStorage.getItem('agent_list.page') || 1;
        window.location.href = "{php echo $this->createWebUrl('agent', ['page' => '__page__']);}".replace('__page__', page);
    }
    require(['jquery', 'util'], function($, util){
        $(function(){
            $('#findAgent').click(function(){
                util.loading();
                const level = $('select[name=level]').val();
                const keyword = $("input[name=keyword]").val();

                $.get("{php echo $this->createWebUrl('agent', array('id'=>$id));}", {op:'search', level:level, keyword:keyword}, function(res){
                    let html = '';
                    if(res.status) {
                        const list = res.data || [];
                        list.forEach(function(e) {
                            html += '<option value="_1*">_2*，手机号码：_3*，公司：_4*</option>'
                                .replace('_1*', e.openid)
                                .replace('_2*', e.name)
                                .replace('_3*', e.mobile)
                                .replace('_4*', e.company);
                        })
                    }
                    html += '<option value="0"><无></option>';
                    $('#selectagent').html(html);

                }, 'json').complete(function(){
                    util.loaded();
                })
            })
        })
    })
</script>
{elseif $op == 'agent_notice'}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_base', 'id'=>$id));}">基本信息</a></li>
    <li role="presentation" class="active"><a href="#">通知设置</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_funcs', 'id'=>$id));}">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_commission', 'id'=>$id));}">佣金设置</a></li>
    {/if}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_payment', 'id'=>$id));}">支付</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_misc', 'id'=>$id));}">其它</a></li>
</ul>
<form action="{php echo $this->createWebUrl('agent');}" method="post">
    <div class="panel panel-default nav-tab-item">
        <div class="heading">
        </div>
        <div class="panel-body">
            <div class="seg">
                <div class="title">事件通知</div>
                <div class="form-group">
                    <label class="col-md-2 control-label">订单事件</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline {if $agent_data['notice']['order']['succeed']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="orderSucceed" value="1" {if $agent_data['notice']['order']['succeed']['enabled']}checked{/if}> 成功订单
                        </label>
                        <label class="checkbox-inline {if $agent_data['notice']['order']['failed']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="orderFailed" value="1" {if $agent_data['notice']['order']['failed']['enabled']}checked{/if}> 异常订单
                        </label>
                        <span class="help-block">* 在订单成功或者失败时，通知代理商。</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">设备事件</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline {if $agent_data['notice']['device']['online']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="deviceOnline" value="1" {if $agent_data['notice']['device']['online']['enabled']}checked{/if}> 上线
                        </label>
                        <label class="checkbox-inline {if $agent_data['notice']['device']['offline']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="deviceOffline" value="1" {if $agent_data['notice']['device']['offline']['enabled']}checked{/if}> 下线
                        </label>
                        <label class="checkbox-inline {if $agent_data['notice']['device']['error']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="deviceError" value="1" {if $agent_data['notice']['device']['error']['enabled']}checked{/if}> 故障
                        </label>
                        <label class="checkbox-inline {if $agent_data['notice']['device']['low_battery']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="deviceLowBattery" value="1" {if $agent_data['notice']['device']['low_battery']['enabled']}checked{/if}> 电量低
                        </label>
                        <label class="checkbox-inline {if $agent_data['notice']['device']['low_remain']['tpl_id']}active{else}fail{/if}">
                            <input type="checkbox" name="deviceLowRemain" value="1" {if $agent_data['notice']['device']['low_remain']['enabled']}checked{/if}> 缺货
                        </label>
                        <span class="help-block">* 在指定事件发生时，通知代理商，注意：相同事件10分钟之内只会通知一次。</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="agent_notice" value="1">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">
        <button type="submit" class="btn btn-primary">
            {if $agent->isAgent()}保存{else}创建{/if}
        </button>
        <a role="button" class="btn btn-default" href="{php echo $this->createWebUrl('agent');}">返回</a>
    </div>
</form>
{elseif $op == 'agent_funcs'}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_base', 'id'=>$id));}">基本信息</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_notice', 'id'=>$id));}">通知设置</a></li>
    <li role="presentation" class="active"><a href="#">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_commission', 'id'=>$id));}">佣金设置</a></li>
    {/if}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_payment', 'id'=>$id));}">支付</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_misc', 'id'=>$id));}">其它</a></li>
</ul>
<style>
    form .seg .checkbox-inline {
        margin: 10px 10px 0 0;
    }
</style>
<form action="{php echo $this->createWebUrl('agent');}" method="post">
    <div class="panel panel-default nav-tab-item">
        <div class="heading">
        </div>
        <div class="panel-body">
            <div class="seg">
                <div class="title">小程序后台</div>
                <div class="form-group">
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_tj" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_tj'])}checked{/if}> 出货统计
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_xj" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_xj'])}checked{/if}> 下级代理
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_sb" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_sb'])}checked{/if}> 设备管理
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_zc" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_zc'])}checked{/if}> 设备注册
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_qz" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_qz'])}checked{/if}> 缺货设备
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_gz" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_gz'])}checked{/if}> 故障设备
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_yy" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_yy'])}checked{/if}> 运营人员
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_gg" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_gg'])}checked{/if}> 广告管理
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_xf" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_xf'])}checked{/if}> 吸粉管理
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_pt" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_pt'])}checked{/if}> 广告平台
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_wt" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_wt'])}checked{/if}> 常见问题
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_wd" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_wd'])}checked{/if}> 文档中心
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_xh" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_xh'])}checked{/if}> 型号管理
                    </label>
                    <label class="checkbox-inline">
                        <input type="checkbox" name="F_sp" value="1" {if (!isset($agent_data['funcs']) || $agent_data['funcs']['F_sp'])}checked{/if}> 商品管理
                    </label>
                </div>
            </div>
            {if \zovye\App::isCustomWxAppEnabled()}
            <div class="seg">
                <div class="title">指定小程序</div>
                <div class="form-group">
                    <label for="WxAppKey" class="col-md-2 control-label">App ID</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="WxAppKey" id="WxAppKey" value="{$agent_data['wx']['app']['key']}">
                        <span class="help-block">* 不填写则代理商可以登录平台所有小程序，否则只能使用指定的小程序</span>
                    </div>
                </div>
            </div>
            {/if}
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="agent_funcs" value="1">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">
        <button type="submit" class="btn btn-primary">
            {if $agent->isAgent()}保存{else}创建{/if}
        </button>
        <a role="button" class="btn btn-default" href="{php echo $this->createWebUrl('agent');}">返回</a>
    </div>
</form>
<script>
    $(function(){
        const maskE = $('<div title="点击编辑">×××已隐藏×××</div>');
        $('form .inputMask').each(function(){
            const self = $(this);
            const x = maskE.clone();
            x.attr('class', self.attr('class')).click(function(){
                x.hide();
                self.show().focus();
            })
            x.insertBefore(self);
            self.removeClass('inputMask').hide();
            self.blur(function(){
                x.show();
                self.hide();
            })
        })
    })
</script>
{elseif $op == 'agent_commission'}
<style>
    #special2 fieldset[disabled] label,
    #special2 fieldset[disabled] input,
    #special2 fieldset[disabled] table {
        color: gray;
    }
    #special2 fieldset[disabled]{
        display: none;
    }
    #userlist td .detail{
        text-align: center;
        padding: 1em;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
</style>
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_base', 'id'=>$id));}">基本信息</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_notice', 'id'=>$id));}">通知设置</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_funcs', 'id'=>$id));}">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation" class="active"><a href="#">佣金设置</a></li>
    {/if}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_payment', 'id'=>$id));}">支付</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_misc', 'id'=>$id));}">其它</a></li>
</ul>
<form action="{php echo $this->createWebUrl('agent');}" method="post" id="commission-form">
    <div class="panel panel-default nav-tab-item">
        <div class="heading">
            {if $agent_data['commission']['enabled']}
            <button type="button" class="btn btn-danger pull-right" data-op="exit">退出分佣</button>
            {/if}
        </div>
        <div class="panel-body">
            <div class="form-group">
                <div class="col-md-10">
                    {if empty($agent_data['commission']['enabled'])}
                    代理还没有加入佣金系统，是否立即加入？ <button type="button" class="btn btn-success"  data-op="join">点击加入</button>
                    {/if}
                </div>
            </div>
            {if $agent_data['commission']['enabled']}
            <div class="seg" id="special">
                <div class="title">支付订单</div>
                <div class="form-group">
                    <label for="commissionFee" class="col-md-2 control-label">手续费</label>
                    <div class="col-md-10">
                        <div class="control-label checkbox-inline">
                            <label for="feeType1" class="radio-inline">
                                <input name="feeType" id="feeType1" type="radio" value="1" {if $agent_data['commission']['fee_type'] == 1}checked="checked"{/if} onclick="chfeeTypeTitle('%')">
                                按百分比&nbsp;
                            </label>
                            <label for="feeType0" class="radio-inline">
                                <input name="feeType" id="feeType0" type="radio" value="0"  {if $agent_data['commission']['fee_type'] == 0}checked="checked"{/if} onclick="chfeeTypeTitle('元')">
                                固定金额 &nbsp;
                            </label>
                            <input type="number"  class="form-control" style="display:inline-block;width:10em;" name="commissionFee" id="commissionFee" value="{php echo number_format($agent_data['commission']['fee'] /100, 2)}" min="0" step="0.01">
                            <span id="feeTypeTitle">{if $agent_data['commission']['fee_type']==1}%{else}元{/if}</span>
                            <span class="help-block">* 扣除支付订单手续费后，剩余金额作为代理商佣金</span>
                        </div>
                    </div>
                </div>
            </div>
            {if \zovye\App::isBalanceEnabled()}
            <div class="seg">
                <div class="title">积分订单</div>
                <div class="form-group">
                    <label for="balanceOrderPrice" class="col-md-2 control-label">佣金（元）
                        <img src="{MODULE_URL}static/img/yen.svg" class="yen">
                    </label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="balanceOrderPrice" id="balanceOrderPrice" value="{php echo isset($agent_data['commission']['balance']['price']) ? number_format($agent_data['commission']['balance']['price']/100, 2) : ''}" min="0" step="0.01">
                        <span class="help-block">* 用户使用积分每兑换一个商品后，代理商都会获得指定佣金奖励，<b>空白表示使用系统设置</b></span>
                    </div>
                </div>
            </div>
            {/if}
            <div class="seg" id="special2">
                <div class="title">佣金分享</div>
                <div class="form-group">
                    <label for="gsp_enabled" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="gsp_enabled" id="gsp_enabled" value="1" {if $agent_data['gsp']['enabled']}checked{/if}>
                                是否开启佣金分享功能
                            </label>
                        </div>
                    </div>
                </div>                
                <fieldset {if empty($agent_data['gsp']['enabled'])}disabled{/if} id="gsp">
                
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">分佣模式</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode" value="rel" {if $agent_data['gsp']['mode'] == 'rel'}checked{/if}>
                                三级 <span style="color:gray;">（代理商所得佣金与上级分佣）</span>
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode" value="free"  {if $agent_data['gsp']['mode'] == 'free'}checked{/if}>
                                自由 <span style="color:gray;">（自由指定用户参与分佣）</span>
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode" value="mixed"  {if $agent_data['gsp']['mode'] == 'mixed'}checked{/if}>
                                混合 <span style="color:gray;">（三级 + 自由组合分佣）</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="seg-divider"></div>
                <fieldset {if empty($agent_data['gsp']['enabled']) || $agent_data['gsp']['mode']!='rel'}disabled{/if} id="gsp_mode_rel_settings">
                <div class="form-group">
                    <label class="col-md-2 control-label">订单类型</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="freeOrderGSP" value="1" {if $agent_data['gsp']['order']['f']}checked{/if}> 免费订单
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" name="payOrderGSP" value="1" {if $agent_data['gsp']['order']['p']}checked{/if}> 支付订单
                        </label>
                        <span class="help-block">* 参与佣金分享的订单类型，只有勾选的订单类型才会参与佣金分享</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">计算方式</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode_type" value="percent" {if $agent_data['gsp']['mode_type'] == 'percent'}checked{/if}>
                                百分比%
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode_type" value="percent/goods" {if $agent_data['gsp']['mode_type'] == 'percent/goods'}checked{/if}>
                                百分比% x 商品数量
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode_type" value="amount"  {if $agent_data['gsp']['mode_type'] == 'amount'}checked{/if}>
                                固定金额
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="gsp_mode_type" value="amount/goods"  {if $agent_data['gsp']['mode_type'] == 'amount/goods'}checked{/if}>
                                固定金额 x 商品数量
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="rel_level1" class="col-md-2 control-label"><b>直接上级</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="rel_level1" id="rel_level1" value="{php echo number_format($agent_data['gsp']['rel'][level1] / 100, 2);}" min="0.00" max="100.00" step="0.01">
                        <span class="help-block">* 直接上级代理商会获得的佣金百分比或金额</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="rel_level2" class="col-md-2 control-label"><b>上上级</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="rel_level2" id="rel_level2" value="{php echo number_format($agent_data['gsp']['rel'][level2] / 100, 2);}" min="0.00" max="100.00" step="0.01">
                        <span class="help-block">* 上级的上一级代理会获得的佣金百分比或金额</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="rel_level3" class="col-md-2 control-label"><b>上上上级</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="rel_level3" id="rel_level3" value="{php echo number_format($agent_data['gsp']['rel'][level3] / 100, 2);}" min="0.00" max="100.00" step="0.01">
                        <span class="help-block">* 上级的上一级的上级代理会获得的佣金百分比或金额</span>
                    </div>
                </div>
                </fieldset>
                <fieldset {if empty($agent_data['gsp']['enabled']) || $agent_data['gsp']['mode']!='free'}disabled{/if} id="gsp_mode_free_settings">
                <div class="form-group">
                    <div class="col-md-12">
                        {if $free_gsp_users}
                        <table class="table" id="userlist">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>用户</th>
                                <th>订单</th>
                                <th>计算方式</th>
                                <th>数值</th>
                                <th>加入时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            {loop $free_gsp_users $index $item}
                            {if $item}
                            <tr data-id="{$item['id']}">
                                <td>{php echo $index + 1}</td>
                                <td>
                                    <div class="profile">
                                        <img src="{$item['avatar']}" />
                                        <span>{$item['nickname']}</span>
                                    </div>
                                </td>
                                <td>
                                    {loop $item['order_type'] $index $o}
                                    {if $index != 'b'}
                                    <span class="order_type {if $o}{$index}{/if}" title="{if $index == 'f'}免费订单{elseif $index == 'p'}支付订单{/if}">
                                        {if $index == 'f'}免费{/if}
                                        {if $index == 'p'}支付{/if}
                                    </span>
                                    {/if}
                                    {/loop}
                                </td>
                                <td>
                                    {$item['gsp']['title']}
                                </td>
                                <td>
                                    <span>{$item['gsp']['val']}</span>
                                </td>
                                <td>
                                    {$item['createtime_formatted']}
                                </td>
                                <td class="operate">
                                    <!--<i class="fa fa-wrench" title="指定设备" data-gsp-op="config"></i>-->
                                    <i class="fa fa-cog" title="设置" data-gsp-op="free_edit"></i>
                                    <i class="fa fa-trash-o" title="删除" data-gsp-op="free_remove"></i>
                                </td>
                            </tr>
                            {/if}
                            {/loop}
                            </tbody>
                        </table>
                        {else}
                        <span class="help-block">提示：暂时还没有任何佣金分享用户，点击以下按钮添加...</span>
                        {/if}
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-12">
                        <button type="button" class="btn btn-success" onclick="searchDlg.choose('free');">
                            <i class="fa fa-user"></i>
                            添加用户
                        </button>
                    </div>
                </div>
                </fieldset>
                <fieldset {if empty($agent_data['gsp']['enabled']) || $agent_data['gsp']['mode']!='mixed'}disabled{/if} id="gsp_mode_mixed_settings">
                    <div class="form-group">
                        <div class="col-md-12">
                            {if $mixed_gsp_users}
                            <table class="table" id="rolelist">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>用户</th>
                                    <th>用户身份</th>
                                    <th>免费订单</th>
                                    <th>支付订单</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                {php $mixed_index = 1}
                                {loop $mixed_gsp_users $index $item}
                                {if $item}
                                <tr data-id="{$item['id']}">
                                    <td>{php echo $mixed_index ++;}</td>
                                    <td>
                                        <div class="profile">
                                            <img src="{$item['avatar']}" />
                                            <span>{$item['nickname']}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {if $index == '[level1]'}
                                        <span>直接上级（一级）</span>
                                        {elseif $index == '[level2]'}
                                        <span>上上级（二级）</span>
                                        {elseif $index == '[level3]'}
                                        <span>上上上级（三级）</span>
                                        {else}
                                        <span class="text-muted">&lt;其它&gt;</span>
                                        {/if}
                                    </td>
                                    <td>
                                        {if $item['f']}
                                        <div>
                                            {$item['f']['val']}{if $item['f']['val_type'] == 'percent'}%
                                            {elseif $item['f']['val_type'] == 'percent/goods'}% x 商品数量
                                            {elseif $item['f']['val_type'] == 'amount'}元
                                            {elseif $item['f']['val_type'] == 'amount/goods'}元 x 商品数量
                                            {/if}
                                        </div>                                        
                                        {/if}
                                    </td>
                                    <td>
                                        {if $item['p']}
                                        <div>
                                            {$item['p']['val']}{if $item['p']['val_type'] == 'percent'}%
                                            {elseif $item['p']['val_type'] == 'percent/goods'}% x 商品数量
                                            {elseif $item['p']['val_type'] == 'amount'}元
                                            {elseif $item['p']['val_type'] == 'amount/goods'}元 x 商品数量
                                            {/if}
                                        </div>                                        
                                        {/if}
                                    </td>
                                    <td class="operate">
                                        <!--<i class="fa fa-wrench" title="指定设备" data-gsp-op="config"></i>-->
                                        {if in_array($index, ['[level1]', '[level2]', '[level3]'])}
                                        {if $index == '[level1]'}
                                        <span class="rel level1" data-op="editRole" data-level="[level1]"><i class="fa fa-cog" title="设置"></i></span>
                                        {elseif $index == '[level2]'}
                                        <span class="rel level2" data-op="editRole" data-level="[level2]"><i class="fa fa-cog" title="设置"></i></span>
                                        {elseif $index == '[level3]'}
                                        <span class="rel level3" data-op="editRole" data-level="[level3]"><i class="fa fa-cog" title="设置"></i></span>
                                        {/if}
                                        {else}
                                        <i class="fa fa-cog" title="设置" data-gsp-op="mixed_edit"></i>
                                        <i class="fa fa-trash-o" title="删除" data-gsp-op="mixed_remove"></i>
                                        {/if}
                                    </td>
                                </tr>
                                {/if}
                                {/loop}
                                </tbody>
                            </table>
                            {else}
                            <span class="help-block">提示：暂时还没有任何佣金分享用户，点击以下按钮添加...</span>
                            {/if}
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-12">
                            <div type="button" class="btn btn-success" data-op="addRole">
                                <i class="fa fa-users" data-op="addRole"></i>
                                三级分佣
                            </div>
                            <button type="button" class="btn btn-success" onclick="searchDlg.choose('mixed');">
                                <i class="fa fa-user"></i>
                                添加用户
                            </button>
                        </div>
                    </div>
                    </fieldset>
                </fieldset>
            </div>
            <div class="seg" id="special3">
                <div class="title">佣金奖励</div>
                <div class="form-group">
                    <label for="agentBonusEnabled" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="agentBonusEnabled" id="agentBonusEnabled" value="1" {if $agent_data['bonus']['enabled']}checked{/if}>
                                是否开启佣金奖励功能<span style="color:#666;">（开启后，代理商以及其上级代理商会获取平台的佣金奖励）</span>
                            </label>
                        </div>
                    </div>
                </div>
                <fieldset {if  empty($agent_data['bonus']['enabled'])}disabled{/if} id="agent_bonus_enabled">
                <div class="form-group">
                    <label class="col-md-2 control-label">订单类型</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline">
                            <input type="checkbox" name="freeOrder" value="1" {if $agent_data['bonus']['order']['f']}checked{/if}> 免费订单
                        </label>
                        <label class="checkbox-inline">
                            <input type="checkbox" name="payOrder" value="1" {if $agent_data['bonus']['order']['p']}checked{/if}> 支付订单
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">计算方式</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <div class="radio">
                            <label>
                                <input type="radio" name="principal" value="order" {if empty($agent_data['bonus']['principal']) || $agent_data['bonus']['principal'] == 'order'}checked{/if}>
                                订单（固定金额）
                            </label>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" name="principal" value="goods"  {if $agent_data['bonus']['principal'] == 'goods'}checked{/if}>
                                商品（金额 x 商品数量）
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus_level0" class="col-md-2 control-label"><b>代理商（元）</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="bonus_level0" id="bonus_level0" value="{php echo number_format($agent_data['bonus']['level0'] / 100, 2)}" min="0" step="0.01">
                        <span class="help-block">* 代理商会获得的现金奖励</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus_level1" class="col-md-2 control-label"><b>直接上级（元）</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="bonus_level1" id="bonus_level1" value="{php echo number_format($agent_data['bonus']['level1'] / 100, 2)}"  min="0" step="0.01">
                        <span class="help-block">* 直接上级代理商会获得的现金奖励</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus_level2" class="col-md-2 control-label"><b>上上级（元）</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="bonus_level2" id="bonus_level2" value="{php echo number_format($agent_data['bonus']['level2'] / 100, 2)}" min="0" step="0.01">
                        <span class="help-block">* 上级的上一级代理会获得的现金奖励</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus_level3" class="col-md-2 control-label"><b>上上上级（元）</b></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="bonus_level3" id="bonus_level3" value="{php echo number_format($agent_data['bonus']['level3'] / 100, 2)}" min="0" step="0.01">
                        <span class="help-block">* 上级的上一级的上级代理会获得的现金奖励</span>
                    </div>
                </div>
                </fieldset>
            </div>
            {/if}
            {if \zovye\App::isAppOnlineBonusEnabled() || \zovye\App::isDeviceQoeBonusEnabled()}
            <div class="seg">
                <div class="title">其它奖励</div>
                {if \zovye\App::isAppOnlineBonusEnabled()}
                <div class="form-group">
                    <label for="appOnlineBonus" class="col-md-2 control-label">APP在线奖励（元/小时）</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="appOnlineBonus" id="appOnlineBonus" value="{php echo isset($agent_data['commission']['appOnlineBonus']['price']) ? number_format($agent_data['commission']['appOnlineBonus']['price']/100, 2) : ''}" min="0" step="0.01">
                        <span class="help-block">* 根据APP在线时长，给代理商计算佣金奖励</span>
                    </div>
                </div>
                {/if}
                {if \zovye\App::isDeviceQoeBonusEnabled()}
                <div class="form-group">
                    <label for="deviceQoeBonus" class="col-md-2 control-label">电费佣金（元/Kw）</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="deviceQoeBonus" id="deviceQoeBonus" value="{php echo isset($agent_data['commission']['deviceQoeBonus']['price']) ? number_format($agent_data['commission']['deviceQoeBonus']['price']/100, 2) : ''}" min="0" step="0.01">
                        <span class="help-block">* 根据设备上报的电量，给代理商支付电费佣金</span>
                    </div>
                </div>
                {/if}
            </div>
            {/if}
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="commission" value="{php echo $agent_data['commission']['enabled'] ? 1 : 0}">
        <input type="hidden" name="agent_commission" value="1">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">

        {if $agent_data['commission']['enabled']}
        <button type="submit" class="btn btn-primary">
            保存
        </button>
        {/if}
        <a role="button" class="btn btn-default" href="{php echo $this->createWebUrl('agent');}">返回</a>
    </div>
</form>
{template 'web/common/search_user'}
<script>
    function chfeeTypeTitle(title) {
        $("#feeTypeTitle").html(title);
    }

    const api = {
        url: "{php echo $this->createWebUrl('agent', array('agentid' => $id));}",
    }

    api.showResult = function (params, url, loading, cb) {
        loading && util.loading();
        $.getJSON(url || api.url, params).done(function (res) {
            loading && util.loaded();
            if (res) {
                if (typeof cb == 'function') {
                    if (cb(res)) {
                        return;
                    }
                }
                if (res.status) {
                    if (res.data && res.data.content) {
                        const dlg = util.dialog(res.data.title || '', res.data.content);
                        dlg.modal('show');
                    }
                }
                if (res.message && res.type) {
                    util.message(res.message, '', res.type);
                }
                if (res.data && res.data.msg) {
                    util.message(res.data.msg, '', res.status ? 'success' : 'error');
                }
            }
        }).fail(function () {
            loading && util.loaded();
        })
    }

     api.remove = function (id, from) {
        if (confirm('确定要删除这个用户吗？')) {
            api.showResult({ op: 'gsp', fn: 'removeuser', id: id, from }, null, false, function (res) {
                if (res.status) {
                    $('tr[data-id=' + id + ']').remove();
                    return true;
                }
            })
        }
    }

    api.free_remove = function (id) {
        api.remove(id, 'free');
    }

    api.mixed_remove = function (id) {
        api.remove(id, 'mixed');
    }

    api.edit = function (id, from) {
        api.showResult({
            op: 'gsp',
            fn: 'edituser',
            id,
            from,
        })
    }

    api.free_edit = function (id) {
        api.edit(id, 'free');
    }

    api.mixed_edit = function (id) {
        api.edit(id, 'mixed');
    }

    api.addRole = function () {
        api.showResult({ op: 'gsp', fn: 'add_role' })
    }
    
    api.editRole = function (self) {
        const level = self.data('level');
        api.showResult({ op: 'gsp', fn: 'add_role',  level: level });
    }

    api.saveRole = function () {
        const form = $("#addRoleForm").serialize();
        $.post(api.url, form).then(function (res) {
            if (res && res.data.msg) {
                util.message(res.data.msg, "", res.status ? 'success':'error');
            }
        })
    }

    searchDlg.init('user', function (user, from) {
        if (user && user.id) {
            api.showResult({op: 'gsp', fn: 'adduser', id: user.id, from});
        }
    })

    function changeType(target) {
        const div = target.closest("div");
        const type = div.find("input:checked").data('type');
        div.find(".type-text").html(type);
    }

    function setFormVal(val) {
        if (val['f']) {
            if (val['f']['val_type'] == 'percent') {
                $('#addRoleForm input#freeOrder1').prop('checked', true);
            } else {
                $('#addRoleForm input#freeOrder0').prop('checked', true);
            }
            $("#addRoleForm input[name=freeOrderVal]").val(val['f']['val']);
        } else {
            $('#addRoleForm input#freeOrder1').prop('checked', false);
            $('#addRoleForm input#freeOrder0').prop('checked', false);
            $("#addRoleForm input[name=freeOrderVal]").val('0');
        }
        if (val['p']) {
            if (val['p']['val_type'] == 'percent') {
                $('#addRoleForm input#payOrder1').prop('checked', true);
            } else {
                $('#addRoleForm input#payOrder0').prop('checked', true);
            }
            $("#addRoleForm input[name=payOrderVal]").val(val['p']['val']);

        } else {
            $('#addRoleForm input#payOrder1').prop('checked', false);
            $('#addRoleForm input#payOrder0').prop('checked', false);
            $("#addRoleForm input[name=payOrderVal]").val('0');
        }
        changeType($("input[name=freeOrderType]"));
        changeType($("input[name=payOrderType]"));
    }

    function enableRoleForm(enabled) {
        $('#addRoleForm select').attr("disabled", !enabled);
        $('#addRoleForm button').attr("disabled", !enabled);
        $('#addRoleForm input').attr("disabled", !enabled);
        $('#addRoleForm label,#addRoleForm span, #addRoleForm select, #addRoleForm input').css("color", enabled ? "" : "#ccc"); 
    }

    function getRole(level) {
        let loading = true;
        setTimeout(() => {
            if (loading) {
                enableRoleForm(false);
            }            
        }, 500);
        
        $.get(api.url, { level: level, op: 'gsp', fn: 'get_role' }).then(function (res) {
            if (res && res.status) {
                setFormVal(res.data);
            } else {
                util.message(res.data.msg, '', 'error');
            }
            loading = false;
            enableRoleForm(true);
        })
    }

    $(function () {
        $('body').on('change', "select[name=level]", function () {
            const level = $(this).val();
            getRole(level);
        })
        $('body').on("click", "[data-type]", function () {
            changeType($(this));
        })
        $('#commission-form button[data-op]').click(function () {
            const form = $('#commission-form');
            const type = $(this).data('op');
            if (type === 'exit') {
                form.find('input[name=commission]').val(0);
            } else {
                form.find('input[name=commission]').val(1);
            }
            form.submit();
        })

        function checkMode() {
            const mode = $('#special2 input[name=gsp_mode]:checked').val();
            $('#special2 fieldset#gsp_mode_rel_settings').attr('disabled', mode !== 'rel');
            $('#special2 fieldset#gsp_mode_free_settings').attr('disabled', mode !== 'free');
            $('#special2 fieldset#gsp_mode_mixed_settings').attr('disabled', mode !== 'mixed');
        }

        $('#special2 input[name=gsp_enabled]').click(function () {
            $('#special2 fieldset#gsp').attr('disabled', !$(this).is(':checked'));
            checkMode();
        })

        $('#special3 input[name=agentBonusEnabled]').click(function () {
            $('#special3 fieldset#agent_bonus_enabled').attr('disabled', !$(this).is(':checked'));
        })

        $('#special2 input[name=gsp_mode]').click(checkMode);

        $('#gsp_mode_free_settings').on('click', '[data-gsp-op]', function () {
            const self = $(this);
            const op = self.data('gsp-op');
            const id = $(this).closest('tr').data('id');
            if (api[op]) {
                api[op](id);
            }
        })

        $('#gsp_mode_mixed_settings').on('click', '[data-op]', function (e) {
            const self = $(this);
            const op = self.data('op');
            if (api[op]) {
                api[op](self);
            }
        })

        $('#gsp_mode_mixed_settings').on('click', '[data-gsp-op]', function () {
            const self = $(this);
            const op = self.data('gsp-op');
            const id = $(this).closest('tr').data('id');
            if (api[op]) {
                api[op](id);
            }
        })
    })
</script>
{elseif $op == 'agent_misc'}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_base', 'id'=>$id));}">基本信息</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_notice', 'id'=>$id));}">通知设置</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_funcs', 'id'=>$id));}">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_commission', 'id'=>$id));}">佣金设置</a></li>
    {/if}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_payment', 'id'=>$id));}">支付</a></li>
    <li role="presentation" class="active"><a href="#">其它</a></li>
</ul>
<form action="{php echo $this->createWebUrl('agent');}" method="post">
    <div class="panel panel-default nav-tab-item">
        <div class="heading">
        </div>
        <div class="panel-body">
            <div class="seg" id="special2">
                <div class="title">定位</div>
                <div class="form-group">
                    <label for="locationEnabled" class="col-md-2 control-label">用户定位</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="locationEnabled" id="locationEnabled" value="1" {if $agent_data['location']['validate']['enabled']}checked{/if}>
                                用户扫描设备二维码后，先确认用户和设备的定位距离
                            </label>
                        </div>
                    </div>
                </div>
                <fieldset {if empty($agent_data['location']['validate']['enabled'])}disabled{/if}>
                <div class="form-group">
                    <label class="col-md-2 control-label">有效范围（米）</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="locationDistance" id="locationDistance" value="{$agent_data['location']['validate']['distance']}" min="1">
                        <span class="help-block">* 只有在设备有效范围以内，才可以领取或购买（请在代理商小程序端保存设备定位信息）</span>
                    </div>
                </div>
                </fieldset>
            </div>
            <div class="seg">
                <div class="title">设备</div>
                <div id="theme-list" v-cloak>
                    <div class="form-group">
                        <label for="theme" class="col-md-2 control-label">手机端界面</label>
                        <div class="col-md-10">
                            <select name="theme" class="form-control" id="theme" v-model="selected" @change="handleChange">
                                <option value="" :selected="!selected"> 系统默认界面 </option>
                                <option :value="item.name"
                                :selected="item.name==selected"
                                v-for="item in list" :key="item.name">
                                {{item.name}}
                                </option>
                            </select>
                            <span class="help-block" v-html="helper"></span>
                        </div>
                    </div>
                </div>
                <script>
                    require(["{php \zovye\url(false, JS_VUE_URL);}"], function (Vue) {
                        new Vue({
                            el: '#theme-list',
                            data: {
                                selected: `{$agent_data['device']['theme']}`,
                                helper: '',
                                list: JSON.parse(`{php echo json_encode($themes)}`),
                            },
                            mounted() {
                                this.handleChange();
                            },
                            methods: {
                                handleChange() {
                                    const item = this.list.find(e => e.name === this.selected);
                                    this.helper = item && (item.helper || '');
                                }
                            }
                        })
                    })
                </script>
                <div class="form-group">
                    <label for="siteTitle" class="col-md-2 control-label">设备领取页面标题</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="siteTitle" id="siteTitle" value="{$agent_data['misc']['siteTitle']}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">设备领取页面logo</label>
                    <div class="col-md-10">
                        {php echo tpl_form_field_image('image', $agent_data['misc']['siteLogo'])}
                    </div>
                </div>
                <div class="form-group">
                    <label for="remainWarning" class="col-md-2 control-label">缺货通知</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="remainWarning" id="remainWarning" value="{$agent_data['device']['remainWarning']}" required>
                        <span class="help-block">* 当设备商品少于指定数量时，发送缺货通知，0表示永远不通知</span>
                    </div>
                </div>
                <div class="seg-divider"></div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">出货策略</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="shipmentBalance1" class="radio-inline">
                            <input name="shipmentBalance" id="shipmentBalance1" type="radio" value="1" {if isset($agent_data['device']['shipment']['balanced']) && !empty($agent_data['device']['shipment']['balanced'])}checked="checked"{/if}>
                            平衡出货
                        </label>
                        <label for="shipmentBalance0" class="radio-inline">
                            <input name="shipmentBalance" id="shipmentBalance0" type="radio" value="0"  {if isset($agent_data['device']['shipment']['balanced']) && empty($agent_data['device']['shipment']['balanced'])}checked="checked"{/if}>
                            顺序出货
                        </label>
                        <span class="help-block">* 平衡出货：库存多的货道优先出货；顺序出货：库存少的货道优先出货</span>
                    </div>
                </div>
            </div>
            <div class="seg">
                <div class="title">其它</div>
                <!--
                <div class="form-group">
                    <label for="maxAccounts" class="col-md-2 control-label">限制公众号显示数量</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="maxAccounts" id="maxAccounts" value="{$agent_data['misc']['maxAccounts']}">
                        <span class="help-block">* 关注公众号页面中最多显示公众号数量, 0表示不限制</span>
                    </div>
                </div>
                -->
                <div class="form-group">
                    <label for="maxTotalFree" class="col-md-2 control-label">用户免费额度</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="maxTotalFree" id="maxTotalFree" value="{php echo intval($agent_data['misc']['maxTotalFree'])}">
                        <span class="help-block">* 用户可免费领取的最大次数, 0表示系统默认</span>
                    </div>
                </div>                
                <div class="form-group">
                    <label for="maxFree" class="col-md-2 control-label">用户<b>每天</b>的免费额度</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="maxFree" id="maxFree" value="{php echo intval($agent_data['misc']['maxFree'])}">
                        <span class="help-block">* 用户每天可免费领取的最大次数, 0表示系统默认</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">工厂权限</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="power1" class="radio-inline">
                            <input name="power" id="power1" type="radio" value="1" {if $agent_data['misc']['power'] == 1}checked="checked"{/if}>
                            开启
                        </label>
                        <label for="power0" class="radio-inline">
                            <input name="power" id="power0" type="radio" value="0"  {if !isset($agent_data['misc']['power']) || $agent_data['misc']['power'] == 0}checked="checked"{/if}>
                            关闭
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">自动退款(该代理商)</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="auto_ref1" class="radio-inline">
                            <input name="auto_ref" id="auto_ref1" type="radio" value="1" {if $agent_data['misc']['auto_ref'] == 1}checked="checked"{/if}>
                            开启
                        </label>
                        <label for="auto_ref2" class="radio-inline">
                            <input name="auto_ref" id="auto_ref2" type="radio" value="2"  {if $agent_data['misc']['auto_ref'] == 2}checked="checked"{/if}>
                            关闭
                        </label>
                        <label for="auto_ref0" class="radio-inline">
                            <input name="auto_ref" id="auto_ref0" type="radio" value="0"  {if !isset($agent_data['misc']['auto_ref']) || $agent_data['misc']['auto_ref'] == 0}checked="checked"{/if}>
                            跟随系统设置
                        </label>
                    </div>
                </div>
                {if \zovye\App::isMustFollowAccountEnabled()}
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">购买商品</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="mustFollow0" class="radio-inline">
                            <input name="mustFollow" id="mustFollow0" type="radio" value="1" {if $agent_data['mfa']['enable'] == 1}checked="checked"{/if} >
                            关注公众号后购买
                        </label>
                        <label for="mustFollow1" class="radio-inline">
                            <input name="mustFollow" id="mustFollow1" type="radio" value="0"  {if isset($agent_data['mfa']['enable']) && $agent_data['mfa']['enable'] == 0}checked="checked"{/if} >
                            直接购买
                        </label>
                        <label for="mustFollow2" class="radio-inline">
                            <input name="mustFollow" id="mustFollow2" type="radio" value="-1"  {if !isset($agent_data['mfa']['enable']) || $agent_data['mfa']['enable'] == -1}checked="checked"{/if} >
                            跟随系统设置
                        </label>
                        <span class="help-block">用户扫描设备二维码后，引导用户关注公众号后通过公众号进入商品购买页面</span>
                    </div>
                </div>
                {/if}
            </div>
            <div class="seg">
                <div class="title">运营人员(默认设置)</div>
                <div class="form-group">
                    <label for="kind" class="col-md-2 control-label">权限</label>
                    <div class="col-md-10">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">
                            <input type="checkbox" name="kind" id="kind" value="1" {if $keeper_data['kind']}checked{/if}>
                            允许补货
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">分佣时机</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="way0" class="radio-inline">
                            <input name="way" id="way0" type="radio" value="0" {if empty($keeper_data['way'])}checked="checked"{/if}>
                            销售分成
                        </label>
                        <label for="way1" class="radio-inline">
                            <input name="way" id="way1" type="radio" value="1"  {if !empty($keeper_data['way'])}checked="checked"{/if}>
                            补货分成
                        </label>
                        <span class="help-block">* 销售分成：设备售出商品获得分成；补货分成：完成补货即可获得分成</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-md-2 col-md-2 control-label">计算方式</label>
                    <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                        <label for="type0" class="radio-inline">
                            <input name="type" id="type0" type="radio" value="fixed" {if $keeper_data['type'] == 'fixed'}checked="checked"{/if}>
                            固定金额
                        </label>
                        <label for="type1" class="radio-inline">
                            <input name="type" id="type1" type="radio" value="percent"  {if $keeper_data['type'] == 'percent'}checked="checked"{/if}>
                            百分比
                        </label>
                    </div>
                </div>
                {if \zovye\App::isKeeperCommissionOrderDistinguishEnabled()}
                <div class="way0">
                    <div class="form-group">
                        <label for="payCommissionVal" class="col-md-2 control-label"><span id="payCommissionTitle">金额(元)</span></label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="payCommissionVal" id="payCommissionVal" value="{$keeper_data['pay_val']}"  min="0.00" step="0.01">
                            <span class="help-block">* <b>支付订单</b>的佣金</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="freeCommissionVal" class="col-md-2 control-label"><span id="freeCommissionTitle">金额(元)</span></label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="freeCommissionVal" id="freeCommissionVal" value="{$keeper_data['free_val']}"  min="0.00" step="0.01">
                            <span class="help-block">* <b>免费订单</b>的佣金</span>
                        </div>
                    </div>
                </div>
                <div class="way1">
                    <div class="form-group">
                        <label for="commissionVal" class="col-md-2 control-label"><span id="commissionTitle">金额(元)</span></label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="commissionVal" id="commissionVal" value="{$keeper_data['val']}"  min="0.00" step="0.01">
                        </div>
                    </div>
                </div>
                {else}
                <div class="form-group">
                    <label for="commissionVal" class="col-md-2 control-label"><span id="commissionTitle">金额(元)</span></label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="commissionVal" id="commissionVal" value="{$keeper_data['val']}"  min="0.00" step="0.01">
                    </div>
                </div>
                {/if}
                <div class="form-group">
                    <label for="applyConfigToAll" class="col-md-2 control-label"></label>
                    <div class="col-md-10">
                        <label class="control-label">
                            <input type="checkbox" name="applyConfigToAll" id="applyConfigToAll" value="1">
                            更新当前设置到所有运营人员
                            <span class="help-block">* 勾选后，所有运营人员佣金配置会被更改为当前配置，否则仅保存为默认配置。</span>
                        </label>
                    </div>
                </div>
            </div>
            {if \zovye\App::isZeroBonusEnabled()}
            <div class="seg">
                <div class="title">佣金</div>
                <div class="form-group">
                    <label for="zeroBonus" class="col-md-2 control-label">零佣金概率(%)</label>
                    <div class="col-md-10">
                        <input type="number" step="0.01" class="form-control" name="zeroBonus" id="zeroBonus" value="{php echo $agent_data['custom']['bonus']['zero']['v'] ?? -1}">
                        <span class="help-block">* -1 默认， 0 表示概率０</span>
                    </div>
                </div>
            </div>
            {/if}
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="agent_misc" value="1">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">
        <button type="submit" class="btn btn-primary">
            {if $agent->isAgent()}保存{else}创建{/if}
        </button>
        <a role="button" class="btn btn-default" href="{php echo $this->createWebUrl('agent');}">返回</a>
    </div>
</form>
<script>
    $(function(){
        $('#special2 input[name=locationEnabled]').click(function(){
            $('#special2 fieldset').attr('disabled', !$(this).is(':checked'));
        })
    })
</script>
{if \zovye\App::isKeeperCommissionOrderDistinguishEnabled()}
<script>
    $(function() {
        changeTitle("{$keeper_data['type']}");
        changeWay("{$keeper_data['way']}");

        $('input[name=type]').change(function() {
            changeTitle($(this).val());
        });

        $('input[name=way]').change(function() {
            changeWay($(this).val());
        });
    })
    function changeTitle(type) {
        $('#payCommissionTitle').text(type === 'percent' ? '百分比(%)' : '金额(元)');
        $('#freeCommissionTitle').text(type === 'percent' ? '百分比(%)' : '金额(元)');
        $('#commissionTitle').text(type === 'percent' ? '百分比(%)' : '金额(元)');
    }
    function changeWay(way) {
        if (way === '1') {
            $('.way0').hide();
            $('.way1').show();
        } else {
            $('.way0').show();
            $('.way1').hide();
        }
    }
</script>
{else}
<script>
    $(function() {
        changeTitle("{$keeper_data['type']}");
        $('input[name=type]').change(function() {
            changeTitle($(this).val());
        });
    })
    function changeTitle(type) {
        $('#commissionTitle').text(type === 'percent' ? '百分比(%)' : '金额(元)');
    }
</script>
{/if}
{elseif $op == 'agent_payment'}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_base', 'id'=>$id));}">基本信息</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_notice', 'id'=>$id));}">通知设置</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_funcs', 'id'=>$id));}">功能设置</a></li>
    {if \zovye\App::isCommissionEnabled()}
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_commission', 'id'=>$id));}">佣金设置</a></li>
    {/if}
    <li role="presentation" class="active"><a href="#">支付</a></li>
    <li role="presentation"><a href="{php echo $this->createWebUrl('agent', array('op' => 'agent_misc', 'id'=>$id));}">其它</a></li>
</ul>
<form action="{php echo $this->createWebUrl('agent');}" method="post">
    <div class="panel panel-default nav-tab-item" id="special">
        <div class="heading">
            {if !empty($payment)}
            <div class="alert alert-warning alert-dismissible" role="alert" style="width: 35em;margin-bottom:0;">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <strong>注意：</strong> 代理商已开启自定义支付，提现申请会被拒绝！！
            </div>
            {/if}
        </div>
        <div class="panel-body">
            <div class="seg">
                <div class="title">扫呗</div>
                <div class="form-group">
                    <label for="lcsw" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="lcsw" id="lcsw" value="1" {if $payment['lcsw']}checked{/if}>
                                是否启用
                            </label>
                        </div>
                    </div>
                </div>
                <fieldset {if empty($payment['lcsw'])}disabled{/if} name="lcsw">
                <div class="form-group">
                    <label for="merchant_no" class="col-md-2 control-label">商户号</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="merchant_no" id="merchant_no" value="{$payment['lcsw']['merchant_no']}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="terminal_id" class="col-md-2 control-label">终端号</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="terminal_id" id="terminal_id" value="{$payment['lcsw']['terminal_id']}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="access_token" class="col-md-2 control-label">密钥</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control inputMask" name="access_token" id="access_token" value="{$payment['lcsw']['access_token']}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">场景</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline" title="用户使用微信公众号支付时，是否使用扫呗收款">
                            <input type="checkbox" name="lcswWxH5" value="1" {if empty($payment['lcsw']) || $payment['lcsw']['app']['wx']['h5']}checked{/if}>
                            微信h5
                        </label>
                        <label class="checkbox-inline" title="用户使用微信小程序支付时，是否使用扫呗收款">
                            <input type="checkbox" name="lcswWxMiniApp" value="1" {if empty($payment['lcsw']) || $payment['lcsw']['app']['wx']['mini_app']}checked{/if}>
                            微信小程序
                        </label>
                        <label class="checkbox-inline" title="用户使用支付宝支付时，是否使用扫呗收款">
                            <input type="checkbox" name="lcswAli" value="1" {if empty($payment['lcsw']) || $payment['lcsw']['app']['ali']}checked{/if}>
                            支付宝
                        </label>
                    </div>
                </div>
                </fieldset>
            </div>
            <div class="seg">                
                {if $payment['SQB']}
                <div class="title">收钱吧</div>
                <div class="form-group">
                    <label for="SQB" class="col-md-2 control-label"></label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="SQB" id="SQB" value="1" checked>
                                是否启用
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="vendor_key" class="col-md-2 control-label">终端名称</label>
                    <div class="col-md-10">
                        <span class="form-control">{$payment['SQB']['title']}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="vendor_key" class="col-md-2 control-label">终端号</label>
                    <div class="col-md-10">
                        <span class="form-control">{$payment['SQB']['sn']}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="code" class="col-md-2 control-label">终端密钥</label>
                    <div class="col-md-10">
                        <span class="form-control inputMask">{$payment['SQB']['key']}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-2 control-label">场景</label>
                    <div class="col-md-10">
                        <label class="checkbox-inline" title="用户使用微信公众号支付时，是否使用收钱吧收款">
                            <input type="checkbox" name="SQBWxH5" value="1" {if $payment['SQB']['app']['wx']['h5']}checked{/if}>
                            微信h5
                        </label>
                        <label class="checkbox-inline" title="用户使用微信小程序支付时，是否使用收钱吧收款">
                            <input type="checkbox" name="SQBWxMiniApp" value="1" {if $payment['SQB']['app']['wx']['mini_app']}checked{/if}>
                            微信小程序
                        </label>
                        <label class="checkbox-inline" title="用户使用支付宝支付时，是否使用收钱吧收款">
                            <input type="checkbox" name="SQBAli" value="1" {if $payment['SQB']['app']['ali']}checked{/if}>
                            支付宝
                        </label>
                    </div>
                </div>
                {else}
                <div class="title">收钱吧</div>
                <div class="form-group">
                    <label for="SQB" class="col-md-2 control-label"></label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="SQB" id="SQB" value="1">
                                是否启用
                            </label>
                        </div>
                    </div>
                </div>
                <fieldset name="SQB" disabled>
                    <div class="form-group">
                        <label for="vendor_sn" class="col-md-2 control-label">AppID</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="app_id" value="">
                            <span class="help-block">* 服务商AppID，仅用于激活，*** 不会保存到当前系统中 ***</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vendor_sn" class="col-md-2 control-label">序列号</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="vendor_sn" id="vendor_sn" value="">
                            <span class="help-block">* 服务商序列号，仅用于激活，*** 不会保存到当前系统中 ***</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vendor_key" class="col-md-2 control-label">密钥</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="vendor_key" id="vendor_key">
                            <span class="help-block">* 服务商密钥，仅用于激活，*** 不会保存到当前系统中 ***</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="code" class="col-md-2 control-label">激活码</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="code" id="code">
                            <span class="help-block">* 终端激活码，服务商后台生成</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">场景</label>
                        <div class="col-md-10">
                            <label class="checkbox-inline" title="用户使用微信公众号支付时，是否使用收钱吧收款">
                                <input type="checkbox" name="SQBWxH5" value="1" checked>
                                微信h5
                            </label>
                            <label class="checkbox-inline" title="用户使用微信小程序支付时，是否使用收钱吧收款">
                                <input type="checkbox" name="SQBWxMiniApp" value="1" checked>
                                微信小程序
                            </label>
                            <label class="checkbox-inline" title="用户使用支付宝支付时，是否使用收钱吧收款">
                                <input type="checkbox" name="SQBAli" value="1" checked>
                                支付宝
                            </label>
                        </div>
                    </div>
                </fieldset>
                {/if}
            </div>
            <div class="seg">
                <div class="title">微信支付</div>
                <div class="form-group">
                    <label for="wx" class="col-md-2 control-label">微信支付</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="wx" id="wx" value="1" {if $payment['wx_v3']}checked{/if}>
                                是否启用
                            </label>
                        </div>
                    </div>
                </div>
                <fieldset {if empty($payment['wx_v3'])}disabled{/if} name="wx">
                <div class="form-group">
                    <label for="wxMCHID" class="col-md-2 control-label">子商户号</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="wxMCHID" id="wxMCHID" value="{$payment['wx_v3']['sub_mch_id']}">
                        <span class="help-block">* 代理商微信支付只支持服务商模式</span>
                    </div>
                </div>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="op" value="save">
        <input type="hidden" name="from" value="{$op}">
        <input type="hidden" name="id" value="{$id}">
        <input type="hidden" name="agent_payment" value="1">
        <button type="submit" class="btn btn-primary">保存</button>
        <a role="button" class="btn btn-default" href="{php echo $this->createWebUrl('agent');}">返回</a>
    </div>
</form>
<script>
    $(function(){
        const maskE = $('<div title="点击编辑">×××已隐藏×××</div>');
        $('form .inputMask').each(function(){
            const self = $(this);
            const x = maskE.clone();
            x.attr('class', self.attr('class')).click(function(){
                x.hide();
                self.show().focus();
            })
            x.insertBefore(self);
            self.removeClass('inputMask').hide();
            self.blur(function(){
                x.show();
                self.hide();
            })
        })
    })
</script>
<script>
    $(function(){
        $('[data-url]').each(function(){
            util.clip(this, $(this).data('url'));
        })

        $('#special input[name=userLocationEnabled]').click(function(){
            $('#special fieldset').attr('disabled', !$(this).is(':checked'));
        })

        $('#special input[name=wx]').click(function(){
            $('#special fieldset[name=wx]').attr('disabled', !$(this).is(':checked'));
        })

        $('#special input[name=lcsw]').click(function(){
            $('#special fieldset[name=lcsw]').attr('disabled', !$(this).is(':checked'));
        })

        $('#special input[name=SQB]').click(function(){
            $('#special fieldset[name=SQB]').attr('disabled', !$(this).is(':checked'));
        })
    })
</script>
{/if}

{template 'common/footer'}