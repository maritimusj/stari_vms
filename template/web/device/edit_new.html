{template 'common/header'}
{php \zovye\url(true, 'static/css/common.css?v=20230710');}
<style>
    #location, #tag_tpl {
        display: none;
    }
    #device_edit_form table.cargo_lanes th {
        text-align: center;
    }
    #device_edit_form table.cargo_lanes td {
        text-align: center;
    }
    #device_edit_form table.cargo_lanes input.goods{
        width: 10em;
        border: 0;
        margin: 0 auto;
        text-align: center;
        display: inline;
    }
    #device_edit_form table.cargo_lanes input.goods {
        border-color: #66afe9;
    }
    .cargo_lanes div.lane {
        position: relative;
        width: 100px;
        margin: 0 auto;
    }
    .cargo_lanes .lane sup{
        color:#66afe9;
        cursor: default;
        position: absolute;
        top: 3px;
        white-space: nowrap;
    }
    #moscaleLabelList {
        display: flex;
        flex-wrap: wrap;
    }
    #moscaleLabelList span {
        background-color: #9E9E9E;
        padding: 2px 8px;
        color: #fff;
        border-radius: 6px;
        margin: 3px 1px;
        cursor: pointer
    }
    #moscaleLabelList span.selected{
        background-color: #FF9800;
    }
    #device_types i.fa-edit {
        visibility: hidden;
    }
    #device_types tr:hover i.fa-trash {
        display: inline;
    }
    #device_types tr:hover i.fa-edit {
        visibility: visible;
    }
    #device_types tr.unknown {
        color: #ccc;
    }
    #device_types span.price {
        cursor: pointer;
    }
    #device_types span.price:hover {
        color: green;
    }
    #device_types .goods_name {
        cursor: pointer;
        white-space: nowrap;
    }
    #device_types .goods_name:hover {
        color: green;
    }
    #device_types .cargo_lanes th.fixed {
        min-width: 200px;
    }
    #device_types .operate i.flash:not(.disabled) {
        color: #4caf50;
    }
    #device_types .package {
        position: relative;
        margin-top: 20px;
        border: 3px solid #e9e9e9;
        padding: 10px;
    }
    #device_types .package::before{
        position: absolute;
        content: "";
        border: 6px solid #e9e9e9;
        top: -15px;
        left: 40px;
        height: 10px;
    }
    #device_types .package::after{
        position: absolute;
        content: "";
        width: 0;
        height: 0;
        border: 10px solid;
        top: -32px;
        left: 36px;
        border-color: transparent transparent #e9e9e9 transparent;
    }
    tr.invalid {
        color: #ccc;
        text-decoration-line: line-through;
    }
    .package .close-btn {
        position: absolute;
        right: 6px;
        top: 6px;
    }
    .editable-price {
        cursor: pointer;
    }
    .index {
        width: 50px;
    }
    .package-list {
        margin-top: 20px;
        position: relative;
    }
    .package-delete {
        position: absolute;
        right: 6px;
        top: 6px;
    }
    .scene_list {
        display: flex;
        flex-wrap: wrap;
    }
    span.scene {
        background-color: #9E9E9E;
        padding: 2px 8px;
        color: #fff;
        border-radius: 6px;
        margin: 3px 1px;
        cursor: pointer;
    }
    span.scene.selected {
        background-color: #8bc34a;
    }
    span.regOk {
        color: forestgreen;
    }
    span.unReg {
        color: gray;
    }
    .row.clock {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        align-content: stretch;
    }
    .divider {
        width: calc(100% + 20px);
        border-top: 1px solid #CCC;
        margin: 2em 0;
        position: relative;
        left: -10px;
    }
    .cargo_lanes .goods {
        position: relative;
    }
    .goods .expire-info {
        display: none;
        position: absolute;
        left: 100px;
        top: 30px;
        background: #fff;
        z-index: 99;
        border: 1px solid #9e9e9e;
        padding: 10px;
        min-width: 200px;
        flex-direction: column;
        align-items: flex-start;
        box-shadow: 4px 4px 1px 1px rgb(204 204 204 / 30%);
    }
    .goods .expire-info .item {
        white-space: nowrap;
    }
    .goods .expire-info .item .title {
        font-weight: bolder;
        margin-right: 10px;
    }
    .goods:hover .expire-info {
        display: flex;
    }
    .expire-info .item.expired>.value{
        color:#FF5722;
    }
    .expire-info .item.alert {
        all: unset;
    }
    .expire-info .item.alert>.value{
        color:#FF9800;
    }
    .expire-info .item.normal>.value{
        color:#4CAF50;
    }
    [v-cloak] {
        display: none;
    }
</style>
<div id="app" v-cloak>
    <ul class="nav nav-tabs" id="navbar">
        <li role="presentation" :class="{'active': nav.op === active}" @click="active=nav.op" v-for="nav in navs">
            <a href="#" v-html="nav.content">
            </a>
        </li>
    </ul>
    <form action="{php echo $this->createWebUrl('device');}" method="post" id="device_edit_form">
        <div class="panel panel-default panel-first">
            <div class="heading">
                <span class="operate">
                    <i class="fa fa-reply" title="返回"  onclick="backToList();"></i>
                </span>
            </div>
            <div class="panel-body">
                <div v-show="active === 'base'">
                    <div class="form-group">
                        <label for="select_agent" class="col-md-2 control-label">所属代理商</label>
                        <div class="col-md-5">
                            <select name="agent_id" id="select_agent" style="width:100%;">
                                {if $agent}
                                <option value="{php echo $agent->getId()}">{php echo $agent->getName() . "，手机号码：" . $agent->getMobile()}</option>
                                {/if}
                                <option value="0">&lt;无&gt;</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="keyword_agent" id="keyword_agent" placeholder="请输入手机号码或者名称查找">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-default" type="button" id="find_agent">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="name" class="col-md-2 control-label">名称</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="name" id="name" value="{php echo $device ? $device->getName() : ''}" required>
                        </div>
                    </div>
                    {if \zovye\App::isVDeviceSupported() && $is_vdevice}
                    <div class="form-group">
                        <label for="IMEI" class="col-md-2 control-label">硬件IMEI</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="IMEI" id="IMEI" value="{php echo $device ? $device->getImei() : $vd_imei}" readonly>
                            {if empty($device)}
                            <span class="help-block">* 虚拟设备的硬件IMEI自动生成</span>
                            {/if}
                        </div>
                    </div>
                    {else}
                    <div class="form-group">
                        <label for="IMEI" class="col-md-2 control-label" v-text="config.is_normal_device ? '硬件IMEI' : '设备编号'"></label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="IMEI" id="IMEI" value="{php echo $device ? $device->getImei() : ''}" :readonly="deviceId > 0" :required="deviceId === 0">
                            <span class="help-block" v-if="deviceId === 0">* 注意：{{config.is_normal_device ? '硬件IMEI' : '设备编号'}}以后无法修改！</span>
                        </div>
                    </div>
                    <!--充电桩-->
                    <div class="form-group" v-if="config.is_charging_device">
                        <label for="chargerNum" class="col-md-2 control-label">充电枪数量</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="chargerNum" id="chargerNum" value="{php echo $device ? $device->getChargerNum() : ''}">
                        </div>
                    </div>
                    <!--蓝牙设备-->
                    <template v-if="config.is_bluetooth_device">
                        <div class="form-group">
                            <label for="BUID" class="col-md-2 control-label">蓝牙UID</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="BUID" id="BUID" value="{php echo $device ? $device->getBUID() : ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="select_protocols" class="col-md-2 control-label">蓝牙协议</label>
                            <div class="col-md-10">
                                <select name="blueToothProtocol" id="select_protocols" style="width:100%;" 
                                data-device="{php echo $device ? $device->getId() : 0}"
                                v-model="bluetooth.current">
                                <option value="{php echo  \zovye\domain\DeviceTypes::UNKNOWN_TYPE}" disabled>
                                    &lt;请选择蓝牙协议&gt;
                                </option>
                                    <option :value="item.name" v-for="(item,index) in bluetooth.list">
                                        {{item.title}}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="MAC" class="col-md-2 control-label">硬件MAC地址</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="MAC" id="MAC" value="{php echo $device ? $device->getMAC() : ''}">
                            </div>
                        </div>
                        <div class="form-group" v-if="bluetooth.current === 'hmb'">
                            <label for="MAC" class="col-md-2 control-label">出货时长（秒）</label>
                            <div class="col-md-10">
                                <input type="number" class="form-control" name="timeout" id="timeout" value="{php echo $device ? $device->getBluetoothTimeout() : 0}">
                                <span class="help-block">* 请设置设备开启后的持续时间，0表示使用全局超时时间。</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="Motor" class="col-md-2 control-label">电机数量</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="Motor" id="Motor" value="{php echo $device ? $device->getMotor() : ''}">
                                <span class="help-block">* 请设置电机货道的数量，没有电机货道请填0</span>
                            </div>
                        </div>
                    </template>
                    {/if}
                    <div id="device_types" v-if="config.is_normal_device || config.is_bluetooth_device || config.is_vdevice || config.is_fueling_device">
                        <div class="form-group" v-if="!config.is_fueling_device">
                            <label for="select_device_types" class="col-md-2 control-label">设备型号</label>
                            <div class="col-md-5">
                                <select name="deviceType" id="select_device_types" style="width:100%;" data-device="{php echo $device ? $device->getId() : 0}"
                                        :disabled="loading"
                                        v-model="currentTypeID">
                                    <option v-for="item in list" :value="item['id']" :selected="item['id']==currentTypeID" v-if="list.length>0">
                                        {{item['title']}}（{{item['lanes_total']}}货道）
                                    </option>
                                    <option value="0">
                                        &lt;自定义&gt;
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control"  placeholder="请输入关键字搜索" v-model="keywords">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-default" type="button" :disabled="loading" @click="search()">
                                    <i :class="{'fa': true, 'fa-search': !searching, 'fa-spinner fa-pulse': searching}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label"></label>
                            <div class="col-md-10" id="lane_detail">
                                <table  class="table table-bordered cargo_lanes" v-if="currentType && currentType.cargo_lanes">
                                    <thead>
                                    <th>{{config.is_fueling_device ? '枪号':'货道'}}</th>
                                    <th>商品名称</th>
                                    <th class="fixed">价格</th>
                                    <th class="fixed">容量</th>
                                    <th class="fixed">当前数量</th>
                                    <th>操作</th>
                                    </thead>
                                    <tbody>
                                    <tr v-for="(lane, i) in currentType.cargo_lanes" :class="{unknown: lane.goods_id==0}" :key="currentTypeID+':'+i">
                                        <td>
                                            <div class="lane">
                                                    <span>
                                                        {{i + 1}}
                                                        <sup title="电机货道" v-if="lane.is_motor">[ 电机 ]</sup>
                                                    </span>
                                            </div>
                                        </td>
                                        <td :class="{operate: isCustomizedType}">
                                            <div class="goods">
                                                    <span :class="{'goods_name': isCustomizedType}"  @click="chooseGoods(lane)" :title="navExists('alert') ? '':'点击选择商品'">
                                                        {{lane.goods_name}}
                                                        <sup class="id" title="商品ID" v-if="lane.goods_id>0">{{lane.goods_id}}</sup>
                                                    </span>
                                                <span v-show="lane.goods_unit_title">（{{lane.goods_unit_title}}）</span>
                                                <div v-if="navExists('alert') && lane.alert && lane.alert.expired_at" class="expire-info">
                                                    <div class="item" :class="lane.alert.status">
                                                        <span class="title">过期时间</span><span class="value">{{lane.alert.expired_at}}</span>
                                                    </div>
                                                    <div class="item">
                                                        <span class="title">提前预警</span><span class="value">{{lane.alert.pre_days}}天</span>
                                                    </div>
                                                    <div class="item">
                                                        <span class="title">过期购买</span><span class="value">{{lane.alert.invalid_if_expired ? '禁止购买':'允许购买'}}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div v-show="currentLane == lane">
                                                <input class="form-control goods" type="number"
                                                       :name="'price' + i"
                                                       step="0.01"
                                                       :min="config.is_fueling_device ? '0':'0'"
                                                       ref="price"
                                                       v-model="lane.goods_price"
                                                       @blur="editPriceDone(lane)"
                                                       @keydown.enter.self.prevent="editPriceDone(lane)"
                                                >
                                            </div>
                                            <span
                                                    :class="{price:isCustomizedType}"
                                                    @click="editPrice(lane, i)"
                                                    v-show="currentLane!=lane"
                                                    title="点击修改价格">¥{{lane.goods_price}}元</span>
                                        </td>
                                        <td>
                                            <template v-if="isCustomizedType">
                                                <input type="number" class="form-control goods"
                                                       :name="'capacities[' + i + ']'"
                                                       v-model="lane.capacity"
                                                       :step="config.is_fueling_device ? '0.01':'1'"
                                                       min="0">
                                                <input type="hidden" :name="'goods['+i+']'" :value="lane.goods_id">
                                            </template>
                                            <template v-else>
                                                {{lane.capacity}}
                                            </template>
                                        <td>
                                            <input type="number" class="form-control goods"
                                                   :name="'lane' + i + '_num'" v-model="lane.num"
                                                   min="0"
                                                   :step="config.is_fueling_device ? '0.01':'1'"
                                                   :max="lane.capacity ? lane.capacity : ''">
                                        </td>
                                        <td class="operate">
                                            <i class="fa fa-gift"
                                               v-if="currentPackage"
                                               :class="{disabled: lane.goods_id===0,flash:currentPackage}"
                                               title="加入套餐"
                                               @click="addPackage(lane)"></i>
                                            <i class="fa fa-trash" title="删除"
                                               @click="removeLane(lane)" v-if="isCustomizedType && !currentPackage"></i>
                                        </td>
                                    </tr>
                                    <tr v-if="isCustomizedType">
                                        <td class="operate">
                                            <i class="fa fa-plus" title="添加货道"  @click.prevent="addCargoLane" :disabled="loading"></i>
                                        </td>
                                        <td colspan="5">
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                                <div v-if="isPackageGoodsEnabled">
                                    <button class="btn btn-success"
                                            @click.prevent="newPackage"
                                            :disabled="loading"
                                            v-if="!currentPackage">
                                        <i class="fa fa-gift"></i> 创建套餐
                                    </button>
                                    <button class="btn btn-danger"
                                            @click.prevent="createPackage"
                                            :disabled="loading || currentPackage.list.length === 0"
                                            v-if="currentPackage"
                                    >
                                        <i class="fa fa-save"></i> 保存套餐
                                    </button>
                                </div>
                                <div class="package operate" v-if="currentPackage">
                                    <i class="fa fa-ban close-btn" title="退出" @click="closePackage"></i>
                                    <table class="table cargo_lanes">
                                        <thead>
                                        <th>#</th>
                                        <th>商品名称</th>
                                        <th class="fixed">单价</th>
                                        <th class="fixed">数量</th>
                                        <th style="width: 60px;">操作</th>
                                        </thead>
                                        <tbody>
                                        <tr v-for="(goods,index) in currentPackage.list">
                                            <td>
                                                {{index +1}}
                                            </td>
                                            <td>
                                                {{goods.name}}<sup class="id" title="商品ID">{{goods.id}}</sup>
                                                <span v-if="goods.unit_title">({{goods.unit_title}})</span>
                                            </td>
                                            <td>
                                                <div v-show="goods.edit">
                                                    <input type="number" class="form-control goods"
                                                           v-model="goods.price"
                                                           ref="packageGoodsPrice"
                                                           @blur="editPackageGoodsPriceDone(goods,index)"
                                                           @keydown.enter.self.prevent="editPackageGoodsPriceDone(goods,index)"
                                                           step="0.01"
                                                           min="0">
                                                </div>
                                                <span class="editable-price" @click="editPackageGoodsPrice(goods,index)" v-show="!goods.edit">
                                                        ¥{{goods.price}}元
                                                    </span>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control goods"
                                                       v-model="goods.num"
                                                       @blur="editPackageGoodsNumDone(goods, index)"
                                                       min="1">
                                            </td>
                                            <td class="operate">
                                                <i class="fa fa-trash" title="删除" @click="removeGoodsFromPackage(index)"></i>
                                            </td>
                                        </tr>
                                        <tr v-if="currentPackage.list.length === 0">
                                            <td colspan="5" class="center text-muted">
                                                &lt;请从设备商品列表中选择商品&gt;
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="5" style="text-align: left;">
                                                <div class="total-price">
                                                    <div>
                                                        <b>套餐名称：</b><input type="text" style="text-align: left;" class="form-control goods" v-model="currentPackage.title">
                                                    </div>
                                                    <div>
                                                        <b>商品总价：</b>
                                                        <span style="padding-left: 12px;">¥{{currentPackage.price}}元</span>
                                                    </div>
                                                </div>

                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div v-for="(p, index) in packages" class="package-list">
                                    <table class="table table-bordered cargo_lanes">
                                        <tbody>
                                        <tr>
                                            <td colspan="4" style="text-align: left;">
                                                <div>
                                                    <b>套餐名称：</b>{{p.title}}
                                                </div>
                                                <div>
                                                    <b>商品总价：</b>¥{{p.price}}元
                                                </div>
                                                <div class="package-delete operate">
                                                    <i class="fa fa-ban" :class="{disabled: loading}" title="删除" @click="removePackage(p,index)"></i>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr v-for="(goods,index) in p.list" :class="{invalid:!isPackageGoodsValid(goods)}">
                                            <td class="index">
                                                {{index +1}}
                                            </td>
                                            <td>
                                                {{goods.name}}<span class="text-muted" v-if="goods.deleted">&lt;已删除&gt;</span>
                                            </td>
                                            <td>
                                                ¥{{goods.price}}元
                                            </td>
                                            <td>
                                                {{goods.num}}
                                                <span v-if="goods.unit_title">({{goods.unit_title}})</span>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-show="active === 'egg'">
                    <div class="form-group">
                        <label for="adDeviceUID" class="col-md-2 control-label">广告设备UID</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="adDeviceUID" id="adDeviceUID" value="{php echo strval($extra['ad']['device']['uid'])}">
                            <span class="help-block">* 闪蛋广告设备UID，用于同步播放商品广告</span>
                        </div>
                    </div>
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="scname" class="col-md-2 control-label">领取周期</label>
                        <div class="col-md-10">
                            <select  class="form-control" name="scname" id="scname">
                                <option value="{php echo zovye\domain\Account::DAY}" {if $extra['limit']['scname'] == zovye\domain\Account::DAY}selected{/if}>每天</option>
                                <option value="{php echo zovye\domain\Account::WEEK}" {if $extra['limit']['scname'] == zovye\domain\Account::WEEK}selected{/if}>每周</option>
                                <option value="{php echo zovye\domain\Account::MONTH}" {if $extra['limit']['scname'] == zovye\domain\Account::MONTH}selected{/if}>每月</option>
                            </select>
                            <span class="help-block">* 每天/每周/每月可免费领取商品</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="count" class="col-md-2 control-label">一个周期内<br/><b>单个用户</b>可领取数量</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="count" id="count" value="{php echo $extra['limit']['count']??'0'}">
                            <span class="help-block">* 每个用户在这个设备上<b>每个周期</b>内最多可免费领取的商品总数，0表示不限制数量</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sccount" class="col-md-2 control-label">一个周期内<br/><b>全部用户</b>可领取总数</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="sccount" id="sccount" value="{php echo $extra['limit']['sccount']??'0'}">
                            <span class="help-block">* 全部用户在一个周期内可免费领取总数量的最大值，0表示不限制数量</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="total" class="col-md-2 control-label"><b>单个用户</b><br/>累计最多领取数量</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="total" id="total" value="{php echo $extra['limit']['total']??'0'}">
                            <span class="help-block">* 每个用户在这个设备上累计最多可领取的免费商品总数，0表示不限制数量</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="all" class="col-md-2 control-label"><b>所有用户</b><br/>累计最多领取总数</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="all" id="all" value="{php echo $extra['limit']['all']??'0'}">
                            <span class="help-block">* 所有用户在这个设备上可免费领取的商品总数，0表示不限制数量</span>
                        </div>
                    </div>
                </div>
                <div v-show="active === 'alert'" v-if="navExists('alert')">
                    <div class="seg" v-for="(lane, i) in currentType.cargo_lanes" :class="{unknown: lane.goods_id==0}" :key="currentTypeID+':'+i">
                        <div class="title">货道 {{i + 1}}</div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">当前商品</label>
                            <div class="col-md-10">
                                <label v-if="lane.goods_id">
                                    {{lane.goods_name}}<sup class="id" title="商品ID" v-if="lane.goods_id>0">{{lane.goods_id}}</sup>
                                </label>
                                <label v-else>
                                    <span class="text-muted">
                                        &lt;没有商品&gt;
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label :for="'alertExpiredAt['+i+']'" class="col-md-2 control-label">过期时间</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" placeholder="<未设置>" autocomplete="off"
                                       :id="'alertExpiredAt['+i+']'"
                                       :name="'alertExpiredAt['+i+']'"
                                       @click="showDatetimePicker(lane.alert, event, true, false)"
                                       v-model="lane.alert && lane.alert.expired_at">
                                <span class="help-block">* 该货道的商品过期时间</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label :for="'alertPreDays['+i+']'" class="col-md-2 control-label">提前预警（天）</label>
                            <div class="col-md-10">
                                <input type="number" class="form-control"
                                       :name="'alertPreDays['+i+']'"
                                       :id="'alertPreDays['+i+']'"
                                       v-model="lane.alert && lane.alert.pre_days"
                                >
                                <span class="help-block">* 提前多少天就显示提醒信息，0表示不提前提醒</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-12 col-md-2 col-md-2 control-label">过期处理</label>
                            <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                                <label :for="'alertInvalid['+i+']0'" class="radio-inline">
                                    <input :name="'alertInvalid['+i+']'" :id="'alertInvalid['+i+']0'" type="radio" value="1"
                                           v-model="lane.alert && lane.alert.invalid_if_expired">
                                    禁止购买
                                </label>
                                <label :for="'alertInvalid['+i+']1'" class="radio-inline">
                                    <input :name="'alertInvalid['+i+']'" :id="'alertInvalid['+i+']1'" type="radio" value="0"
                                           v-model="lane.alert && lane.alert.invalid_if_expired">
                                    允许购买
                                </label>
                                <span class="help-block">* 商品过期后，用户是否可以购买</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-show="active === 'extra'">
                    <!--
                        <div class="form-group">
                            <label for="pushAccountMsg" class="col-md-2 control-label">领取后推送公众号消息</label>
                            <div class="col-md-10">
                                <select id="pushAccountMsg" name="pushAccountMsg" class="col-md-9">
                                    <option value="none" {if 'none' == $extra['pushAccountMsg']}selected{/if}>&lt;不推送&gt;</option>
                                    <option value="settings" {if empty($extra['pushAccountMsg']) || 'settings' == $extra['pushAccountMsg']}selected{/if}>&lt;全局设置&gt;</option>
                                    {loop $news $item}
                                    <option value="{$item['media_id']}" {if $item['media_id'] ==$extra['pushAccountMsg']}selected{/if}>{$item['items']['0']['title']}</option>
                                    {/loop}
                                </select>
                                <span class="col-md-2"><a href="{php echo wurl('platform/material');}" class="btn btn-default" role="button">消息管理</a></span>
                            </div>
                        </div>
                    -->
                    <div class="form-group" v-if="config.is_normal_device || config.is_vdevice">
                        <label for="theme" class="col-md-2 control-label">手机端界面</label>
                        <div class="col-md-10">
                            <select name="theme" class="form-control" id="theme" v-model="theme.selected" @change="handleThemeChange">
                                <option value="" :selected="!theme.selected"> 系统默认界面 </option>
                                <option :value="item.name"
                                :selected="item.name==theme.selected"
                                v-for="item in theme.list" :key="item.name">
                                {{item.name}}
                                </option>
                            </select>
                            <span class="help-block" v-html="theme.helper"></span>
                        </div>
                    </div>
                    <div class="form-group"  v-if="isPackageGoodsEnabled">
                        <label for="group" class="col-md-2 control-label">商品列表</label>
                        <div class="col-md-10">
                            <select name="goodsList" id="group" style="width:100%;">
                                <option value="goods" {if $extra['goodsList'] == 'goods'}selected{/if}>只显示商品，不显示套餐</option>
                                <option value="packages" {if $extra['goodsList'] == 'packages'}selected{/if}>只显示套餐，不显示商品</option>
                                <option value="all" {if $extra['goodsList'] == 'all'}selected{/if}>商品和套餐都显示</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="group" class="col-md-2 control-label">分组</label>
                        <div class="col-md-10">
                            {if $groups}
                            <select name="group" id="group" style="width:100%;">
                                {loop $groups $index $group}
                                <option value="{$index}" {if $device && $device->getGroupId() == $index}selected{/if}>{$group['title']}</option>
                                {/loop}
                                <option value="0" {if empty($device) || ($device && $device->getGroupId() == 0)}selected{/if}>&lt;暂无分组&gt;</option>
                            </select>
                            {else}
                            <div style="color:#ccc;">&lt;暂无分组&gt;</div>
                            {/if}
                        </div>
                    </div>
                    <div class="form-group" v-if="config.is_normal_device || config.is_vdevice">
                        <label for="address" class="col-md-2 control-label">地址</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="address" id="address" value="{php echo strval($extra['address'])}">
                        </div>
                    </div>
                    <div class="form-group" v-if="config.is_normal_device || config.is_vdevice">
                        <label class="col-md-2 control-label">位置</label>
                        <div class="col-md-10">
                            {php echo tpl_form_field_coordinate('location', $loc);}
                            <span class="help-block">* {php echo empty($loc['address']) ? '暂无位置' : $loc['address']}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="hidden" class="form-control" name="tags" value="{php echo $device ? $device->getTagsAsText() : ''}">
                        <label for="tagslist" class="col-md-2 control-label">标签列表</label>
                        <div class="tag" id="tag_tpl" title="点击取消这个标签">
                            #{title}#
                        </div>
                        <div class="col-md-10" id="tagslist">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newtags" class="col-md-2 control-label"></label>
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="newtags" id="newtags" enter-key="#addTagBtn">
                            <span class="help-block">* 用英文逗号分隔可以同时添加多个标签！</span>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-default" type="button" id="addTagBtn" title="添加标签">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    {if \zovye\App::isMustFollowAccountEnabled()}
                    <div class="form-group" v-if="config.is_normal_device || config.is_vdevice">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">购买商品</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label for="mustFollow0" class="radio-inline">
                                <input name="mustFollow" id="mustFollow0" type="radio" value="1" {if $extra['mfa']['enable'] == 1}checked="checked"{/if} >
                                关注公众号后购买
                            </label>
                            <label for="mustFollow1" class="radio-inline">
                                <input name="mustFollow" id="mustFollow1" type="radio" value="0"  {if isset($extra['mfa']['enable']) && $extra['mfa']['enable'] == 0}checked="checked"{/if} >
                                直接购买
                            </label>
                            <label for="mustFollow2" class="radio-inline">
                                <input name="mustFollow" id="mustFollow2" type="radio" value="-1"  {if !isset($extra['mfa']['enable']) || $extra['mfa']['enable'] == -1}checked="checked"{/if} >
                                跟随系统设置
                            </label>
                            <span class="help-block">* 用户扫描设备二维码后，引导用户关注公众号后通过公众号进入商品购买页面</span>
                        </div>
                    </div>
                    {/if}
                    <!-- 目前默认门锁为 1，无需自定义门锁数量
                    {if \zovye\App::isDeviceWithDoorEnabled()}
                    <div class="form-group">
                        <label for="doorNum" class="col-md-2 control-label">门锁（数量）</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="doorNum" id="doorNum" value="{php echo $device ? $device->getDoorNum() : 0}" min="0">
                            <span class="help-block">* 指定设备门锁数量，默认为零</span>
                        </div>
                    </div>
                    {/if}
                    -->
                    <!--尿素加注机-->
                    <template v-if="config.is_fueling_device">
                        <div class="divider"></div>
                        <div class="form-group">
                            <label class="col-xs-12 col-md-2 col-md-2 control-label">运行模式</label>
                            <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                                <label for="solo0" class="radio-inline">
                                    <input name="solo" id="solo0" type="radio" value="0" {if empty($extra['solo'])}checked="checked"{/if} >
                                    单机
                                </label>
                                <label for="solo1" class="radio-inline">
                                    <input name="solo" id="solo1" type="radio" value="1"  {if $extra['solo'] == 1}checked="checked"{/if} >
                                    联网
                                </label>
                                <span class="help-block">* 是否启用单机模式</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pulse" class="col-md-2 control-label">流量系数</label>
                            <div class="col-md-10">
                                <input type="number" class="form-control" name="pulse" id="pulse" value="{php echo $device ? $device->getPulseValue() : 160}">
                                <span class="help-block">* 请输入流量系数值，默认160，范围0 - 300</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="timeout" class="col-md-2 control-label">超时时间（秒）</label>
                            <div class="col-md-10">
                                <input type="number" class="form-control" name="timeout" id="timeout" value="{php echo $device ? $device->getTimeout() : 120}">
                                <span class="help-block">* 流量计无流量超时时间，默认120秒</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">到期时间</label>
                            <div class="col-md-8">
                                <input type="text" name="expiration"
                                       value="{php echo $device ? $device->getExpiration() : ''}"
                                       placeholder="&lt;无限制&gt;" readonly="readonly" class="form-control"
                                       style="padding-left:12px;"
                                       @click="showDatetimePicker(ctrl.expiration, event)"
                                />
                                <span class="help-block">* 请输入设备到期时间</span>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-default" type="button" id="removeExpiration" title="清除时间">
                                    <i class="fa fa-ban"></i>
                                </button>
                            </div>
                        </div>
                        <div class="divider"></div>
                    </template>
                    <div class="form-group">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">设备状态</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label for="isDown0" class="radio-inline">
                                <input name="isDown" id="isDown0" type="radio" value="0" {if !isset($extra['isDown']) || $extra['isDown'] == 0}checked="checked"{/if} >
                                运行
                            </label>
                            <label for="isDown1" class="radio-inline">
                                <input name="isDown" id="isDown1" type="radio" value="1"  {if $extra['isDown'] == 1}checked="checked"{/if} >
                                停用
                            </label>
                            <span class="help-block">* 选择停用的设备，用户扫码后无法使用相关功能</span>
                        </div>
                    </div>
                </div>
                <div v-show="active === 'app'" v-if="deviceId > 0&& config.app">
                    <div class="form-group">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">动态二维码</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label for="activeQrcode1" class="radio-inline">
                                <input name="activeQrcode" id="activeQrcode1" type="radio" value="1" {if $extra['activeQrcode'] == 1}checked="checked"{/if} title="开启防刷功能后，二维码领取成功后动刷新！">
                                开启
                            </label>
                            <label for="activeQrcode0" class="radio-inline">
                                <input name="activeQrcode" id="activeQrcode0" type="radio" value="0"  {if $extra['activeQrcode'] == 0}checked="checked"{/if} >
                                关闭
                            </label>
                            <span class="help-block">* 开启此功能后，用户每次扫码领取成功后，二维码都会重新生成！</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="volume" class="col-md-2 control-label">音量(百分比)</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="volume" id="volume" value="{php echo intval($extra['volume'])}">
                        </div>
                    </div>
                </div>
                <div v-show="active === 'schedule'" v-if="navExists('schedule')">
                    <div class="form-group">
                        <label class="col-xs-12 col-md-2 col-md-2 control-label">是否启用</label>
                        <div class="col-md-8 col-md-8 col-lg-8 col-xs-12">
                            <label for="screenSchedule1" class="radio-inline">
                                <input name="screenSchedule" id="screenSchedule1" type="radio" value="1" {if $extra['schedule']['screen']['enabled'] == 1}checked="checked"{/if} title="开启防刷功能后，二维码领取成功后动刷新！">
                                启用
                            </label>
                            <label for="screenSchedule0" class="radio-inline">
                                <input name="screenSchedule" id="screenSchedule0" type="radio" value="0"  {if $extra['schedule']['screen']['enabled'] == 0}checked="checked"{/if} >
                                关闭
                            </label>
                            <span class="help-block">* 启用后，会在指定时间自动关闭屏幕或重启设备</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="start" class="col-md-2 control-label">重启时间</label>
                        <div class="col-md-4">
                            <input class="form-control"  type="text" name="start" id="start" value="{php echo $extra['schedule']['screen']['on'] ?? '00:00'}" @click="showDatetimePicker(ctrl.start, event, false, true)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="end" class="col-md-2 control-label">关闭时间</label>
                        <div class="col-md-4">
                            <input class="form-control" type="text" name="end" id="end" value="{php echo $extra['schedule']['screen']['off'] ?? '00:00'}" @click="showDatetimePicker(ctrl.end, event, false, true)">
                        </div>
                    </div>
                </div>
                <div v-show="active === 'zjb'" v-if="navExists('zjb')">
                    <div class="form-group">
                        <label for="ZJBao_Scene" class="col-md-2 control-label">场景</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" name="ZJBao_Scene" id="ZJBao_Scene" value="{php echo strval($zjbao['scene'])}">
                        </div>
                    </div>
                </div>
                <div v-show="active === 'moscale'" v-if="navExists('moscale')">
                    <div id="moscale">
                    </div>
                </div>
                <div v-show="active === 'zeroBonus'" v-if="navExists('zeroBonus')">
                    <div class="form-group">
                        <label for="zeroBonus" class="col-md-2 control-label">零佣金概率(%)</label>
                        <div class="col-md-10">
                            <input type="number" step="0.01" class="form-control" name="zeroBonus" id="zeroBonus" value="{php echo $extra['custom']['bonus']['zero']['v'] ?? -1}">
                            <span class="help-block">* -1 默认， 0 表示概率０</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-btn">
            <input type="hidden" name="op" value="save">
            <input type="hidden" name="from" :value="active">
            <input type="hidden" name="device_model" value="{$device_model}">
            <template v-if="deviceId > 0">
                <input type="hidden" name="id" :value="deviceId">
                <button type="submit" class="btn btn-primary">保存</button>
            </template>
            <template v-else>
                <button type="submit" class="btn btn-primary">创建</button>
            </template>
            <button type="button" class="btn btn-default" onclick="backToList();">返回</button>
        </div>
    </form>
</div>

<script>
    const api = {
        url: "{php echo $this->createWebUrl('goods');}",
        dlg: null,
    }

    api.showResult = function (params, url, loading, cb) {
        loading && util.loading();
        $.getJSON(url || api.url, params).done(function (res) {
            loading && util.loaded();
            if (res) {
                if (typeof cb == 'function') {
                    if (cb(res)) {
                        return;
                    }
                }
                if (res.status) {
                    if (res.data && res.data.content) {
                        api.dlg = util.dialog(res.data.title || '', res.data.content);
                        api.dlg.modal('show');
                    }
                }
                if (res.message && res.type) {
                    util.message(res.message, '', res.type);
                }
                if (res.data && res.data.msg) {
                    util.message(res.data.msg, '', res.status ? 'success' : 'error');
                }
            }
        }).fail(function () {
            loading && util.loaded();
        })
    }

    api.hide = function () {
        if (api.dlg) {
            api.dlg.modal('hide');
        }
    }

    api.chooseGoods = function (params) {
        api.showResult({ pagesize: 10, ...params });
    }

    require(['jquery', '{php \zovye\url(false, JS_VUE_URL);}', 'datetimepicker'], function ($, Vue, datetimepicker) {
        const api_url = "{php echo $this->createWebUrl('devicetypes');}";
        const device_api_url = "{php echo $this->createWebUrl('device')}";
        const package_api_url = "{php echo $this->createWebUrl('package')}";
        const app = new Vue({
            el: "#app",
            data: {
                deviceId: parseInt("{php echo $device? $device->getId() : 0}"),
                currentTypeID: parseInt("{php echo $device? $device->getDeviceType() : 0}"),
                keywords: '',
                list: [],
                currentType: {
                    cargo_lanes: [],
                },
                error: '',
                currentLane: null,
                changing: false,
                searching: false,
                creating: false,
                packages: [],
                currentPackage: null,
                ctrl: {
                    start: { initilized: false },
                    end: { initilized: false },
                    expiration: { initilized: false },
                },
                bluetooth: {
                    list: JSON.parse(`{php echo json_encode($bluetooth['protocols'])}`),
                    current: `{$bluetooth['protocol']}`,
                },
                config: {
                    goods_package_enabled: `{php echo \zovye\App::isGoodsPackageEnabled()? 1 : ''}`,
                    expire_alert_enabled: `{php echo \zovye\App::isGoodsExpireAlertEnabled()? 1 : ''}`,
                    is_normal_device: `{php echo $is_normal_device? 1 :''}`,
                    is_bluetooth_device: `{php echo $is_bluetooth_device? 1 :''}`,
                    is_vdevice: `{php echo $is_vdevice? 1 :''}`,
                    is_charging_device: `{php echo $is_charging_device? 1 :''}`,
                    is_fueling_device: `{php echo $is_fueling_device? 1 :''}`,
                    app: `{php echo $app? 1 :''}`,
                    flash_egg_enabled: `{php echo \zovye\App::isFlashEggEnabled()? 1 : ''}`,
                    zero_bonus_enabled: `{php echo \zovye\App::isZeroBonusEnabled()? 1 : ''}`,
                    moscale_enabled: `{php echo $moscale ? 1 : ''}`,
                    zjb_enabled: `{php echo $zjb ? 1 : ''}`,
                },
                navs: [
                    {
                        'op': 'base',
                        'content': `{$icon} 基本设置`,
                    },
                    {
                        'op': 'egg',
                        'content': `闪蛋设置`,
                    },
                    {
                        'op': 'app',
                        'content': `APP设置`,
                    },
                    {
                        'op': 'schedule',
                        'content': `定时任务`,
                    },
                    {
                        'op': 'alert',
                        'content': `过期设置`,
                    },
                    {
                        'op': 'extra',
                        'content': `高级设置`,
                    },
                    {
                        'op': 'moscale',
                        'content': `公锤平台设置`,
                    },
                    {
                        'op': 'zjb',
                        'content': `纸巾平台宝设置`,
                    },
                    {
                        'op': 'zeroBonus',
                        'content': `零佣金`,
                    },
                ],
                active: '{$from}',
                theme: {
                    selected: `{$extra['theme']}`,
                    helper: '',
                    list: JSON.parse(`{php echo json_encode($themes)}`),
                },
            },
            watch: {
                currentTypeID() {
                    this.change();
                },
                currentType(e) {
                    if (!e || e.id === 0) {
                        this.addCargoLane();
                    } else {
                        if (e && (!e.cargo_lanes || e.cargo_lanes.length === 0)) {
                            this.addCargoLane();
                        }
                    }
                },
            },
            computed: {
                isCustomizedType() {
                    return this.currentTypeID === 0 || this.currentTypeID === '0';
                },
                packageGoods() {
                    return (this.currentType.cargo_lanes || []).filter(lane => {
                        return !!lane.packing;
                    })
                },
                isPackageGoodsEnabled() {
                    return this.config.goods_package_enabled && !this.config.is_bluetooth_device && !this.config.is_fueling_device;
                },
                loading() {
                    return this.changing || this.searching || this.creating;
                }
            },
            created() {
                if (this.deviceId === 0) {
                    const nav = this.navs.shift();
                    this.navs = [];
                    this.navs.push(nav);
                } else {
                    let ops_removed = [];
                    if (!this.config.expire_alert_enabled ||
                        this.config.is_charging_device ||
                        this.config.is_fueling_device) {
                        ops_removed.push('alert');
                    }
                    if (!this.config.app) {
                        ops_removed.push('app', 'schedule');
                    }
                    if (!this.config.moscale_enabled) {
                        ops_removed.push('moscale');
                    }
                    if (!this.config.zjb_enabled) {
                        ops_removed.push('zjb');
                    }
                    if (!this.config.zero_bonus_enabled) {
                        ops_removed.push('zeroBonus');
                    }
                    if (!this.config.flash_egg_enabled || !this.config.is_normal_device) {
                        ops_removed.push('egg');
                    }
                    this.navs = this.navs.filter(nav => nav && ops_removed.indexOf(nav.op) === -1);
                }
            },
            mounted() {
                if (this.deviceId > 0) {
                    this.change(true);
                } else {
                    this.search();
                    this.addCargoLane();
                }
                if (this.config.goods_package_enabled) {
                    $.getJSON(package_api_url, { op: 'list', device: this.deviceId }).then(res => {
                        if (res && res.status) {
                            this.packages = res.data;
                        }
                    })
                }

                this.handleThemeChange();

                initLegacyJs();
            },

            methods: {
                navExists(op) {
                    return this.navs.findIndex(nav => nav.op == op) !== -1;
                },

                handleThemeChange() {
                    const item = this.theme.list.find(e => e.name === this.theme.selected);
                    this.theme.helper = item && (item.helper || '');
                },

                search() {
                    const self = this;
                    self.searching = true;
                    $.getJSON(api_url, { keywords: self.keywords, op: 'search' }).then(function (res) {
                        if (res) {
                            if (res.status) {
                                self.list = res.data.list || [];
                            } else {
                                self.list = [];
                                self.error = res.data.msg || '&lt;出错了&gt;';
                            }
                        }
                        if (self.list.length === 0) {
                            self.currentType = {};
                            self.currentTypeID = 0;
                        }
                        self.searching = false;
                    })
                },
                change(first = false) {
                    const self = this;
                    self.changing = true;
                    $.getJSON(device_api_url, { op: 'get_lane_detail', deviceid: this.deviceId, typeid: this.currentTypeID }).then(res => {
                        if (res) {
                            if (res.status) {
                                self.currentType = res.data;
                                if (first && !self.isCustomizedType) {
                                    self.list.push(res.data);
                                }
                            } else {
                                self.currentType = {};
                                self.error = res.data.msg || '&lt;出错了&gt;';
                            }
                        }
                        self.changing = false;
                    })
                },
                isPackageGoodsValid(goods) {
                    if (this.currentType && this.currentType.cargo_lanes) {
                        return this.currentType.cargo_lanes.findIndex(e => e.goods_id == goods.goods_id) !== -1;
                    }
                    return false;
                },
                addCargoLane() {
                    if (this.isCustomizedType) {
                        if (!this.currentType.cargo_lanes) {
                            Vue.set(this.currentType, 'cargo_lanes', []);
                        }
                        this.currentType.cargo_lanes.push({
                            id: 0,
                            num: 0,
                            capacity: 0,
                            goods_id: 0,
                            goods_name: '<请选择商品>',
                            goods_price: '0.00',
                            alert: {},
                        })
                    }
                },
                removeLane(lane) {
                    const i = this.currentType.cargo_lanes.findIndex(e => e === lane);
                    if (i !== -1) {
                        this.currentType.cargo_lanes.splice(i, 1);
                    }
                    if (this.currentType.cargo_lanes.length == 0) {
                        this.addCargoLane();
                    }
                },
                newPackage() {
                    Vue.set(this, 'currentPackage', {
                        list: [],
                        title: '套餐' + (this.packages.length + 1),
                        price: 0,
                    });
                },
                closePackage() {
                    this.currentPackage = null;
                },
                createPackage() {
                    if (!this.loading && this.currentPackage && this.currentPackage.list.length > 0) {
                        const params = Object.assign({}, this.currentPackage);
                        params.op = "create";
                        params.deviceId = this.deviceId;
                        this.creating = true;
                        $.post(package_api_url, params).then(res => {
                            if (res && res.status) {
                                $.getJSON(package_api_url, { op: 'detail', id: res.data.id }).then(res => {
                                    if (res && res.status) {
                                        this.packages.push(res.data);
                                        this.currentPackage = null;
                                    }
                                    this.creating = false;
                                })
                            } else {
                                this.creating = false;
                                if (res && res.data && res.data.msg) {
                                    util.message(res.data.msg, '', 'error');
                                }
                            }
                        })
                    }
                },
                addPackage(lane) {
                    if (!this.currentPackage) {
                        this.newPackage();
                    }
                    if (lane.goods_id > 0) {
                        this.currentPackage.list.push({
                            id: lane.goods_id,
                            name: lane.goods_name,
                            price: lane.goods_price,
                            num: 1,
                            unit_title: lane.goods_unit_title,
                        })
                        this.calcPackageGoodsTotal(this.currentPackage);
                    }
                },
                removePackage(p, index) {
                    if (p && p.id && !this.loading && confirm('确定要删除这个套餐吗？')) {
                        $.getJSON(package_api_url, { op: 'remove', id: p.id }).then(res => {
                            if (res && res.status) {
                                this.packages.splice(index, 1);
                            }
                        })
                    }
                },
                removeGoodsFromPackage(index) {
                    if (this.currentPackage) {
                        this.currentPackage.list.splice(index, 1);
                        this.calcPackageGoodsTotal(this.currentPackage);
                    }
                },
                calcPackageGoodsTotal(p) {
                    p.price = 0;
                    p.list.forEach(e => {
                        p.price += e.price * e.num;
                    })
                    p.price = p.price.toFixed(2);
                },
                chooseGoods(lane) {
                    if (this.isCustomizedType) {
                        this.currentLane = lane;
                        api.chooseGoods(this.config.is_fueling_device ? { types: ['fueling'] } : {});
                    }
                },
                setGoods(goods) {
                    if (this.currentLane) {
                        api.hide();
                        this.currentLane.goods_id = goods.id;
                        this.currentLane.goods_name = goods.name;
                        this.currentLane.goods_unit_title = goods.unit_title;
                        this.currentLane.goods_price = goods.price;
                        this.editPriceDone(this.currentLane);
                    }
                },
                editPrice(lane, index) {
                    if (this.isCustomizedType) {
                        this.currentLane = lane;
                        this.$nextTick(() => {
                            this.$refs.price[index].focus();
                        })
                    }
                },
                editPriceDone(lane) {
                    this.currentLane = null;
                    lane.goods_price = parseFloat(lane.goods_price).toFixed(2);
                },
                editPackageGoodsPrice(goods, index) {
                    Vue.set(goods, 'edit', true);
                    this.$nextTick(() => {
                        this.$refs.packageGoodsPrice[index].focus();
                    })
                },
                editPackageGoodsPriceDone(goods, index) {
                    goods.edit = false;
                    goods.price = parseFloat(goods.price).toFixed(2);
                    this.calcPackageGoodsTotal(this.currentPackage);
                },
                editPackageGoodsNumDone(goods, index) {
                    this.calcPackageGoodsTotal(this.currentPackage);
                },
                showDatetimePicker(o, e, datepicker = true, timepicker = false) {
                    if (o && !o.initilized) {
                        Vue.set(o, "datetimepicker", true);
                        let format = '';
                        if (datepicker) {
                            format = 'Y-m-d';
                        }
                        if (timepicker) {
                            format = format ? format + ' H:i' : 'H:i';
                        }
                        $(e.target).datetimepicker({
                            lang: "zh",
                            step: 5,
                            datepicker: datepicker,
                            timepicker: timepicker,
                            closeOnDateSelect: timepicker ? false : true,
                            format: format,
                            onChangeDateTime: (dp, $input) => {
                                Vue.set(o, 'expired_at', $input.val());
                            }
                        });
                        $(e.target).datetimepicker('show');

                    }
                }
            }
        })

        $(function () {
            $('body').on('click', '#goodslist tr:not(.disabled)[data-goods] .name', function (e) {
                const tr = $(e.currentTarget).closest('tr');
                const id = tr.data('goods');
                const name = tr.data('name');
                const unit_title = tr.data('title');
                const price = tr.data('price');
                if (id) {
                    app.setGoods({ id, name, unit_title, price });
                }
            })
        })
    })

    function backToList() {
        setTimeout(function () {
            util.loading();
        }, 1000);
        const page = localStorage.getItem('device_list.page') || 1;
        window.location.href = "{php echo $this->createWebUrl('device', ['page' => '__page__']);}".replace('__page__', page);
    }

    function renderTags(tags) {
        const tpl = $('#tag_tpl').clone().removeAttr('id').prop('outerHTML');
        let html = '';
        tags.forEach(function (title) {
            html += tpl.replace(/#{title}#/g, title);
        })
        $('#tagslist').html(html || '<span style="color:gray;">&lt;暂无标签&gt;</span>');
        $('input[name=tags]').val(tags.join(','));
    }

    const moscale_enabled = "{php echo $moscale ? 1 : ''}";
    const vuejsUrl = "{php \zovye\url(false, JS_VUE_URL);}";

    function initLegacyJs() {
        if (moscale_enabled) {
            require(["{php echo MODULE_URL}static/js/moscale.min.js?v=20210417"], function (moscale) {
                moscale.init("#moscale", {
                    moscaleMachineKey: "{$moscale['MachineKey']}",
                    label: JSON.parse(`{php echo json_encode($moscale['LabelList']);}`),
                    savedLabel: JSON.parse(`{php echo json_encode($moscale['AreaListSaved']);}`),
                    region: JSON.parse(`{php echo json_encode($moscale['RegionData']);}`),
                    savedRegion: JSON.parse(`{php echo json_encode($moscale['RegionSaved']);}`),
                })
            })
        }

        let tags = [];
        $('input[name=tags]').val().split(',').forEach(function (title) {
            if (title !== "") {
                tags.push(title);
            }
        })
        renderTags(tags);

        $('#addTagBtn').click(function () {
            const titles = $('input[name=newtags]').val().split(',');
            titles.forEach(function (title) {
                title = $.trim(title);
                if (title !== "" && tags.indexOf(title) === -1) {
                    tags.push(title);
                }
            })
            $('input[name=newtags]').val('');
            renderTags(tags);
        })

        $('#removeExpiration').click(function () {
            $('input[name=expiration]').val('');
        })

        $('#tagslist').on('click', '.tag', function () {
            const title = $(this).text().trim();
            tags = tags.filter(function (e) {
                return e !== title;
            })
            renderTags(tags);
        })

        $('[enter-key]').bind("keypress", function (e) {
            if (e.keyCode === 13) {
                const target = $(this).attr('enter-key');
                $(target).click();
                e.preventDefault();
            }
        })

        const ownerId = parseInt("{php echo $agent?$agent->getId() : 0}", 10);
        $('#find_agent').click(function () {
            const keyword = $('input[name=keyword_agent]').val();
            let complete = false;
            setTimeout(function () {
                if (!complete) {
                    util.loading();
                }
            }, 1000)
            $.get("{php echo $this->createWebUrl('agent');}", { op: 'search', keyword: keyword }, function (res) {
                let html = '';
                if (res.status) {
                    const list = res.data || [];
                    list.forEach(function (e) {
                        html += '<option value="_1*" _**!_>_2*，手机号码：_3*</option>'
                            .replace('_1*', e.id)
                            .replace('_2*', e.name)
                            .replace('_3*', e.mobile)
                            .replace('_**!_', e.id === ownerId ? 'selected' : '');
                    })
                }
                html += '<option value="0"><无></option>';
                $('#select_agent').html(html);

            }, 'json').complete(function () {
                complete = true;
                util.loaded();
            })
        })

        $('#special input[name=spec]').click(function () {
            $('#special fieldset').attr('disabled', !$(this).is(':checked'));
        })
    }
</script>
<!-- 以下js用于商品搜索对话框 -->
<script>
    let backer = "";
    let agentId = "";
    $(function () {
        function reload(url) {
            api.showResult({}, url);
        }

        $('body').on('click', '#search-bar', function () {
            $(this).hide();
            $('#search-form').show();
            $('input[name=s_keywords]').focus();
        })

        $('body').on('click', '#search-form .btn-close', function (e) {
            if (backer) {
                api.chooseGoods();
            } else {
                $('#search-form').hide();
                $('#search-bar').show();
            }
            e.preventDefault();
        })

        $('body').on('click', '#search_agent', function () {
            const keyword = $('#search-form input[name=keyword_agent]').val();
            $.get("{php echo $this->createWebUrl('agent');}", {
                op: 'search',
                keyword: keyword,
            }, function (res) {
                let html = '';
                if (res.status) {
                    const list = res.data || [];
                    list.forEach(function (e) {
                        html += '<option value="_1*" _4*>_2*，手机号码：_3*</option>'
                            .replace('_1*', e.id)
                            .replace('_2*', e.name)
                            .replace('_3*', e.mobile)
                            .replace('_4*', '');
                    })
                }

                html += '<option value=""><不限></option><option value="-1"><平台></option>';
                $('#agent_search_result').html(html);

            }, 'json');
        })

        function reloadPageWithFilter(fn) {
            const params = new URLSearchParams();

            const form = $("#search-form form");
            const s_keywords = $.trim(form.find('input[name=s_keywords]').val());
            if (s_keywords) {
                params.append("keywords", s_keywords);
            }

            const agentId = $.trim(form.find('select[name=agentId]').val());
            if (agentId !== '') {
                params.append("agentId", agentId);
            }

            if (typeof fn === 'function') {
                fn(params);
            }

            params.append("pagesize", 10);

            reload(form.attr("action") + "&" + encodeURI(params.toString()));
        }

        $('body').on('submit', "#search-form form", function (e) {
            reloadPageWithFilter();
            e.preventDefault();
        })

        $('body').on('click', 'a[filter]', function (e) {
            const self = this;
            reloadPageWithFilter(function (params) {
                const name = $(self).data('name');
                const val = $(self).data('val');
                if (name) {
                    params.set(name, val);
                }
            });
            e.preventDefault();
        })

        $('body').on('click', '.pagination li:not(.active) a', function (e) {
            e.preventDefault();
            const url = $(this).attr("href");
            reload(url);
        })
    })
</script>
{template 'common/footer'}
