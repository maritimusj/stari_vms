{template 'common/header'}
{php \zovye\url(true, 'static/css/common.css?v=20201108');}
<style>
    #special2 fieldset[disabled] label, #special2 fieldset[disabled] input, #special2 fieldset[disabled] table{
        color: gray;
    }
    #special2 fieldset[disabled] #prizelist .operate i {
        cursor: default;
    }
    #special2 fieldset[disabled] #prizelist .operate i:hover,#special2 fieldset[disabled] #prizelist tr:hover .operate i{
        color: #ccc;
        text-shadow: none;
    }
    #prizelist .prize{
        color: #fff;
        border: 1px solid #ccc;
        padding: 3px 10px;
        background-color: #ccc;
        font-size: 10px;
        border-radius: 15px;
        box-shadow: 1px 1px 0 2px rgba(0, 0, 0, 0.1);
    }
    fieldset[disabled] #prizelist .prize:not(.disabled).voucher,
    fieldset[disabled] #prizelist .prize:not(.disabled).coupon,
    fieldset[disabled] #prizelist .prize:not(.disabled).other {
        background-color: #ddd;
        border-color: #eee;        
    }
    fieldset[disabled] #prizelist tr span.x {
        background-color: #ddd;
    }
    fieldset[disabled] #prizelist .invalid{
        color:#f1d5d3;
    }
    #prizelist .prize:not(.disabled).voucher{
        background-color: #428bca;
        border-color: #357ebd;
    }
    #prizelist .prize:not(.disabled).coupon{
        background-color: #5cb85c;
        border-color: #4cae4c;
    }
    #prizelist .prize:not(.disabled).other{
        background-color: #f0ad4e;
        border-color: #eea236;
    }
    #prizelist small{
        color:gray;
    }
    #prizelist tr[disabled] .spec small{
        color: #ddd;
    }
    .modal-open #material-Modal{
        z-index: 9999;
    }
    .we7-modal-dialog .modal-body{
        max-height: 1000px;
    }
    #prizelist td {
        vertical-align: middle;
    }
    #prizelist .spec div {
        margin: 1em auto;
    }
    #prizelist .invalid{
        color: #F44336;
        font-size: small;
    }
    #prizelist tr[disabled],#prizelist tr[disabled] .invalid {
        color: #ccc;
    }
    #prizelist tr[disabled] span.x{
        background-color: #ddd;
    }
    #prizelist td.spec div{
        margin-bottom: 6px;
    }
    #prizelist span.x {
        color: #fff;
        background-color: #607D8B;
        border-radius: 15px 0 0 15px;
        padding: 3px 6px;
        margin: 3px 6px 3px 0;
        font-size: small;
    }
    #special .fa-copy {
        overflow: hidden;
    }
</style>
{template "web/settings/nav"}
<form action="{php echo $this->createWebUrl('settings');}" method="post">
    <div class="panel panel-default nav-tab-item">
        <div class="panel-body">
            {if \zovye\App::isIDCardVerifySupported()}
            <div class="seg">
                <div class="title">实名认证</div>
                <div class="form-group">
                    <label for="userVerify" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" name="userVerify" id="userVerify" value="1" {if $settings['user']['verify']['enabled']}checked{/if}>
                            启用实名认证，只允许通过实名认证的用户购买商品
                          </label>
                        </div>
                    </div>
                </div>
                {if \zovye\App::isIDCardVerifyEnabled()}
                <div class="form-group">
                    <label for="maxtimes" class="col-md-2 control-label">用户次数限制</label>
                    <div class="col-md-10">
                        <input type="number" class="form-control" name="maxtimes" id="maxtimes" value="{$settings['user']['verify']['maxtimes']}" min="0" step="1">
                        <span class="help-block">* 每个用户每天最多可以尝试认证次数。</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="balance_free" class="col-md-2 control-label">实名查询可用次数{if $idcard_balance < 50} <i class="fa fa-info-circle" style="color:#F44336;" title="如果可用次数为零，用户将无法购买商品！"></i>{/if}</label>
                    <div class="col-md-10">
                        <span class="form-control " style="overflow:hidden;">{$idcard_balance}</span>
                    </div>
                </div> 
                {/if}
            </div>
            {/if}
            <div class="seg" id="special">
                <div class="title">会员中心</div>
                <div class="form-group">
                    <label for="usercenter" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" name="usercenter" id="usercenter" value="1" {if $settings['user']['center']['enabled']}checked{/if}>
                            开启会员中心
                          </label>
                        </div>
                    </div>
                </div>
                <fieldset {if empty($settings['user']['center']['enabled'])}disabled{/if}>
                    <div class="form-group">
                        <label for="balance_title" class="col-md-2 control-label">余额名称</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="balance_title" id="balance_title" value="{$settings['user']['balance']['title']}">
                            <span class="help-block">* 默认为：{php echo DEFAULT_BALANCE_TITLE}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="balance_unit" class="col-md-2 control-label">余额单位</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="balance_unit" id="balance_unit" value="{$settings['user']['balance']['unit']}">
                            <span class="help-block">* 默认单位为：{php echo DEFAULT_BALANCE_UNIT_NAME}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="balance_price" class="col-md-2 control-label">余额单位价格（元）</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="balance_price" id="balance_price" value="{$settings['user']['balance']['price']}" min="0" step="0.01">
                            <span class="help-block">* 用户充值时一单位余额对应的价格</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="balance_free" class="col-md-2 control-label">用户每月免费额度</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="balance_free" id="balance_free" value="{$settings['user']['balance']['free']}" min="0" step="1">
                            <span class="help-block">* 用户额度不足时，自动补赠到此额度</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label">余额订单</label>
                        <div class="col-md-10">
                            <select name="balance_type" style="width:100%;"> 
                                <option value="free"{if $settings['user']['balance']['type']=='free'} selected{/if}> 免费订单 </option>
                                <option value="fee"{if $settings['user']['balance']['type']=='pay'} selected{/if}> 收费订单 </option>
                            </select>
                            <span class="help-block">* 余额产生的订单，被认为是免费还是收费？（用户每日免费额度受这个参数影响）</span>
                        </div>
                    </div>
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <label for="balance_free" class="col-md-2 control-label">会员中心网址</label>
                        <div class="col-md-10">
                            <span class="form-control operate" style="overflow:hidden;"><i class="fa fa-paste" title="复制网址" data-url="{$usercenter_url}"></i> {$usercenter_url}</span>
                        </div>
                    </div>                    
                </fieldset>
            </div>
            <div class="seg">
                <div class="title">认证18+</div>
                <div class="form-group">
                    <label for="userVerify" class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="userVerify18" id="userVerify18" value="1" {if $settings['user']['verify18']['enabled']}checked{/if}>
                                启用实名认证，只允许通过实名认证的用户购买商品
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userVerify18Title" class="col-md-2 control-label">18+标题</label>
                    <div class="col-md-10">
                        <input type="text" class="form-control" name="userVerify18Title" id="userVerify18Title" value="{$settings['user']['verify18']['Title']}">
                    </div>
                </div>
            </div>
            {if $settings['user']['center']['enabled']}
            <div class="seg" id="special2">
                <div class="title" name="daliyprize">每日抽奖</div>
                <div class="form-group">
                    <label class="col-md-2 control-label">是否启用</label>
                    <div class="col-md-10">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" name="userprize" value="1" {if $settings['user']['prize']['enabled']}checked{/if}>
                            开启每日抽奖
                          </label>
                        </div>
                    </div>
                </div>
                <fieldset {if empty($settings['user']['prize']['enabled'])}disabled{/if}>
                    <div class="form-group">
                        <label for="maxTimes" class="col-md-2 control-label">每日可抽奖次数</label>
                        <div class="col-md-10">
                            <input type="number" class="form-control" name="maxTimes" id="maxTimes" value="{php echo $settings['user']['prize']['maxtimes']?:1}" min="1" step="1">
                            <span class="help-block">* 每个用户每天最多可以抽奖次数</span>
                        </div>
                    </div>
                    <div class="seg-divider"></div>
                    <div class="form-group">
                        <div class="col-md-12">
                            {if $prizeEntries}
                            <table class="table" id="prizelist">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>奖品</th>
                                        <th style="min-width:20em;">说明</th>
                                        <th style="min-width:6em;">已中奖</th>
                                        <th style="min-width:12em;">创建时间</th>
                                        <th style="min-width:5em;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {loop $prizeEntries $index $item}
                                <tr data-id="{$item['id']}"{if !$item['enabled']} disabled{/if}>
                                    <td>{php echo $index + 1}</td>
                                    <td>
                                        <div> {$item['title']}</div>
                                        <div class="invalid">
                                            {if $item['pv'] == 0}
                                            (已失效{if $item['invalid']}，{$item['invalid']}{/if})
                                            {/if}
                                        </div>
                                    </td>
                                    <td class="spec">
                                        <span class="prize {$item['name']}{if !$item['enabled']} disabled{/if}">
                                            {php echo $prizes[$item['name']]?$prizes[$item['name']]->desc()['title']:'未知';}
                                        </span>
                                        <div class="percent">
                                            <span class="x">中奖机率</span><span>{$item['percent']}％</span>
                                            {if $item['pv'] != $item['percent']}
                                            （<small>实际机率 ≈ {$item['pv']}％</small>）
                                            {/if}
                                        </div>
                                        {if $item['extra']['maxcount']}
                                        <div class="maxcount">
                                            <span class="x">最大数量</span><span>{$item['extra']['maxcount']}个</span>
                                        </div>
                                        {/if}
                                        {if $item['extra']['validdate']}
                                        <div class="validdate">
                                            <span class="x">有效时间</span><span>{$item['extra']['begin']} 至 {$item['extra']['end']}</span>
                                        </div>
                                        {/if}
                                    </td>
                                    <td>
                                        <span class="total">{$item['total']}个</span>
                                    </td>
                                    <td>{$item['createtime']}</td>
                                    <td class="operate">
                                        <i class="fa fa-edit" title="编辑..." data-op='editPrize' data-id="{$item['id']}" data-type="{$item['name']}"></i>
                                        <i class="fa fa-ban" title="禁用/启用" data-op='banPrize' data-id="{$item['id']}"></i>
                                        <i class="fa fa-trash-o" title="删除?"></i>
                                    </td>
                                </tr>
                                {/loop}                                   
                                </tbody>
                            </table>
                            {else}
                            <span class="help-block">提示：暂时还没有任何奖品，点击以下按钮添加...</span>
                            {/if}
                          </div>
                    </div>  
                    <div class="form-group">
                        <div class="col-md-12" id="prizes">
                            <button type="button" class="btn btn-primary" data-op="newPrize" data-type="voucher"><i class="fa fa-ticket"></i> {php echo $settings['user']['balance']['title']?:'点券'}</button>
                            <button type="button" class="btn btn-success" data-op="newPrize" data-type="coupon"><i class="fa fa-tags"></i> 代金券</button>
                            <button type="button" class="btn btn-warning" data-op="newPrize" data-type="other"><i class="fa fa-gift"></i> 其它奖励</button>
                        </div>
                    </div>
                </fieldset>
            </div>
            {/if}
        </div>
    </div>
    <div class="form-btn">
        <input type="hidden" name="save_type" value="user">
        <input type="hidden" name="op" value="save">
        <button type="submit" class="btn btn-primary">保存</button>
    </div>
</form>
<script>
    const api = {
        url: "{php echo $this->createWebUrl('settings');}",    
    }
    
    api.showResult = function(params, url, loading, cb) {
        loading && util.loading();
        $.getJSON(url || api.url, params).done(function(res){
            loading && util.loaded();
            if(res) {
                if(typeof cb === 'function') {
                    if(cb(res)) {
                        return;
                    }
                }
                if(res.status) {
                    if(res.data && res.data.content) {
                        const dlg = util.dialog(res.data.title || '', res.data.content);
                        dlg.modal('show');
                    }
                }
                if(res.message && res.type) {
                    util.message(res.message, '', res.type);
                }
                if(res.data && res.data.msg) {
                    util.message(res.data.msg, '', res.status ? 'success' : 'error');
                }
            }
        }).fail(function(){
            loading && util.loaded();
        })
    }
    
    api.voucher = function(id) {
        console.log(id);
        api.showResult({op: 'addPrize', type: 'voucher', id: id});
    }
    
    api.coupon = function(id) {
        api.showResult({op: 'addPrize', type: 'coupon', id: id});
    }
    
    api.other = function(id) {
        api.showResult({op: 'addPrize', type: 'other', id: id});
    }
    
    api.banPrize = function(e) {
        const id = e ? e.data('id') : 0;
        api.showResult({op: 'banPrize', id: id}, null, false, function(res) {
            const tr = e.closest('tr');
            if(res && res.status) {
                res.data.enabled ? tr.removeAttr('disabled') : tr.attr('disabled', 'true');
                tr.find('.prize').toggleClass('disabled');
            }
            if (res.data.tips !== undefined) {
                 tr.find('.invalid').text(res.data.tips);
            }        
        })
    }
    
    api.editPrize = function(e) {
       const id = e ? e.data('id') : 0;
       const type = e ? e.data('type') : '';
       if(id && api[type]) {
           api[type](id);
       }
    }

    api.newPrize = function(e){
       const type = e ? e.data('type') : '';
       if(type && api[type]) {
           api[type]();
       }
    }
    
    function savePrize($type) {
        let passed = true;
         $('form#addPrizeForm input[required]').each(function(){
             if($(this).val().trim() === '') {
                passed = false;
                $(this).focus();
                return false;
             }
         })
         
        if (passed) {
            const data = $('form#addPrizeForm').serialize();
            $.post("{php echo $this->createWebUrl('settings');}", {op: 'savePrize', type: $type, params: data}).then(function(res){
                if (res && res.data.msg) {
                    util.message(res.data.msg, "{php echo $this->createWebUrl('settings', array('op'=>'user'));}", res.status ? 'success':'error');
                }
            })
        }
    }
    
    $(function(){
        $('#special [data-url]').each(function(){
              util.clip(this, $(this).data('url'));
        })
        $('#prizes,#prizelist').on('click', '[data-op]', function(){
            const self = $(this);
            const op = self.data('op');
            if(api[op]) {
                api[op](self);
            }
        })
        
        $('#special input[name=usercenter]').click(function(){
            const checked = $(this).is(':checked');
            $('#special fieldset').attr('disabled', !checked);
            if (checked) {
                $('#special2').show();
            }else{
                $('#special2').hide();
            }
        })
        
        $('#special2 input[name=userprize]').click(function(){
            $('#special2 fieldset').attr('disabled', !$(this).is(':checked'));
        })
        
        $('#special2').on('click', 'fieldset:not(:disabled) #prizelist .operate i.fa-trash-o', function(){
            if(confirm('确定要删除这个奖品吗？')) {
                const tr = $(this).closest('tr');
                const id = tr.data('id');
                $.getJSON("{php echo $this->createWebUrl('settings');}", {op: 'removePrize', id: id}).then(function(res){
                    if (res && res.status) {
                        tr.fadeOut('normal', function(){tr.remove();});
                    }
                })
            }
        })
    })
</script>
{template 'common/footer'}