{template 'common/header'}
{php \zovye\url(true, 'static/css/common.css?v=20201108');}
<ul class="nav nav-tabs" id="navbar">
    <li role="presentation" class="active"><a href="#">{$title}</a></li>
</ul>
<div class="panel panel-default panel-first">
    <div class="heading">
        <span class="operate">
            <i class="fa fa fa-sign-out" title="出库" data-op='chooseGoods'></i>
            <i class="fa fa fa-sign-in" title="入库"></i>
        </span>
    </div>
    <div class="panel-body">

    </div>
</div>
<script>
    const api = {
        url: "{php echo $this->createWebUrl('goods');}",
        dlg: null,
    }

    api.showResult = function(params, url, loading, cb) {
        loading && util.loading();
        $.getJSON(url || api.url, params).done(function(res){
            loading && util.loaded();
            if (res) {
                if (typeof cb == 'function') {
                    if(cb(res)) {
                        return;
                    }
                }
                if (res.status) {
                    if (res.data && res.data.content) {
                        api.dlg = util.dialog(res.data.title || '', res.data.content);
                        api.dlg.modal('show');
                    }
                }
                if (res.message && res.type) {
                    util.message(res.message, '', res.type);
                }
                if (res.data && res.data.msg) {
                    util.message(res.data.msg, '', res.status ? 'success' : 'error');
                }
            }
        }).fail(function(){
            loading && util.loaded();
        })
    }
    
    api.hide = function () {
        if (api.dlg) {
            api.dlg.modal('hide');
        }
    }

    api.chooseGoods = function() {
        api.showResult({op: 'goods', pagesize: 10});
    }

    $(function() {
        $("body").on("click", "[data-op]", function (e) {
            e.preventDefault();
            const op = $(this).data('op');
            if (op && api[op]) {
                api[op](e);
            }
        })
    })
</script>
<script>
    let backer = "";
    let agentId = "";
    $(function(){
        function reload(url) {
            api.showResult({}, url);
        }
        
        $('body').on('click', '#search-bar', function () {
            $(this).hide();
            $('#search-form').show();
            $('input[name=s_keywords]').focus();
        })

        $('body').on('click', '#search-form .btn-close', function (e) {
            if (backer) {
                api.chooseGoods();
            } else {
                $('#search-form').hide();
                $('#search-bar').show();
            }       
            e.preventDefault();     
         })

        $('body').on('click', '#search_agent', function () {
            const keyword = $('#search-form input[name=keyword_agent]').val();console.log(keyword);
            $.get("{php echo $this->createWebUrl('agent', array('id'=>$id));}", {
                op: 'search',
                keyword: keyword,
            }, function (res) {
                let html = '';
                if (res.status) {
                    const list = res.data || [];
                    list.forEach(function (e) {
                        html += '<option value="_1*" _4*>_2*，手机号码：_3*</option>'
                            .replace('_1*', e.id)
                            .replace('_2*', e.name)
                            .replace('_3*', e.mobile)
                            .replace('_4*', '');
                    })
                }

                html += '<option value=""><不限></option><option value="-1"><平台></option>';
                $('#agent_search_result').html(html);

            }, 'json');
        })

        function reloadPageWithFilter(fn) {
            const params = new URLSearchParams();

            const form = $("#search-form form");
            const s_keywords = $.trim(form.find('input[name=s_keywords]').val());
            if (s_keywords) {
                params.append("keywords", s_keywords);
            }
            const agentId = $.trim(form.find('select[name=agentId]').val());
            if (agentId != '') {
                params.append("agentId", agentId);
            }
            if (typeof fn === 'function') {
                fn(params);
            }

            params.append("pagesize", 10);
            
            reload(form.attr("action") + "&" + encodeURI(params.toString()));
        }

        $('body').on('submit', "#search-form form", function(e){
            reloadPageWithFilter();            
            e.preventDefault();
        })

        $('body').on('click', 'a[filter]', function (e) {
            const self = this;
            reloadPageWithFilter(function (params) {
                const name = $(self).data('name');
                const val = $(self).data('val');
                if (name) {
                    params.set(name, val);
                }
            });
            e.preventDefault();
        })

        $('body').on('click', '.pagination li:not(.active) a', function (e) {
            e.preventDefault();
            const url = $(this).attr("href");
            reload(url);
        })
    })
</script>
{template 'common/footer'}